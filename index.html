<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>싸U 주문서</title>

<style>
  body{
    margin:0; padding:16px;
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    background:#fff; color:#111;
  }
  h1{ text-align:center; font-size:20px; margin:0 0 12px; color:#005FAE; }

  /* ✅ 완료 배너 */
  .mode-banner{
    display:none;
    text-align:center;
    padding:10px 12px;
    border-radius:10px;
    font-weight:900;
    margin:0 auto 14px;
    max-width:560px;
    outline:none;
  }
  body.mode-complete .mode-banner{
    display:block;
    background:#e8f2ff;
    border:1px solid #c8ddff;
    color:#005FAE;
  }

  /* ✅ 완료 화면: 배너만 보이게(제목 숨김) */
  body.mode-complete h1{ display:none; }

  .section{ margin-bottom:28px; }
  .section-title{ font-size:15px; font-weight:800; margin-bottom:10px; color:#005FAE; }
  .divider{ border-top:1px solid #eee; margin:12px 0 16px; }

  .field{ margin-bottom:12px; }
  label{ display:block; font-size:13px; margin-bottom:4px; }

  input{
    width:100%;
    padding:12px;
    font-size:15px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
  }
  input::placeholder{ color:#999; }

  .address-row{ display:flex; gap:8px; }
  .address-row input{ flex:1; }
  .addr-btn{
    background:#005FAE; color:#fff; font-weight:900;
    border:none; border-radius:6px;
    padding:12px 14px; cursor:pointer; white-space:nowrap;
  }

  /* ✅ 배송지 요약(완료 화면에서 표시) */
  #shipSummary{
    display:none;
    background:#f7f7f7;
    border:1px solid #e5e5e5;
    border-radius:10px;
    padding:12px;
    font-size:14px;
    line-height:1.55;
  }
  body.mode-complete #shipSummary{ display:block; }

  /* 완료화면에서는 기본적으로 고객정보 입력폼 숨김(배송지 수정 눌렀을 때만 펼침) */
  body.mode-complete #customerFormFields{ display:none; }

  /* ✅ 완료화면 배송지 수정 버튼 영역 */
  .ship-actions{
    display:none;
    gap:8px;
    margin-top:10px;
  }
  body.mode-complete .ship-actions{ display:flex; }
  .btn-mini{
    padding:10px 10px;
    font-size:13px;
    font-weight:900;
    border-radius:10px;
    border:none;
    cursor:pointer;
  }
  .btn-gray{ background:#e0e0e0; color:#111; }
  .btn-blue{ background:#005FAE; color:#fff; }
  .btn-red{ background:#e74c3c; color:#fff; }

  .product{
    border-top:1px solid #eee;
    padding-top:12px;
    margin-top:12px;
  }

  .row{ display:flex; gap:8px; }
  .row .field{ flex:1; }

  button{
    padding:12px 14px;
    font-size:14px;
    font-weight:900;
    border-radius:8px;
    border:none;
    cursor:pointer;
  }

  .button-line-3{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:12px;
  }
  .button-line-3 button{
    flex:0 0 calc((100% - 16px)/3);
    max-width:calc((100% - 16px)/3);
    white-space:nowrap;
  }
  .button-line-2{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:10px;
  }
  .button-line-2 button{
    flex:0 0 calc((100% - 8px)/2);
    max-width:calc((100% - 8px)/2);
    white-space:nowrap;
  }

  /* ✅ 작성 화면 버튼 */
  .btn-check{ background:#E0E0E0; color:#333; }
  .btn-order{ background:#005FAE; color:#fff; }
  .btn-add{ background:#005FAE; color:#fff; }
  .btn-delete{ background:#e74c3c; color:#fff; }

  /* ✅ 완료 화면 메인 3버튼 */
  .btn-edit-go{
    background:#fff7e6;
    color:#9a6b00;
    border:1px solid #ffe1a6;
    font-weight:900;
  }
  .btn-cancel-do{
    background:#fff;
    color:#e74c3c;
    border:1px solid #e74c3c;
    font-weight:900;
  }
  .btn-add-order{ background:#005FAE; color:#fff; font-weight:900; }

  /* ✅ 입금계좌 */
  .account-box{
    display:flex;
    align-items:center;
    background:#f4f7ff;
    border:1px solid #d6e0ff;
    border-radius:8px;
    padding:10px;
    gap:8px;
  }
  .account-text{ font-size:14px; white-space:nowrap; flex:1; }
  .copy-btn{
    background:#005FAE;
    color:#fff;
    font-size:12px;
    font-weight:900;
    padding:6px 10px;
    border-radius:6px;
    border:none;
  }

  /* ✅ 상태 배지 */
  .product-title-row{ display:flex; align-items:center; gap:8px; }
  .product-title-row input{ flex:1; }

  .status-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:900;
    padding:6px 10px;
    border-radius:6px;
    white-space:nowrap;
    user-select:none;
  }
  .status-badge .sq{ width:10px; height:10px; border-radius:2px; display:inline-block; }

  .status-sent{ background:#e8f2ff; color:#005FAE; border:1px solid #c8ddff; }
  .status-sent .sq{ background:#005FAE; }

  .status-modified{ background:#fff7e6; color:#9a6b00; border:1px solid #ffe1a6; } /* ✅ 수정완료 색=수정하기 버튼 색 */
  .status-modified .sq{ background:#9a6b00; }

  .status-canceled{ background:#ededed; color:#222; border:1px solid #cfcfcf; }
  .status-canceled .sq{ background:#111; }

  .status-cancel-pick{ background:#ffe9e9; color:#c0392b; border:1px solid #ffc9c9; }
  .status-cancel-pick .sq{ background:#e74c3c; }

  /* ✅ 요약 박스(폼/완료 둘 다 사용) */
  #doneSummary{
    display:none;
    font-size:13px;
    color:#333;
    background:#f7f9ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    padding:10px;
    margin:6px 0 10px;
    line-height:1.55;
  }
  body.mode-form #doneSummary{ display:block; }
  body.mode-complete #doneSummary{ display:block; }

  /* ✅ 폼 화면에서는 완료 카드 숨김(요약만) */
  body.mode-form .product[data-status="sent"],
  body.mode-form .product[data-status="modified"],
  body.mode-form .product[data-status="canceled"]{
    display:none !important;
  }

  /* ✅ 완료 화면: 완료목록 접기/펼치기 버튼(완료 화면에서만) */
  .small-link-btn{
    display:none;
    width:100%;
    margin-top:10px;
    padding:10px 12px;
    background:#f4f7ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    color:#333;
    font-size:14px;
    font-weight:900;
    text-align:center;
    cursor:pointer;
  }
  body.mode-complete .small-link-btn{ display:block; }

  /* ✅ 완료 화면: 취소 선택 체크 */
  .cancel-pick-row{
    display:none;
    margin-top:10px;
    padding:10px;
    border:1px dashed #eee;
    border-radius:10px;
    background:#fff;
    font-size:13px;
  }
  body.mode-complete .cancel-pick-row{
    display:flex;
    align-items:center;
    gap:8px;
    justify-content:flex-end;
  }
  .cancel-pick-row label{
    margin:0;
    font-size:13px;
    font-weight:900;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .cancel-pick-row input{ width:auto; padding:0; }

  /* ✅ 완료 화면: 개별 수정 버튼 영역(완료목록 펼쳤을 때만 보여줄 예정) */
  .edit-row{
    display:none;
    margin-top:10px;
    gap:8px;
    justify-content:flex-end;
  }
  .edit-row button{
    padding:10px 12px;
    font-size:13px;
    border-radius:10px;
  }

  /* ✅ 잠금 회색 처리 */
  .product.is-locked input{
    background:#f2f2f2 !important;
    color:#777 !important;
    border-color:#ddd !important;
  }
  .product.is-locked input::placeholder{ color:#aaa !important; }
  .product.is-locked input:disabled{
    background:#f2f2f2 !important;
    color:#777 !important;
    -webkit-text-fill-color:#777 !important;
    opacity:1 !important;
  }

  /* ✅ 금액 요약(완료화면에서도 반드시 표시되게!) */
  .summary{ border-top:1px solid #eee; padding-top:14px; }
  .summary-line{ display:flex; justify-content:space-between; font-size:14px; margin:6px 0; }
  .summary-total{ font-weight:900; font-size:16px; color:#005FAE; }

  /* ✅ 상품추가/삭제(폼에서만) */
  body.mode-complete .form-product-controls{ display:none !important; }
</style>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="mode-form">
<h1>싸U 주문서</h1>

<div class="mode-banner" id="modeBanner" tabindex="-1">주문이 완료되었습니다.</div>

<div class="section">
  <div class="section-title">고객 정보</div>
  <div class="divider"></div>

  <!-- ✅ 완료 화면 배송지 요약 -->
  <div id="shipSummary"></div>

  <!-- ✅ 완료 화면 배송지 수정 버튼 -->
  <div class="ship-actions" id="shipActions" style="display:none;">
    <button class="btn-mini btn-gray" type="button" onclick="enterShipEdit()">배송지 수정</button>
  </div>

  <!-- ✅ 배송지 수정 폼(완료화면에서만 열림) -->
  <div id="customerFormFields">
    <div class="field">
      <label>닉네임</label>
      <input id="nickname" placeholder="예) GO비욘드">
    </div>
    <div class="field">
      <label>이름</label>
      <input id="name" placeholder="예) 홍길동">
    </div>
    <div class="field">
      <label>연락처</label>
      <input id="phone" placeholder="예) 010-1234-5678">
    </div>
    <div class="field">
      <label>주소</label>
      <div class="address-row">
        <input id="address" placeholder="주소검색 버튼을 눌러주세요" readonly>
        <button class="addr-btn" type="button" onclick="searchAddress()">주소검색</button>
      </div>
    </div>
    <div class="field">
      <label>상세주소</label>
      <input id="addressDetail" placeholder="예) 101동 1203호">
    </div>

    <!-- ✅ 완료화면에서 배송지 저장/취소 -->
    <div class="button-line-2" id="shipEditControls" style="display:none;">
      <button class="btn-blue" type="button" onclick="saveShipEdit()">배송지 저장</button>
      <button class="btn-mini btn-gray" type="button" onclick="cancelShipEdit()">취소</button>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title">상품 정보</div>

  <!-- ✅ 완료/취소 요약(수량/가격 포함) -->
  <div id="doneSummary"></div>

  <!-- ✅ 상세 카드 리스트 -->
  <div id="products"></div>

  <!-- ✅ 완료화면에서만: 완료목록 접기/펼치기 -->
  <button class="small-link-btn" type="button" onclick="toggleFold()">완료목록 접기 ▲</button>

  <!-- ✅ 폼에서만: 상품추가/삭제 -->
  <div class="form-product-controls">
    <div class="button-line-2">
      <button class="btn-add" type="button" onclick="addProduct()">+ 상품 추가</button>
      <button class="btn-delete" type="button" onclick="removeLastProduct()">- 상품 삭제</button>
    </div>
  </div>
</div>

<!-- ✅ 합계/배송비/총액: 완료화면에서도 반드시 보여야 함 -->
<div class="section summary" id="summarySection">
  <div class="summary-line"><span>상품 합계</span><span id="sum">0원</span></div>
  <div class="summary-line"><span>배송비</span><span id="shipping">4,000원</span></div>
  <div class="summary-line summary-total"><span>총 결제금액</span><span id="total">4,000원</span></div>
</div>

<div class="section">
  <div class="section-title">입금 계좌</div>
  <div class="account-box">
    <div class="account-text" id="accountText">카카오뱅크 3333-09797-1111 유혜정(유세연)</div>
    <button class="copy-btn" type="button" onclick="copyAccount()">복사</button>
  </div>
</div>

<!-- ✅ 폼 화면 버튼(미리보기는 여기만) -->
<div class="button-line-3" id="formControls">
  <button class="btn-check" type="button" onclick="checkOrder()">미리 보기</button>
  <button class="btn-order" type="button" onclick="submitOrder()">주문하기</button>
  <button class="btn-red" type="button" onclick="newOrder()">새 주문</button>
</div>

<!-- ✅ 완료 화면 메인 3버튼: 수정하기 / 취소하기 / 추가주문 -->
<div class="button-line-3" id="completeControls" style="display:none;">
  <button class="btn-edit-go" type="button" onclick="unfoldAndHint('edit')">수정하기</button>
  <button class="btn-cancel-do" type="button" onclick="submitCancel()">취소하기</button>
  <button class="btn-add-order" type="button" onclick="goToFormForAdd()">추가주문</button>
</div>

<!-- ✅ 완료 화면 보조 버튼(작게): 주문내역확인 / 새 주문(초기화) -->
<div class="button-line-2" id="completeMiniControls" style="display:none;">
  <button class="btn-mini btn-gray" type="button" onclick="showOrderHistory()">주문내역확인</button>
  <button class="btn-mini btn-red" type="button" onclick="newOrder()">새 주문</button>
</div>

<script>
  const SHIPPING = 4000;
  const productsDiv = document.getElementById("products");

  // ✅ 네 구글 Apps Script URL 그대로
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypKfZsjR0uu9Lcc7OirR2tiyjIzzLwREGd3Bw3szXmLVIHHNGhwlmoOdRaInh2xebf/exec";

  let IS_LOADING = false;

  // ✅ 완료목록 기본 접힘(완료화면 진입 시 true)
  let HIDE_DONE = false;

  // ✅ 주문ID
  let ORDER_ID = "";
  function newOrderId_(){
    return "oid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  // ✅ 모드
  let MODE = "form"; // form | complete

  // ✅ 배송지 수정 모드(완료화면 내부)
  let SHIP_EDITING = false;
  let SHIP_SNAPSHOT = null;

  function focusBanner(){
    const banner = document.getElementById("modeBanner");
    if (!banner) return;
    banner.scrollIntoView({ behavior:"smooth", block:"start" });
    setTimeout(()=>banner.focus(), 250);
  }

  function copyAccount(){
    const text = accountText.innerText;
    const accountNumberOnly = text.replace(/[^0-9]/g, "");
    navigator.clipboard.writeText(accountNumberOnly);
    alert("계좌번호만 복사되었습니다.");
  }

  function searchAddress(){
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById("address").value = data.address;
        document.getElementById("addressDetail").focus();
        saveData();
      }
    }).open();
  }

  function _uid(){
    return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  function _fmtMoney_(v){
    const n = Number(v || 0);
    return n.toLocaleString() + "원";
  }

  function snapshotCustomer(){
    return {
      nickname: document.getElementById("nickname").value || "",
      name: document.getElementById("name").value || "",
      phone: document.getElementById("phone").value || "",
      address: document.getElementById("address").value || "",
      addressDetail: document.getElementById("addressDetail").value || ""
    };
  }

  function renderShippingSummary(){
    const box = document.getElementById("shipSummary");
    if (!box) return;

    const c = snapshotCustomer();
    const fullAddr = `${(c.address||"").trim()} ${(c.addressDetail||"").trim()}`.trim();

    box.innerHTML = `
      <div style="font-weight:900; margin-bottom:6px;">배송지 요약</div>
      <div>닉네임: <b>${(c.nickname||"-")}</b></div>
      <div>수령인: <b>${(c.name||"-")}</b></div>
      <div>연락처: <b>${(c.phone||"-")}</b></div>
      <div style="margin-top:6px;">주소: <b>${fullAddr || "-"}</b></div>
    `;
  }

  function lockProductInputs(div, lock){
    const inputs = div.querySelectorAll("input");
    // 0~4: 상품 입력
    for (let k=0;k<5;k++){
      if (!inputs[k]) continue;
      inputs[k].readOnly = lock;
      inputs[k].disabled = lock;
    }
    if (lock) div.classList.add("is-locked");
    else div.classList.remove("is-locked");
  }

  function setMode(mode, bannerText, opts){
    MODE = mode;
    opts = opts || {};

    document.body.classList.remove("mode-form","mode-complete");
    document.body.classList.add("mode-" + MODE);

    const formControls = document.getElementById("formControls");
    const completeControls = document.getElementById("completeControls");
    const completeMiniControls = document.getElementById("completeMiniControls");
    const shipActions = document.getElementById("shipActions");

    if (MODE === "complete"){
      formControls.style.display = "none";
      completeControls.style.display = "flex";
      completeMiniControls.style.display = "flex";
      shipActions.style.display = "flex";

      const banner = document.getElementById("modeBanner");
      banner.innerText = bannerText || "주문이 완료되었습니다.";

      // ✅ 완료화면 진입 시 기본 접힘
      if (opts.foldOnEnter === true) HIDE_DONE = true;

      // ✅ 배송지 수정 모드 종료
      exitShipEdit(true);

      renderShippingSummary();
      renderDoneSummary();

      // ✅ 완료화면 기본: 카드 잠금
      document.querySelectorAll(".product").forEach(p=>{
        lockProductInputs(p, true);
        setBadge(p);
      });

      applyFoldVisibilityComplete();

      calc(); // ✅ 완료화면 합계/배송비/총액 갱신
      saveData();
      setTimeout(focusBanner, 50);
      return;
    }

    // MODE === form
    formControls.style.display = "flex";
    completeControls.style.display = "none";
    completeMiniControls.style.display = "none";
    shipActions.style.display = "none";

    exitShipEdit(true);

    renderDoneSummary();
    document.querySelectorAll(".product").forEach(p=>{
      lockProductInputs(p, false);
      setBadge(p);
    });

    calc();
    saveData();
  }

  /* =========================
     ✅ 완료목록 접기/펼치기(완료화면만)
     ========================= */
  function applyFoldVisibilityComplete(){
    if (MODE !== "complete") return;

    const btn = document.querySelector('button[onclick="toggleFold()"]');
    if (btn) btn.innerText = HIDE_DONE ? "완료목록 펼치기 ▼" : "완료목록 접기 ▲";

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      const isDoneCard = (st === "sent" || st === "modified" || st === "canceled" || st === "cancel_pending");

      // 완료화면에서만 접기 적용
      if (isDoneCard){
        p.style.display = HIDE_DONE ? "none" : "";
      } else {
        p.style.display = "";
      }

      // 펼쳐졌을 때만: 개별 수정 버튼 노출(취소완료 제외)
      const editRow = p.querySelector(".edit-row");
      if (editRow){
        const canEdit = (MODE==="complete" && !HIDE_DONE && (st==="sent" || st==="modified") && !p.dataset.editing && !SHIP_EDITING);
        editRow.style.display = canEdit ? "flex" : "none";
      }

      // 펼쳐졌을 때만 취소 체크 접근 가능(원래 의도대로)
      const cancelRow = p.querySelector(".cancel-pick-row");
      if (cancelRow){
        cancelRow.style.display = (MODE==="complete" && !HIDE_DONE && (st==="sent" || st==="modified" || st==="cancel_pending")) ? "flex" : "none";
      }
    });

    saveData();
  }

  function toggleFold(){
    if (MODE !== "complete") return;
    HIDE_DONE = !HIDE_DONE;
    applyFoldVisibilityComplete();
    saveData();
  }

  /* ✅ 완료화면에서 수정하기 버튼 눌렀을 때: 접기 풀고 배너로 시선 */
  function unfoldAndHint(type){
    if (MODE !== "complete") return;

    if (HIDE_DONE){
      HIDE_DONE = false;
      applyFoldVisibilityComplete();
    }
    if (type === "edit"){
      document.getElementById("modeBanner").innerText = "수정할 상품의 '수정하기' 버튼을 눌러주세요.";
    } else {
      document.getElementById("modeBanner").innerText = "취소할 상품을 선택 후 '취소하기'를 눌러주세요.";
    }
    focusBanner();
    saveData();
  }

  /* =========================
     ✅ 상태 배지
     ========================= */
  function setBadge(div){
    const st = div.dataset.status || "draft";
    const badge = div.querySelector(".status-badge");
    if (!badge) return;

    badge.style.display = "inline-flex";
    badge.className = "status-badge";

    if (st === "canceled"){
      badge.classList.add("status-canceled");
      badge.innerHTML = `<span class="sq"></span>취소완료`;
      return;
    }
    if (st === "cancel_pending"){
      badge.classList.add("status-cancel-pick");
      badge.innerHTML = `<span class="sq"></span>취소선택`;
      return;
    }
    if (st === "modified"){
      badge.classList.add("status-modified");
      badge.innerHTML = `<span class="sq"></span>수정완료`;
      return;
    }
    if (st === "sent"){
      badge.classList.add("status-sent");
      badge.innerHTML = `<span class="sq"></span>주문완료`;
      return;
    }

    // draft는 뱃지 숨김(작성중)
    badge.style.display = "none";
  }

  function snapshotOfProduct(div){
    const i = div.querySelectorAll("input");
    return {
      name: i[0]?.value || "",
      color: i[1]?.value || "",
      size: i[2]?.value || "",
      qty: i[3]?.value || "",
      price: i[4]?.value || ""
    };
  }

  /* =========================
     ✅ 요약(수량/가격 포함)
     ========================= */
  function renderDoneSummary(){
    const box = document.getElementById("doneSummary");
    if (!box) return;

    const lines = [];

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified" || st === "canceled")) return;

      const i = p.querySelectorAll("input");
      const name = (i[0]?.value || "").trim();
      const color = (i[1]?.value || "").trim();
      const size = (i[2]?.value || "").trim();
      const qty = Number((i[3]?.value || "").trim() || 0);
      const price = Number((i[4]?.value || "").trim() || 0);

      const qtyText = qty ? `${qty}개` : "0개";
      const priceText = price ? _fmtMoney_(price) : "0원";

      if (st === "canceled") {
        lines.push(`• <b>[취소완료]</b> ${name} / ${color} / ${size} / ${qtyText} / ${priceText}`);
      } else if (st === "modified") {
        lines.push(`• <b>[수정완료]</b> ${name} / ${color} / ${size} / ${qtyText} / ${priceText}`);
      } else {
        lines.push(`• <b>[주문완료]</b> ${name} / ${color} / ${size} / ${qtyText} / ${priceText}`);
      }
    });

    if (lines.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    box.style.display = "block";
    box.innerHTML = lines.join("<br>");
  }

  /* =========================
     ✅ 합계 계산(완료화면에서도 보이게!)
     - sent/modified: 포함
     - cancel_pending: 선택된 상품만큼 마이너스 반영
     ========================= */
  function calc(){
    let sum = 0;

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      const i = p.querySelectorAll("input");
      const qty = Number((i[3]?.value || "").trim() || 0);
      const price = Number((i[4]?.value || "").trim() || 0);
      const amt = qty * price;

      if (MODE === "complete"){
        if (st === "sent" || st === "modified") sum += amt;

        if (st === "cancel_pending"){
          // 취소선택은 원래금액을 뺌(snapshot 기준)
          const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : snapshotOfProduct(p);
          const q = Number(snap.qty || 0);
          const pr = Number(snap.price || 0);
          sum -= (q * pr);
        }
        return;
      }

      // 폼에서는 draft만 합산(새 주문 작성)
      if (st === "draft") sum += amt;
    });

    const shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

    document.getElementById("sum").innerText = sum.toLocaleString() + "원";
    document.getElementById("shipping").innerText = shipping.toLocaleString() + "원";
    document.getElementById("total").innerText = (sum + shipping).toLocaleString() + "원";
  }

  /* =========================
     ✅ 네트워크 전송 공통
     ========================= */
  async function sendPayload(payload){
    const body = JSON.stringify(payload);

    let sent = false;
    if (navigator.sendBeacon){
      const blob = new Blob([body], { type:"text/plain;charset=UTF-8" });
      sent = navigator.sendBeacon(SCRIPT_URL, blob);
    }
    if (!sent){
      await fetch(SCRIPT_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"text/plain;charset=UTF-8" },
        body,
        keepalive:true
      });
    }
  }

  function kstNowString(){
    const d = new Date(Date.now() + 9 * 60 * 60 * 1000);
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(d.getUTCDate()).padStart(2, "0");
    const hh = String(d.getUTCHours()).padStart(2, "0");
    const mi = String(d.getUTCMinutes()).padStart(2, "0");
    const ss = String(d.getUTCSeconds()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  /* =========================
     ✅ 상품 카드 생성
     - 완료화면에서: 취소 체크 + 개별 수정 버튼
     ========================= */
  function addProduct(preset){
    const div = document.createElement("div");
    div.className = "product";

    div.dataset.id = (preset && preset.id) ? preset.id : _uid();
    div.dataset.status = (preset && preset.status) ? preset.status : "draft";
    if (preset && preset.snapshot) div.dataset.snapshot = preset.snapshot;

    div.innerHTML = `
      <div class="field">
        <label>상품명</label>
        <div class="product-title-row">
          <input class="product-name" placeholder="예) 아미 맨투맨 / 폴로 꽈배기 니트 / 메종 후드티 / 꼼데 긴팔티 / 알로 셋업">
          <div class="status-badge status-sent"><span class="sq"></span>주문완료</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>색상</label>
          <input placeholder="예) 블랙 / 검정">
        </div>
        <div class="field">
          <label>사이즈</label>
          <input placeholder="예) L / 라지 / 100">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>수량</label>
          <input type="number" value="" placeholder="예) 1">
        </div>
        <div class="field">
          <label>가격</label>
          <input type="number" placeholder="예) 59000">
        </div>
      </div>

      <div class="edit-row">
        <button class="btn-mini btn-blue" type="button">수정하기</button>
      </div>

      <div class="edit-row" style="display:none;" data-edit-controls="1">
        <button class="btn-mini btn-blue" type="button">수정완료</button>
        <button class="btn-mini btn-gray" type="button">수정취소</button>
      </div>

      <div class="cancel-pick-row">
        <label><input type="checkbox" class="chk-cancel-pick"> 취소 선택</label>
      </div>
    `;

    const inputs = div.querySelectorAll("input");
    if (preset){
      inputs[0].value = preset.name || "";
      inputs[1].value = preset.color || "";
      inputs[2].value = preset.size || "";
      inputs[3].value = preset.qty != null ? preset.qty : "";
      inputs[4].value = preset.price != null ? preset.price : "";
    }

    // 폼 입력 이벤트(0~4)
    for (let k=0;k<5;k++){
      inputs[k].addEventListener("input", ()=>{
        if (MODE !== "form") return;
        calc();
        saveData();
      });
    }

    // ✅ 취소 체크박스
    const chk = div.querySelector(".chk-cancel-pick");
    chk.addEventListener("change", ()=>{
      if (MODE !== "complete") return;
      if (HIDE_DONE) { chk.checked = false; alert("먼저 완료목록을 펼쳐주세요."); return; }
      if (div.dataset.editing === "1") { chk.checked = false; alert("수정 중에는 취소 선택을 할 수 없습니다."); return; }
      if (SHIP_EDITING) { chk.checked = false; alert("배송지 수정 중에는 취소 선택을 할 수 없습니다."); return; }

      const st = div.dataset.status || "draft";

      if (chk.checked){
        if (!(st === "sent" || st === "modified")) { chk.checked = false; return; }
        // ✅ 취소선택 시 원금액 snapshot 저장(정확한 차감)
        if (!div.dataset.snapshot){
          div.dataset.snapshot = JSON.stringify(snapshotOfProduct(div));
        }
        div.dataset.status = "cancel_pending";
      } else {
        if (st !== "cancel_pending") return;
        // 취소선택 해제 → 원상복구
        div.dataset.status = "sent"; // 원래가 modified였어도, 취소선택 해제는 '정상 완료 상태'로 복귀
        // 수정완료였던 상품이면 modified로 돌려주는 게 자연스럽다:
        // snapshot이 있었으면 그 전 상태를 저장해둘 수도 있지만, 간단히 "modified 유지"를 위해 아래 처리:
        // - snapshot이 없으면 modified로 유지 불가
        // - 여기선 "modified 상품도 취소선택 해제 시 modified로 유지"를 위해 dataset.prevDoneStatus 사용
      }

      setBadge(div);
      renderDoneSummary();
      calc();
      saveData();
    });

    // ✅ 개별 수정 버튼 (완료화면 펼쳤을 때만 보이게)
    const editBtn = div.querySelectorAll(".edit-row button")[0]; // 첫 edit-row의 "수정하기"
    const editControlsRow = div.querySelector('[data-edit-controls="1"]');
    const editDoneBtn = editControlsRow.querySelectorAll("button")[0];
    const editCancelBtn = editControlsRow.querySelectorAll("button")[1];

    editBtn.onclick = () => {
      if (MODE !== "complete") return;
      if (HIDE_DONE) { alert("먼저 완료목록을 펼쳐주세요."); return; }
      if (SHIP_EDITING) { alert("배송지 수정 중에는 상품 수정이 불가합니다."); return; }

      const st = div.dataset.status || "draft";
      if (!(st === "sent" || st === "modified")) return;

      // 취소선택 중이면 먼저 해제
      const chk2 = div.querySelector(".chk-cancel-pick");
      if (chk2 && chk2.checked){
        alert("취소 선택을 해제한 후 수정해주세요.");
        return;
      }

      // snapshot 저장(차액 계산용)
      div.dataset.snapshot = JSON.stringify(snapshotOfProduct(div));
      div.dataset.editing = "1";

      lockProductInputs(div, false);
      div.classList.remove("is-locked");

      // 버튼 토글
      editBtn.parentElement.style.display = "none";
      editControlsRow.style.display = "flex";

      // 취소 체크 비활성
      if (chk2) chk2.disabled = true;

      focusBanner();
      saveData();
    };

    editCancelBtn.onclick = () => {
      // snapshot으로 되돌리고 잠금
      const snap = div.dataset.snapshot ? JSON.parse(div.dataset.snapshot) : null;
      if (snap){
        inputs[0].value = snap.name || "";
        inputs[1].value = snap.color || "";
        inputs[2].value = snap.size || "";
        inputs[3].value = snap.qty || "";
        inputs[4].value = snap.price || "";
      }

      delete div.dataset.editing;
      // snapshot은 취소니까 삭제
      delete div.dataset.snapshot;

      lockProductInputs(div, true);

      editControlsRow.style.display = "none";
      editBtn.parentElement.style.display = "flex";

      const chk2 = div.querySelector(".chk-cancel-pick");
      if (chk2) chk2.disabled = false;

      setBadge(div);
      renderDoneSummary();
      calc();
      saveData();

      document.getElementById("modeBanner").innerText = "수정이 취소되었습니다.";
      focusBanner();
    };

    editDoneBtn.onclick = async () => {
      if (MODE !== "complete") return;

      // 유효성 검사
      const pName = (inputs[0].value || "").trim();
      const pColor = (inputs[1].value || "").trim();
      const pSize = (inputs[2].value || "").trim();
      const pQty = Number((inputs[3].value || "").trim() || 0);
      const pPrice = Number((inputs[4].value || "").trim() || 0);

      if (!pName) { alert("상품명을 입력해주세요."); inputs[0].focus(); return; }
      if (!pColor) { alert("색상을 입력해주세요."); inputs[1].focus(); return; }
      if (!pSize) { alert("사이즈를 입력해주세요."); inputs[2].focus(); return; }
      if (!pQty || pQty <= 0) { alert("수량을 입력해주세요."); inputs[3].focus(); return; }
      if (!pPrice || pPrice <= 0) { alert("가격을 입력해주세요."); inputs[4].focus(); return; }

      if (!confirm("수정을 완료하고 전송할까요?")) return;

      const snap = div.dataset.snapshot ? JSON.parse(div.dataset.snapshot) : { qty:0, price:0 };
      const oldAmt = Number(snap.qty || 0) * Number(snap.price || 0);
      const newAmt = pQty * pPrice;
      const delta = newAmt - oldAmt;

      const payload = {
        orderId: ORDER_ID || newOrderId_(),
        orderTime: kstNowString(),
        eventType: "modify_item",
        customer: {
          nickname: document.getElementById("nickname").value || "",
          name: document.getElementById("name").value || "",
          phone: document.getElementById("phone").value || "",
          address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
        },
        items: [{
          productName: `[수정] ${pName}`.trim(),
          color: pColor,
          size: pSize,
          qty: pQty,
          price: pPrice,
          amountDelta: delta,
          statusLabel: "수정완료"
        }],
        sum: delta,
        shipping: 0,
        total: delta
      };

      try{
        await sendPayload(payload);

        // ✅ 수정완료 처리
        div.dataset.status = "modified";
        delete div.dataset.editing;
        delete div.dataset.snapshot;

        lockProductInputs(div, true);

        editControlsRow.style.display = "none";
        editBtn.parentElement.style.display = "flex";

        const chk2 = div.querySelector(".chk-cancel-pick");
        if (chk2) { chk2.disabled = false; chk2.checked = false; }

        setBadge(div);
        renderDoneSummary();
        calc();
        saveData();

        document.getElementById("modeBanner").innerText = "수정이 완료되었습니다.";
        focusBanner();
      } catch(e){
        alert("전송에 실패했습니다. 네트워크 상태를 확인하고 다시 시도해주세요.");
      }
    };

    productsDiv.appendChild(div);

    // 초기 UI
    setBadge(div);
    lockProductInputs(div, MODE === "complete");
    calc();
    renderDoneSummary();

    if (!IS_LOADING) saveData();
    return div;
  }

  function removeLastProduct(){
    if (MODE !== "form") return;

    const items = Array.from(document.querySelectorAll(".product"));
    for (let idx = items.length - 1; idx >= 0; idx--){
      const st = items[idx].dataset.status || "draft";
      if (st === "draft"){
        items[idx].remove();
        break;
      }
    }
    if (!document.querySelector(".product")) addProduct();

    calc();
    saveData();
    renderDoneSummary();
  }

  /* =========================
     ✅ 미리보기(폼에서만)
     ========================= */
  function checkOrder(){
    let text = "[고객 정보]\n";
    text += `닉네임: ${document.getElementById("nickname").value}\n`;
    text += `이름: ${document.getElementById("name").value}\n`;
    text += `연락처: ${document.getElementById("phone").value}\n`;
    text += `주소: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[작성 중 상품]\n";
    const targets = Array.from(document.querySelectorAll(".product")).filter(p => (p.dataset.status === "draft"));
    if (targets.length === 0){
      text += "(작성 중인 상품이 없습니다.)\n";
    } else {
      targets.forEach((p, idx)=>{
        const i = p.querySelectorAll("input");
        text += `${idx+1}. ${i[0].value} / ${i[1].value} / ${i[2].value} / ${i[3].value}개 / ${_fmtMoney_(i[4].value)}\n`;
      });
    }

    text += `\n상품합계: ${document.getElementById("sum").innerText}\n`;
    text += `배송비: ${document.getElementById("shipping").innerText}\n`;
    text += `총 결제금액: ${document.getElementById("total").innerText}\n`;

    alert(text);
  }

  function showOrderHistory(){
    let text = "[배송지 정보]\n";
    text += `닉네임: ${document.getElementById("nickname").value}\n`;
    text += `이름: ${document.getElementById("name").value}\n`;
    text += `연락처: ${document.getElementById("phone").value}\n`;
    text += `주소: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[완료 상품]\n";
    const items = Array.from(document.querySelectorAll(".product")).filter(p=>{
      const st = p.dataset.status || "draft";
      return (st === "sent" || st === "modified" || st === "canceled");
    });

    if (items.length === 0){
      text += "(완료된 상품이 없습니다.)\n";
    } else {
      items.forEach((p, idx)=>{
        const st = p.dataset.status;
        const i = p.querySelectorAll("input");
        const qty = Number(i[3].value || 0);
        const price = Number(i[4].value || 0);

        const prefix =
          (st === "canceled") ? "[취소완료] " :
          (st === "modified") ? "[수정완료] " :
          "[주문완료] ";

        text += `${idx+1}. ${prefix}${i[0].value} / ${i[1].value} / ${i[2].value} / ${qty}개 / ${price.toLocaleString()}원\n`;
      });
    }

    text += `\n총 결제금액(현재 표시): ${document.getElementById("total").innerText}\n`;
    alert(text);
  }

  /* =========================
     ✅ 주문하기(폼 → 완료)
     ========================= */
  function _validateCustomer_(){
    const nickname = document.getElementById("nickname");
    const name = document.getElementById("name");
    const phone = document.getElementById("phone");
    const address = document.getElementById("address");
    const addressDetail = document.getElementById("addressDetail");

    if (!nickname.value.trim()) { alert("닉네임을 입력해주세요."); nickname.focus(); return false; }
    if (!name.value.trim()) { alert("이름을 입력해주세요."); name.focus(); return false; }
    if (!phone.value.trim()) { alert("연락처를 입력해주세요."); phone.focus(); return false; }
    if (!address.value.trim()) { alert("주소검색으로 주소를 입력해주세요."); return false; }
    if (!addressDetail.value.trim()) { alert("상세주소를 입력해주세요."); addressDetail.focus(); return false; }
    return true;
  }

  async function submitOrder(){
    if (MODE !== "form") return;
    if (!_validateCustomer_()) return;

    const targets = Array.from(document.querySelectorAll(".product")).filter(p => (p.dataset.status === "draft"));
    if (targets.length === 0){
      alert("작성 중인 상품이 없습니다.");
      return;
    }
    if (!confirm("주문을 완료하시겠습니까?")) return;

    // payload 만들기
    const items = [];
    let sum = 0;

    for (const p of targets){
      const i = p.querySelectorAll("input");
      const name = (i[0].value || "").trim();
      const color = (i[1].value || "").trim();
      const size = (i[2].value || "").trim();
      const qty = Number((i[3].value || "").trim() || 0);
      const price = Number((i[4].value || "").trim() || 0);

      if (!name) { alert("상품명을 입력해주세요."); i[0].focus(); return; }
      if (!color) { alert("색상을 입력해주세요."); i[1].focus(); return; }
      if (!size) { alert("사이즈를 입력해주세요."); i[2].focus(); return; }
      if (!qty || qty <= 0) { alert("수량을 입력해주세요."); i[3].focus(); return; }
      if (!price || price <= 0) { alert("가격을 입력해주세요."); i[4].focus(); return; }

      items.push({ productName:name, color, size, qty, price });
      sum += (qty * price);
    }

    const shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

    const payload = {
      orderId: ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      eventType: "order",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum,
      shipping,
      total: sum + shipping
    };

    try{
      await sendPayload(payload);

      // draft → sent
      targets.forEach(p=>{
        p.dataset.status = "sent";
        setBadge(p);
      });

      ORDER_ID = payload.orderId;

      // 완료화면 진입(기본 접힘)
      setMode("complete", "주문이 완료되었습니다.", { foldOnEnter:true });

      // 완료화면 합계 표시 갱신
      calc();
      renderDoneSummary();
      applyFoldVisibilityComplete();
      saveData();

      alert("완료되었습니다.");
    } catch(e){
      alert("전송에 실패했습니다. 네트워크 상태를 확인하고 다시 시도해주세요.");
    }
  }

  /* =========================
     ✅ 취소하기(완료화면)
     - 체크된(cancel_pending) 것만 전송 → canceled로 확정
     ========================= */
  async function submitCancel(){
    if (MODE !== "complete") return;

    if (HIDE_DONE){
      alert("취소하려면 먼저 '완료목록 펼치기'를 눌러주세요.");
      focusBanner();
      return;
    }

    if (SHIP_EDITING){
      alert("배송지 수정 중에는 취소를 진행할 수 없습니다.");
      return;
    }

    const editingAny = Array.from(document.querySelectorAll(".product")).some(p => p.dataset.editing === "1");
    if (editingAny){
      alert("상품 수정 중에는 취소를 진행할 수 없습니다.");
      return;
    }

    const targets = Array.from(document.querySelectorAll(".product")).filter(p => p.dataset.status === "cancel_pending");
    if (targets.length === 0){
      alert("취소할 상품을 선택해주세요.");
      focusBanner();
      return;
    }
    if (!confirm("선택한 상품을 취소하고 전송할까요?")) return;

    const items = [];
    let deltaSum = 0;

    targets.forEach(p=>{
      const i = p.querySelectorAll("input");
      const curName = (i[0].value || "").trim();
      const curColor = (i[1].value || "").trim();
      const curSize = (i[2].value || "").trim();

      const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : snapshotOfProduct(p);
      const oldAmt = Number(snap.qty || 0) * Number(snap.price || 0);
      const delta = -oldAmt;

      items.push({
        productName: `[취소] ${curName}`.trim(),
        color: curColor,
        size: curSize,
        qty: 0,
        price: 0,
        amountDelta: delta,
        statusLabel: "취소완료"
      });

      deltaSum += delta;
    });

    const payload = {
      orderId: ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      eventType: "cancel_items",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum: deltaSum,
      shipping: 0,
      total: deltaSum
    };

    try{
      await sendPayload(payload);

      // cancel_pending → canceled
      targets.forEach(p=>{
        p.dataset.status = "canceled";
        delete p.dataset.snapshot;

        const chk = p.querySelector(".chk-cancel-pick");
        if (chk) chk.checked = false;

        setBadge(p);
        lockProductInputs(p, true);
      });

      // 취소 후 다시 접힘(취소 유도 최소화)
      HIDE_DONE = true;
      applyFoldVisibilityComplete();

      document.getElementById("modeBanner").innerText = "취소가 완료되었습니다.";
      focusBanner();

      renderDoneSummary();
      calc();
      saveData();

      alert("취소가 완료되었습니다.");
    } catch(e){
      alert("전송에 실패했습니다. 네트워크 상태를 확인하고 다시 시도해주세요.");
    }
  }

  /* =========================
     ✅ 추가주문: 상품/배송지 유지 + 폼으로 이동 + 새 draft 1개 추가
     ========================= */
  function goToFormForAdd(){
    // 완료화면에서 취소선택/수정중이면 막기
    if (SHIP_EDITING){ alert("배송지 수정 중에는 추가주문을 진행할 수 없습니다."); return; }
    const editingAny = Array.from(document.querySelectorAll(".product")).some(p => p.dataset.editing === "1");
    if (editingAny){ alert("상품 수정 중에는 추가주문을 진행할 수 없습니다."); return; }

    // 취소선택 해제(원복)
    document.querySelectorAll(".product").forEach(p=>{
      if (p.dataset.status === "cancel_pending"){
        p.dataset.status = "sent";
        delete p.dataset.snapshot;
        const chk = p.querySelector(".chk-cancel-pick");
        if (chk) chk.checked = false;
        setBadge(p);
      }
    });

    setMode("form");

    const newP = addProduct(); // draft
    setTimeout(()=>{
      const first = newP.querySelectorAll("input")[0];
      if (first) first.focus();
      newP.scrollIntoView({ behavior:"smooth", block:"center" });
    }, 50);

    calc();
    renderDoneSummary();
    saveData();
  }

  /* =========================
     ✅ 새 주문(초기화) : 빨강 + 흰글씨
     ========================= */
  function newOrder(){
    if (!confirm("기존 상품 정보가 모두 초기화됩니다.\n정말 새 주문을 시작할까요?")) return;

    const keepCustomer = snapshotCustomer();

    ORDER_ID = newOrderId_();
    HIDE_DONE = false;

    productsDiv.innerHTML = "";
    addProduct();

    // 고객정보 유지
    document.getElementById("nickname").value = keepCustomer.nickname || "";
    document.getElementById("name").value = keepCustomer.name || "";
    document.getElementById("phone").value = keepCustomer.phone || "";
    document.getElementById("address").value = keepCustomer.address || "";
    document.getElementById("addressDetail").value = keepCustomer.addressDetail || "";

    renderShippingSummary();
    renderDoneSummary();
    setMode("form");
    calc();
    saveData();
  }

  /* =========================
     ✅ 배송지 수정(완료화면에서 가능)
     ========================= */
  function enterShipEdit(){
    if (MODE !== "complete") return;
    if (HIDE_DONE === false){
      // 펼쳐져 있어도 상관없지만, 실수 방지로 접어두고 시작
      HIDE_DONE = true;
      applyFoldVisibilityComplete();
    }

    const editingAny = Array.from(document.querySelectorAll(".product")).some(p => p.dataset.editing === "1");
    if (editingAny){
      alert("상품 수정 중에는 배송지 수정을 할 수 없습니다.");
      return;
    }

    SHIP_EDITING = true;
    SHIP_SNAPSHOT = snapshotCustomer();

    document.getElementById("shipSummary").style.display = "none";
    document.getElementById("customerFormFields").style.display = "block";
    document.getElementById("shipEditControls").style.display = "flex";
    document.getElementById("shipActions").style.display = "none";

    document.getElementById("modeBanner").innerText = "배송지 수정 중입니다. 저장 후 계속 진행해주세요.";
    focusBanner();

    saveData();
  }

  function exitShipEdit(silent){
    SHIP_EDITING = false;
    SHIP_SNAPSHOT = null;

    const shipSummary = document.getElementById("shipSummary");
    const customerFormFields = document.getElementById("customerFormFields");
    const shipEditControls = document.getElementById("shipEditControls");
    const shipActions = document.getElementById("shipActions");

    if (MODE === "complete"){
      shipSummary.style.display = "block";
      customerFormFields.style.display = "none";
      shipEditControls.style.display = "none";
      shipActions.style.display = "flex";
    } else {
      shipSummary.style.display = "none";
      customerFormFields.style.display = "block";
      shipEditControls.style.display = "none";
      shipActions.style.display = "none";
    }

    if (!silent) saveData();
  }

  function cancelShipEdit(){
    if (!SHIP_EDITING) return;

    // 원복
    const s = SHIP_SNAPSHOT || {};
    document.getElementById("nickname").value = s.nickname || "";
    document.getElementById("name").value = s.name || "";
    document.getElementById("phone").value = s.phone || "";
    document.getElementById("address").value = s.address || "";
    document.getElementById("addressDetail").value = s.addressDetail || "";

    renderShippingSummary();
    exitShipEdit(false);

    document.getElementById("modeBanner").innerText = "배송지 수정이 취소되었습니다.";
    focusBanner();
  }

  async function saveShipEdit(){
    if (!SHIP_EDITING) return;

    // 배송지 필수 체크
    if (!_validateCustomer_()) return;
    if (!confirm("배송지를 저장할까요?")) return;

    const payload = {
      orderId: ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      eventType: "ship_update",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items: [],
      sum: 0,
      shipping: 0,
      total: 0
    };

    try{
      await sendPayload(payload);

      renderShippingSummary();
      exitShipEdit(false);

      document.getElementById("modeBanner").innerText = "배송지 수정이 저장되었습니다.";
      focusBanner();
      alert("배송지 저장 완료");
    } catch(e){
      alert("전송에 실패했습니다. 네트워크 상태를 확인하고 다시 시도해주세요.");
    }
  }

  /* =========================
     ✅ 저장/복구
     ========================= */
  function saveData(){
    const data = {
      orderId: ORDER_ID,
      mode: MODE,
      hideDone: HIDE_DONE,
      shipEditing: SHIP_EDITING,
      customer: snapshotCustomer(),
      products: []
    };

    document.querySelectorAll(".product").forEach(p=>{
      const i = p.querySelectorAll("input");
      data.products.push({
        id: p.dataset.id || _uid(),
        status: p.dataset.status || "draft",
        snapshot: p.dataset.snapshot || "",
        editing: p.dataset.editing || "",
        name: i[0]?.value || "",
        color: i[1]?.value || "",
        size: i[2]?.value || "",
        qty: i[3]?.value || "",
        price: i[4]?.value || "",
        cancelChecked: (p.querySelector(".chk-cancel-pick")?.checked ? "1" : "")
      });
    });

    localStorage.setItem("orderData", JSON.stringify(data));
  }

  function loadData(){
    const data = JSON.parse(localStorage.getItem("orderData") || "null");
    if (!data){
      ORDER_ID = newOrderId_();
      addProduct();
      calc();
      renderShippingSummary();
      renderDoneSummary();
      saveData();
      setMode("form");
      return;
    }

    IS_LOADING = true;

    ORDER_ID = data.orderId || newOrderId_();
    HIDE_DONE = !!data.hideDone;

    // 고객정보
    const c = data.customer || {};
    document.getElementById("nickname").value = c.nickname || "";
    document.getElementById("name").value = c.name || "";
    document.getElementById("phone").value = c.phone || "";
    document.getElementById("address").value = c.address || "";
    document.getElementById("addressDetail").value = c.addressDetail || "";

    // 상품
    productsDiv.innerHTML = "";
    (data.products || []).forEach(p=>{
      const div = addProduct({
        id: p.id,
        status: p.status,
        snapshot: p.snapshot,
        name: p.name,
        color: p.color,
        size: p.size,
        qty: p.qty,
        price: p.price
      });

      if (p.cancelChecked === "1"){
        const chk = div.querySelector(".chk-cancel-pick");
        if (chk) chk.checked = true;
      }

      if (p.editing === "1"){
        // 편집중 상태는 복구하지 않고 안전하게 잠금 상태로
        delete div.dataset.editing;
      }

      setBadge(div);
    });

    if (!document.querySelector(".product")) addProduct();

    IS_LOADING = false;

    renderShippingSummary();
    renderDoneSummary();
    calc();

    const m = data.mode || "form";
    if (m === "complete"){
      setMode("complete", "주문이 완료되었습니다.");
      applyFoldVisibilityComplete();
      calc();
    } else {
      setMode("form");
    }

    saveData();
  }

  // 고객정보 입력시 저장
  ["nickname","name","phone","addressDetail"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      renderShippingSummary();
      saveData();
    });
  });

  loadData();
</script>

</body>
</html>