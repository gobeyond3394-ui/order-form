<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>셀프정산 주문서</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-top: 30px; }
  input, select { margin-bottom: 5px; padding: 5px; width: 200px; }
  .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  .buttons { margin-top: 20px; }
  button { margin-right: 10px; padding: 8px 12px; }
</style>
</head>
<body>

<h2>고객 정보</h2>
<div>
  <input type="text" id="nickname" placeholder="닉네임"><br>
  <input type="text" id="name" placeholder="이름"><br>
  <input type="text" id="phone" placeholder="연락처"><br>
  <input type="text" id="address" placeholder="주소"><br>
</div>

<h2>상품 목록</h2>
<div id="products"></div>
<button onclick="addProduct()">상품 추가</button>
<button onclick="deleteAllProducts()">상품목록 모두 삭제</button>

<h3>총 결제금액: <span id="totalAmount">0</span>원</h3>
<p>입금계좌: 카카오뱅크 3333-09797-1111 유혜정(유세연) 
<button onclick="copyAccount()">복사</button></p>

<div class="buttons">
  <button onclick="checkOrder()">주문서 확인</button>
  <button onclick="submitOrderDirect()">주문 완료</button>
  <button onclick="newOrder()">새 주문</button>
</div>

<script>
let productCount = 0;
const SHIPPING_COST = 4000;

function addProduct() {
  productCount++;
  const div = document.createElement("div");
  div.className = "product";
  div.innerHTML = `
    <input type="text" class="name" placeholder="상품명">
    <input type="text" class="color" placeholder="색상">
    <input type="text" class="size" placeholder="사이즈">
    <input type="number" class="qtyInput" placeholder="수량" min="1" value="1">
    <input type="number" class="priceInput" placeholder="가격" min="0" value="0">
  `;
  div.querySelectorAll("input").forEach(input => input.addEventListener("input", calculateTotal));
  document.getElementById("products").appendChild(div);
}

function deleteAllProducts() {
  if(confirm("상품목록을 모두 삭제하시겠습니까?")) {
    document.getElementById("products").innerHTML = "";
    calculateTotal();
  }
}

function getProductsArray() {
  const products = [];
  document.querySelectorAll(".product").forEach(p => {
    products.push({
      name: p.querySelector(".name").value,
      color: p.querySelector(".color").value,
      size: p.querySelector(".size").value,
      qty: Number(p.querySelector(".qtyInput").value),
      price: Number(p.querySelector(".priceInput").value)
    });
  });
  return products;
}

function calculateTotal() {
  let sum = 0;
  getProductsArray().forEach(p => {
    sum += p.qty * p.price;
  });
  const shipping = sum >= 100000 || sum === 0 ? 0 : SHIPPING_COST;
  document.getElementById("totalAmount").innerText = sum + shipping;
  return sum + shipping;
}

function copyAccount() {
  navigator.clipboard.writeText("카카오뱅크 3333-09797-1111 유혜정(유세연)");
  alert("계좌번호가 복사되었습니다.");
}

function validateOrder() {
  if(!document.getElementById("nickname").value ||
     !document.getElementById("name").value ||
     !document.getElementById("phone").value){
    alert("고객 정보를 모두 입력해주세요.");
    return false;
  }
  const products = getProductsArray();
  if(products.length === 0){
    alert("상품을 하나 이상 추가해주세요.");
    return false;
  }
  for(let p of products){
    if(!p.name || !p.qty || !p.price){
      alert("상품명, 수량, 가격을 모두 입력해주세요.");
      return false;
    }
  }
  return true;
}

function submitOrderDirect() {
  if(!validateOrder()) return;
  if(!confirm("주문을 완료하시겠습니까?")) return;
  sendOrderData();
}

function sendOrderData() {
  const data = {
    nickname: document.getElementById("nickname").value,
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    shipping: calculateTotal() - getProductsArray().reduce((acc,p)=>acc+p.qty*p.price,0),
    total: calculateTotal(),
    products: getProductsArray()
  };

  fetch("https://script.google.com/macros/s/AKfycby46Q9iopmJHmsh37thoaJ1fJGlm3gWHjc2W0sVm84Ue9q0W31CyFR3KAd69qBqySXk/exec", {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    if(res.status==="success"){
      alert("주문이 정상적으로 전송되었습니다!");
    } else {
      alert("주문 전송 실패: " + res.message);
    }
  })
  .catch(err => {
    alert("주문 전송 실패: " + err);
  });
}

function newOrder() {
  if(confirm("새 주문을 시작하면 현재 입력한 내용은 모두 초기화됩니다. 진행하시겠습니까?")) {
    location.reload();
  }
}

function checkOrder() {
  if(!validateOrder()) return;
  let summary = `주문서 확인\n\n고객 정보:\n닉네임: ${document.getElementById("nickname").value}\n이름: ${document.getElementById("name").value}\n연락처: ${document.getElementById("phone").value}\n주소: ${document.getElementById("address").value}\n\n상품 목록:\n`;
  getProductsArray().forEach((p,i)=>{
    summary += `${i+1}. ${p.name}, ${p.color}, ${p.size}, 수량: ${p.qty}, 가격: ${p.price}\n`;
  });
  summary += `\n총 결제금액: ${calculateTotal()}원`;
  if(confirm(summary + "\n\n주문 완료하시겠습니까?")) {
    sendOrderData();
  }
}
</script>

</body>
</html>
