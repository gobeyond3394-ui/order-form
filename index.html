<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹¸U ì…€í”„ ì •ì‚° ì£¼ë¬¸ì„œ</title>

<style>
body {
  margin: 0;
  padding: 16px;
  font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
  background: #fff;
  color: #111;
}

h1 {
  text-align: center;
  font-size: 20px;
  margin-bottom: 12px;
  color: #005FAE;
}

/* âœ… ìƒë‹¨ ëª¨ë“œ ë°°ë„ˆ */
.mode-banner{
  display:none;
  text-align:center;
  padding:10px 12px;
  border-radius:10px;
  font-weight:800;
  margin: 0 auto 14px;
  max-width: 560px;
}
body.mode-complete .mode-banner{
  display:block;
  background:#e8f2ff;
  border:1px solid #c8ddff;
  color:#005FAE;
}
body.mode-edit .mode-banner{
  display:block;
  background:#fff7e6;
  border:1px solid #ffe1a6;
  color:#9a6b00;
}
body.mode-cancel .mode-banner{
  display:block;
  background:#ffe9e9;
  border:1px solid #ffc9c9;
  color:#c0392b;
}

.section {
  margin-bottom: 28px;
}

.section-title {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 10px;
  color: #005FAE;
}

.divider {
  border-top: 1px solid #eee;
  margin: 12px 0 16px;
}

.field {
  margin-bottom: 12px;
}

label {
  display: block;
  font-size: 13px;
  margin-bottom: 4px;
}

input {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-sizing: border-box;
}

input::placeholder {
  color: #999;
}

.address-row {
  display: flex;
  gap: 8px;
}

.address-row input {
  flex: 1;
}

.addr-btn {
  background:#005FAE;
  color:#fff;
  font-weight:700;
  border:none;
  border-radius:6px;
  padding:12px 14px;
  cursor:pointer;
  white-space: nowrap;
}

.product {
  border-top: 1px solid #eee;
  padding-top: 12px;
  margin-top: 12px;
}

.row {
  display: flex;
  gap: 8px;
}

.row .field {
  flex: 1;
}

button {
  padding: 12px 14px;
  font-size: 14px;
  font-weight: 700;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

.button-line-3 {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 12px;
}

.button-line-3 button {
  flex: 0 0 calc((100% - 16px) / 3);
  max-width: calc((100% - 16px) / 3);
  white-space: nowrap;
}

/* âœ… ë²„íŠ¼ ì»¬ëŸ¬ */
.btn-add { background:#005FAE; color:#fff; }
.btn-delete { background:#e74c3c; color:#fff; }
.btn-clear { background:#E0E0E0; color:#333; }

.btn-check { background:#E0E0E0; color:#333; }
.btn-submit { background:#005FAE; color:#fff; }
.btn-new { background:#e74c3c; color:#fff; }

/* âœ… ì£¼ë¬¸ì™„ë£Œ í™”ë©´ í•˜ë‹¨ ë²„íŠ¼ */
.btn-edit-order{ background:#005FAE; color:#fff; }
.btn-cancel-order{ background:#e74c3c; color:#fff; }
.btn-back{ background:#E0E0E0; color:#333; }

.summary {
  border-top: 1px solid #eee;
  padding-top: 14px;
}

.summary-line {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin: 6px 0;
}

.summary-total {
  font-weight: 700;
  font-size: 16px;
  color: #005FAE;
}

.account-box {
  display: flex;
  align-items: center;
  background: #f4f7ff;
  border: 1px solid #d6e0ff;
  border-radius: 8px;
  padding: 10px;
  gap: 8px;
}

.account-text {
  font-size: 14px;
  white-space: nowrap;
  flex: 1;
}

.copy-btn {
  background: #005FAE;
  color: #fff;
  font-size: 12px;
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
}

/* ===== âœ… ìƒíƒœ ë°°ì§€ + ìƒí’ˆëª… ì˜¤ë¥¸ìª½ ===== */
.product-title-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.product-title-row input{
  flex:1;
}

.status-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  font-weight:700;
  padding:6px 10px;
  border-radius:6px;
  white-space:nowrap;
  user-select:none;
}
.status-badge .sq{
  width:10px;
  height:10px;
  border-radius:2px;
  display:inline-block;
}

/* ğŸ©¶ ì „ì†¡ëŒ€ê¸° */
.status-draft{
  background:#f2f2f2;
  color:#555;
  border:1px solid #d9d9d9;
}
.status-draft .sq{ background:#bdbdbd; }

/* ğŸŸ¦ ì „ì†¡ì™„ë£Œ */
.status-sent{
  background:#e8f2ff;
  color:#005FAE;
  border:1px solid #c8ddff;
}
.status-sent .sq{ background:#005FAE; }

/* ğŸ”´ [ì·¨ì†Œ] ì „ì†¡ëŒ€ê¸° */
.status-cancel-pending{
  background:#ffe9e9;
  color:#c0392b;
  border:1px solid #ffc9c9;
}
.status-cancel-pending .sq{ background:#e74c3c; }

/* âš« ì·¨ì†Œì™„ë£Œ */
.status-canceled{
  background:#ededed;
  color:#222;
  border:1px solid #cfcfcf;
}
.status-canceled .sq{ background:#111; }

/* ===== âœ… ì „ì†¡ì™„ë£Œ ìƒí’ˆìš© ë²„íŠ¼ ë¼ì¸ ===== */
.product-actions{
  display:flex;
  gap:8px;
  margin-top:10px;
}
.product-actions button{
  flex:1;
  padding:10px 12px;
  font-size:13px;
  border-radius:8px;
}
.btn-change{ background:#005FAE; color:#fff; }
.btn-cancel{ background:#e74c3c; color:#fff; }

/* ===== âœ… ë¯¸ì „ì†¡(í¸ì§‘/ì €ì¥) ìƒí’ˆìš© ë²„íŠ¼ ===== */
.btn-save{ background:#005FAE; color:#fff; }
.btn-edit{ background:#E0E0E0; color:#333; }
.btn-delete-item{ background:#e74c3c; color:#fff; }

/* ===== âœ… ì ê¸ˆ ì‹œ ì…ë ¥ì¹¸ íšŒìƒ‰ ì²˜ë¦¬ ===== */
.product.is-locked input{
  background:#f2f2f2 !important;
  color:#777 !important;
  border-color:#ddd !important;
}
.product.is-locked input::placeholder{
  color:#aaa !important;
}
.product.is-locked input:disabled{
  background:#f2f2f2 !important;
  color:#777 !important;
  -webkit-text-fill-color:#777 !important;
  opacity:1 !important;
}

/* ===== âœ… ì£¼ë¬¸ í™•ì •ì„œ ë²„íŠ¼(ì•„ì£¼ ì§„í•œ ê·¸ë ˆì´ + í°ê¸€ì”¨) ===== */
.btn-final{
  background:#1f1f1f;
  color:#fff;
  font-weight:800;
}
.button-line-full{
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 12px;
}
.button-line-full button{
  flex: 1 1 100%;
  max-width: 100%;
}

/* âœ… ìƒí’ˆì¶”ê°€/ìƒí’ˆì‚­ì œ 2ê°œë¥¼ í•œì¤„ ê½‰ì°¨ê²Œ */
.button-line-2{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.button-line-2 button{
  flex:1 1 50%;
  max-width:50%;
  white-space:nowrap;
}

/* âœ… ì™„ë£Œëª©ë¡ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ */
.small-link-btn{
  display:block;
  width:100%;
  margin-top:10px;
  padding:10px 12px;
  background:#f4f7ff;
  border:1px solid #d6e0ff;
  border-radius:10px;
  color:#333;
  font-size:14px;
  font-weight:700;
  text-align:center;
  cursor:pointer;
}
.small-link-btn:hover{
  filter: brightness(0.98);
}

/* âœ… ì „ì†¡ì™„ë£Œ ìƒí’ˆ ë²„íŠ¼ë“¤ê³¼ í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë¶„ë¦¬ */
.product-controls{
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px dashed #eee;
}

/* âœ… ëª¨ë“œë³„ UI ìˆ¨ê¹€/í‘œì‹œ */
body.mode-complete .addr-btn{ display:none; } /* ì™„ë£Œ í™”ë©´ì—ì„œëŠ” ì£¼ì†Œê²€ìƒ‰ ìˆ¨ê¹€(ì½ê¸°ì „ìš©ì²˜ëŸ¼) */
body.mode-complete .product-actions{ display:none !important; } /* ì™„ë£Œ í™”ë©´ì—ì„œëŠ” ê°œë³„ ìˆ˜ì •/ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¹€ */

body.mode-edit .button-line-2,
body.mode-cancel .button-line-2{ display:none; } /* ìˆ˜ì •/ì·¨ì†Œ í™”ë©´ì—ì„œ ìƒí’ˆì¶”ê°€/ì‚­ì œ ì œê±° */

body.mode-edit #btnNew,
body.mode-cancel #btnNew{ display:none; } /* ìˆ˜ì •/ì·¨ì†Œ í™”ë©´ì—ì„œ ìƒˆ ì£¼ë¬¸ ìˆ¨ê¹€ */

body.mode-create #orderCompleteControls,
body.mode-edit #orderCompleteControls,
body.mode-cancel #orderCompleteControls{ display:none; } /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */

body.mode-complete #createControls,
body.mode-complete #editControls,
body.mode-complete #cancelControls{ display:none; }

body.mode-edit #createControls,
body.mode-edit #cancelControls{ display:none; }

body.mode-cancel #createControls,
body.mode-cancel #editControls{ display:none; }

/* âœ… ìˆ˜ì •/ì·¨ì†Œ ì²´í¬ë°•ìŠ¤ í† ê¸€ UI */
.mode-toggles{
  display:none;
  gap:10px;
  align-items:center;
  margin-top:10px;
}
.mode-toggles label{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  font-weight:800;
  margin:0;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #eee;
  background:#fafafa;
}
.mode-toggles input{ width:auto; padding:0; }

body.mode-edit .mode-toggles{ display:flex; }
body.mode-cancel .mode-toggles{ display:flex; }

/* âœ… edit ëª¨ë“œì—ì„œëŠ” "ì·¨ì†Œ ì²´í¬" ìˆ¨ê¸°ê³ , cancel ëª¨ë“œì—ì„œëŠ” "ìˆ˜ì • ì²´í¬" ìˆ¨ê¹€ */
body.mode-edit .toggle-cancel{ display:none; }
body.mode-cancel .toggle-edit{ display:none; }
</style>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>

<h1>ì‹¸U ì…€í”„ ì •ì‚° ì£¼ë¬¸ì„œ</h1>
<div class="mode-banner" id="modeBanner">ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>

<div class="section">
  <div class="section-title" id="customerTitle">ê³ ê° ì •ë³´</div>
  <div class="divider"></div>

  <div class="field">
    <label>ë‹‰ë„¤ì„</label>
    <input id="nickname" placeholder="ì˜ˆ) GOë¹„ìš˜ë“œ">
  </div>

  <div class="field">
    <label>ì´ë¦„</label>
    <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™">
  </div>

  <div class="field">
    <label>ì—°ë½ì²˜</label>
    <input id="phone" placeholder="ì˜ˆ) 010-1234-5678">
  </div>

  <div class="field">
    <label>ì£¼ì†Œ</label>
    <div class="address-row">
      <input id="address" placeholder="ì£¼ì†Œê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" readonly>
      <button class="addr-btn" onclick="searchAddress()">ì£¼ì†Œê²€ìƒ‰</button>
    </div>
  </div>

  <div class="field">
    <label>ìƒì„¸ì£¼ì†Œ</label>
    <input id="addressDetail" placeholder="ì˜ˆ) 101ë™ 1203í˜¸">
  </div>
</div>

<div class="section">
  <div class="section-title" id="productTitle">ìƒí’ˆ ì •ë³´</div>
  <div id="foldSummary" style="display:none; font-size:13px; color:#333; background:#f7f9ff; border:1px solid #d6e0ff; border-radius:10px; padding:10px; margin:6px 0 10px; line-height:1.5;"></div>
  <div id="products"></div>

  <div class="product-controls">
    <button class="small-link-btn" onclick="toggleFold()">ì™„ë£Œëª©ë¡ ì ‘ê¸° â–²</button>

    <div class="button-line-2">
      <button class="btn-add" onclick="addProduct()">+ ìƒí’ˆ ì¶”ê°€</button>
      <button class="btn-delete" onclick="removeLastProduct()">- ìƒí’ˆ ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="section summary">
  <div class="summary-line"><span>ìƒí’ˆ í•©ê³„</span><span id="sum">0ì›</span></div>
  <div class="summary-line"><span>ë°°ì†¡ë¹„</span><span id="shipping">4,000ì›</span></div>
  <div class="summary-line summary-total"><span>ì´ ê²°ì œê¸ˆì•¡</span><span id="total">4,000ì›</span></div>
</div>

<div class="section">
  <div class="section-title">ì…ê¸ˆ ê³„ì¢Œ</div>
  <div class="account-box">
    <div class="account-text" id="accountText">
      ì¹´ì¹´ì˜¤ë±…í¬ 3333-09797-1111 ìœ í˜œì •(ìœ ì„¸ì—°)
    </div>
    <button class="copy-btn" onclick="copyAccount()">ë³µì‚¬</button>
  </div>
</div>

<!-- âœ… ì‘ì„±(ì£¼ë¬¸) í™”ë©´ ì»¨íŠ¸ë¡¤ -->
<div class="button-line-3" id="createControls">
  <button class="btn-new" id="btnNew" onclick="newOrder()">ìƒˆ ì£¼ë¬¸</button>
  <button class="btn-check" onclick="checkOrder()">ë¯¸ë¦¬ ë³´ê¸°</button>
  <button class="btn-submit" onclick="orderNow()">ì£¼ë¬¸í•˜ê¸°</button>
</div>

<!-- âœ… ì£¼ë¬¸ì™„ë£Œ í™”ë©´ ì»¨íŠ¸ë¡¤ -->
<div class="button-line-3" id="orderCompleteControls">
  <button class="btn-edit-order" onclick="enterEditMode()">ìˆ˜ì •</button>
  <button class="btn-cancel-order" onclick="enterCancelMode()">ì·¨ì†Œ</button>
  <button class="btn-final" onclick="checkFinalOrder()">ì£¼ë¬¸ í™•ì •ì„œ</button>
</div>

<!-- âœ… ìˆ˜ì • í™”ë©´ ì»¨íŠ¸ë¡¤ -->
<div class="button-line-3" id="editControls">
  <button class="btn-back" onclick="exitEditMode()">ìˆ˜ì •ì·¨ì†Œ</button>
  <button class="btn-check" onclick="checkOrder()">ë¯¸ë¦¬ ë³´ê¸°</button>
  <button class="btn-submit" onclick="submitOrder()">ìˆ˜ì •ì™„ë£Œ</button>
</div>

<!-- âœ… ì·¨ì†Œ í™”ë©´ ì»¨íŠ¸ë¡¤ -->
<div class="button-line-3" id="cancelControls">
  <button class="btn-back" onclick="exitCancelMode()">ëŒì•„ê°€ê¸°</button>
  <button class="btn-check" onclick="checkOrder()">ë¯¸ë¦¬ ë³´ê¸°</button>
  <button class="btn-submit" onclick="submitOrder()">ì·¨ì†Œì™„ë£Œ</button>
</div>

<script>
const SHIPPING = 4000;
const productsDiv = document.getElementById("products");
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypKfZsjR0uu9Lcc7OirR2tiyjIzzLwREGd3Bw3szXmLVIHHNGhwlmoOdRaInh2xebf/exec";

let IS_LOADING = false;

/* âœ… ì™„ë£Œëª©ë¡ ìˆ¨ê¹€ í† ê¸€ (sent/canceledë§Œ ìˆ¨ê¹€) */
let HIDE_DONE = false;

/* âœ… ì£¼ë¬¸ID */
let ORDER_ID = "";
function newOrderId_(){
  return "oid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
}

/* âœ… í™”ë©´ ëª¨ë“œ: create | complete | edit | cancel */
let MODE = "create";

function setMode(mode){
  MODE = mode;

  document.body.classList.remove("mode-create","mode-complete","mode-edit","mode-cancel");
  document.body.classList.add("mode-" + MODE);

  const banner = document.getElementById("modeBanner");
  const customerTitle = document.getElementById("customerTitle");
  const productTitle = document.getElementById("productTitle");

  if (MODE === "complete") {
    banner.innerText = "ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
    customerTitle.innerText = "ë°°ì†¡ì§€ ì •ë³´";
    productTitle.innerText = "ì£¼ë¬¸ ì™„ë£Œ ìƒí’ˆ";
  } else if (MODE === "edit") {
    banner.innerText = "ìˆ˜ì • í™”ë©´ì…ë‹ˆë‹¤. ìˆ˜ì •í•  ìƒí’ˆì„ ì²´í¬í•˜ê³  ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.";
    customerTitle.innerText = "ë°°ì†¡ì§€ ì •ë³´ (ìˆ˜ì • ê°€ëŠ¥)";
    productTitle.innerText = "ì£¼ë¬¸ ìƒí’ˆ (ê°œë³„ ìˆ˜ì • ì„ íƒ)";
  } else if (MODE === "cancel") {
    banner.innerText = "ì·¨ì†Œ í™”ë©´ì…ë‹ˆë‹¤. ì·¨ì†Œí•  ìƒí’ˆì„ ì²´í¬í•˜ì„¸ìš”.";
    customerTitle.innerText = "ë°°ì†¡ì§€ ì •ë³´";
    productTitle.innerText = "ì£¼ë¬¸ ìƒí’ˆ (ê°œë³„ ì·¨ì†Œ ì„ íƒ)";
  } else {
    banner.innerText = "";
    customerTitle.innerText = "ê³ ê° ì •ë³´";
    productTitle.innerText = "ìƒí’ˆ ì •ë³´";
  }

  _lockCustomerByMode_();
  _syncBottomControls_();
  _syncProductTogglesByMode_();

  saveData();
}

/* âœ… í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ í† ê¸€ */
function _syncBottomControls_(){
  const createControls = document.getElementById("createControls");
  const orderCompleteControls = document.getElementById("orderCompleteControls");
  const editControls = document.getElementById("editControls");
  const cancelControls = document.getElementById("cancelControls");

  createControls.style.display = (MODE === "create") ? "flex" : "none";
  orderCompleteControls.style.display = (MODE === "complete") ? "flex" : "none";
  editControls.style.display = (MODE === "edit") ? "flex" : "none";
  cancelControls.style.display = (MODE === "cancel") ? "flex" : "none";
}

/* âœ… ê³ ê°ì •ë³´ ì ê¸ˆ/í•´ì œ */
function _lockCustomer(lock){
  const ids = ["nickname","name","phone","address","addressDetail"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;

    if (id === "address") {
      // addressëŠ” ê¸°ë³¸ readonly ìœ ì§€, ê²€ìƒ‰ ë²„íŠ¼ìœ¼ë¡œë§Œ ì…ë ¥
      el.readOnly = true;
    } else {
      el.readOnly = lock;
    }
    el.disabled = false;

    if (lock) {
      el.style.background = "#f2f2f2";
      el.style.color = "#777";
      el.style.borderColor = "#ddd";
    } else {
      el.style.background = "";
      el.style.color = "";
      el.style.borderColor = "";
    }
  });
}

function _lockCustomerByMode_(){
  if (MODE === "create") _lockCustomer(false);
  if (MODE === "complete") _lockCustomer(true);
  if (MODE === "cancel") _lockCustomer(true);
  if (MODE === "edit") _lockCustomer(false);
}

/* âœ… ì™„ë£Œëª©ë¡ ìˆ¨ê¹€ í† ê¸€ */
function toggleFold() {
  HIDE_DONE = !HIDE_DONE;

  const btn = document.querySelector('button[onclick="toggleFold()"]');
  if (btn) btn.innerText = HIDE_DONE ? "ì™„ë£Œëª©ë¡ í¼ì¹˜ê¸° â–¼" : "ì™„ë£Œëª©ë¡ ì ‘ê¸° â–²";

  applyFoldVisibility();
  renderFoldSummary();
  saveData();
}

function _getProductAmount_(p) {
  const i = p.querySelectorAll("input");
  const qty = Number(i[3]?.value || 0);
  const price = Number(i[4]?.value || 0);
  return qty * price;
}

function applyFoldVisibility() {
  document.querySelectorAll(".product").forEach(p => {
    const st = p.dataset.status || "draft_edit";
    if (HIDE_DONE && (st === "sent" || st === "canceled")) {
      p.style.display = "none";
    } else {
      p.style.display = "";
    }
  });
}

function renderFoldSummary() {
  const box = document.getElementById("foldSummary");
  if (!box) return;

  const lines = [];

  document.querySelectorAll(".product").forEach(p => {
    const st = p.dataset.status || "draft_edit";
    if (!(st === "sent" || st === "canceled")) return;

    const i = p.querySelectorAll("input");
    const name = (i[0]?.value || "").trim();
    const color = (i[1]?.value || "").trim();
    const size = (i[2]?.value || "").trim();
    const qty = (i[3]?.value || "").trim();
    const price = (i[4]?.value || "").trim();

    if (st === "canceled") {
      lines.push(`â€¢ [ì·¨ì†Œì™„ë£Œ] ${name} / ${color} / ${size} / ${qty}ê°œ / ${price}ì›`);
    } else {
      lines.push(`â€¢ [ì „ì†¡ì™„ë£Œ] ${name} / ${color} / ${size} / ${qty}ê°œ / ${price}ì›`);
    }
  });

  if (lines.length === 0) {
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }

  box.style.display = "block";
  box.innerHTML = lines.join("<br>");
}

function _uid() {
  return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
}

function _isDraftStatus(status) {
  return (status === "draft" || status === "draft_edit" || status === "draft_saved");
}

function _setStatusBadge(div, status) {
  const badge = div.querySelector(".status-badge");
  if (!badge) return;

  badge.classList.remove("status-draft","status-sent","status-cancel-pending","status-canceled");

  const action = (div.dataset.action || "").trim();

  if (_isDraftStatus(status)) {
    badge.classList.add("status-draft");
    if (action === "modify") badge.innerHTML = `<span class="sq"></span>[ìˆ˜ì •] ì „ì†¡ëŒ€ê¸°`;
    else badge.innerHTML = `<span class="sq"></span>ì „ì†¡ëŒ€ê¸°`;
    return;
  }

  if (status === "sent") {
    badge.classList.add("status-sent");
    badge.innerHTML = `<span class="sq"></span>ì „ì†¡ì™„ë£Œ`;
    return;
  }

  if (status === "cancel_pending") {
    badge.classList.add("status-cancel-pending");
    badge.innerHTML = `<span class="sq"></span>[ì·¨ì†Œ] ì „ì†¡ëŒ€ê¸°`;
    return;
  }

  if (status === "canceled") {
    badge.classList.add("status-canceled");
    badge.innerHTML = `<span class="sq"></span>ì·¨ì†Œì™„ë£Œ`;
    return;
  }

  if (status === "sent_edit") {
    badge.classList.add("status-draft");
    badge.innerHTML = `<span class="sq"></span>ìˆ˜ì •ì¤‘`;
    return;
  }

  badge.classList.add("status-draft");
  badge.innerHTML = `<span class="sq"></span>ì „ì†¡ëŒ€ê¸°`;
}

function _lockInputs(div, lock) {
  const inputs = div.querySelectorAll("input");
  inputs.forEach((inp, idx) => {
    if (lock) {
      if (idx === 3 || idx === 4) inp.disabled = true;
      else inp.readOnly = true;
    } else {
      inp.disabled = false;
      inp.readOnly = false;
    }
  });
}

function _renderActions(div) {
  const status = div.dataset.status || "draft_edit";
  const actions = div.querySelector(".product-actions");
  if (!actions) return;

  const btnSave = actions.querySelector(".btn-save");
  const btnEdit = actions.querySelector(".btn-edit");
  const btnDeleteItem = actions.querySelector(".btn-delete-item");
  const btnChange = actions.querySelector(".btn-change");
  const btnCancel = actions.querySelector(".btn-cancel");

  [btnSave, btnEdit, btnDeleteItem, btnChange, btnCancel].forEach(b => {
    if (b) b.style.display = "none";
  });

  // âœ… complete ëª¨ë“œì—ì„œëŠ” ê°œë³„ ë²„íŠ¼ ìˆ¨ê¹€(ìƒë‹¨ì—ì„œ ì´ë¯¸ ìˆ¨ê¸°ì§€ë§Œ ì•ˆì „)
  if (MODE === "complete") { actions.style.display = "none"; return; }

  if (status === "sent") {
    actions.style.display = "flex";
    if (btnChange) { btnChange.style.display = "block"; btnChange.innerText = "ìˆ˜ì •"; }
    if (btnCancel) { btnCancel.style.display = "block"; btnCancel.innerText = "ì·¨ì†Œ"; }
    return;
  }

  if (status === "sent_edit") {
    actions.style.display = "flex";
    if (btnSave) { btnSave.style.display = "block"; btnSave.innerText = "ì €ì¥"; }
    if (btnEdit) { btnEdit.style.display = "block"; btnEdit.innerText = "ìˆ˜ì • ì·¨ì†Œ"; }
    return;
  }

  const origin = div.dataset.origin || "";
  const isChangeDraft = (origin === "change");
  if (!isChangeDraft) { actions.style.display = "none"; return; }

  if (status === "draft" || status === "draft_edit") {
    actions.style.display = "flex";
    if (btnSave) { btnSave.style.display = "block"; btnSave.innerText = "ì €ì¥"; }
    if (btnDeleteItem) btnDeleteItem.style.display = "block";
    return;
  }

  if (status === "draft_saved") {
    actions.style.display = "flex";
    if (btnEdit) { btnEdit.style.display = "block"; btnEdit.innerText = "ìˆ˜ì •"; }
    if (btnDeleteItem) btnDeleteItem.style.display = "block";
    return;
  }

  actions.style.display = "none";
}

function _applyProductUI(div) {
  const status = div.dataset.status || "draft_edit";
  _setStatusBadge(div, status);

  if (status === "draft_saved" || status === "sent" || status === "cancel_pending" || status === "canceled") {
    _lockInputs(div, true);
    div.classList.add("is-locked");
  } else {
    _lockInputs(div, false);
    div.classList.remove("is-locked");
  }

  if (status === "sent_edit") {
    _lockInputs(div, false);
    div.classList.remove("is-locked");
  }

  // âœ… cancel ëª¨ë“œì—ì„œëŠ” ì…ë ¥ì¹¸ì€ ê³„ì† ì ê¸ˆ(íšŒìƒ‰) ìœ ì§€
  if (MODE === "cancel") {
    _lockInputs(div, true);
    div.classList.add("is-locked");
  }

  _renderActions(div);

  applyFoldVisibility();
  renderFoldSummary();

  _syncOneProductToggleUI_(div);
}

/* âœ… ì²´í¬ë°•ìŠ¤ í‘œì‹œ/ìƒíƒœ ë™ê¸°í™” */
function _syncProductTogglesByMode_(){
  document.querySelectorAll(".product").forEach(p => _syncOneProductToggleUI_(p));
}

function _syncOneProductToggleUI_(div){
  const st = div.dataset.status || "draft_edit";
  const chkEdit = div.querySelector(".chk-edit");
  const chkCancel = div.querySelector(".chk-cancel");

  if (chkEdit) {
    chkEdit.disabled = (st === "canceled"); // ì·¨ì†Œì™„ë£ŒëŠ” ìˆ˜ì • ë¶ˆê°€
    chkEdit.checked = (st === "sent_edit");
  }

  if (chkCancel) {
    chkCancel.disabled = (st === "canceled"); // ì´ë¯¸ ì·¨ì†Œì™„ë£Œë©´ ì„ íƒ ë¶ˆê°€
    chkCancel.checked = (st === "cancel_pending");
  }
}

function _copyProductValues(fromDiv) {
  const i = fromDiv.querySelectorAll("input");
  return {
    name: i[0].value || "",
    color: i[1].value || "",
    size: i[2].value || "",
    qty: i[3].value || "",
    price: i[4].value || ""
  };
}

function _attachActionHandlers(div) {
  const actions = div.querySelector(".product-actions");
  const btnSave = actions ? actions.querySelector(".btn-save") : null;
  const btnEdit = actions ? actions.querySelector(".btn-edit") : null;
  const btnDeleteItem = actions ? actions.querySelector(".btn-delete-item") : null;
  const btnChange = actions ? actions.querySelector(".btn-change") : null;
  const btnCancel = actions ? actions.querySelector(".btn-cancel") : null;

  if (btnSave) {
    btnSave.onclick = () => {
      const status = div.dataset.status || "draft_edit";

      if (status === "sent_edit") {
        div.dataset.status = "draft_saved";
        div.dataset.action = "modify";
        div.dataset.modifiedFrom = "sent";

        alert("ìˆ˜ì • ìš”ì²­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n'ìˆ˜ì •ì™„ë£Œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì „ì†¡ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");

        _applyProductUI(div);
        calc();
        saveData();
        return;
      }

      if (status !== "draft" && status !== "draft_edit") return;

      div.dataset.status = "draft_saved";
      _applyProductUI(div);
      calc();
      saveData();
    };
  }

  if (btnEdit) {
    btnEdit.onclick = () => {
      const status = div.dataset.status || "draft_edit";

      if (status === "sent_edit") {
        const snap = div.dataset.snapshot ? JSON.parse(div.dataset.snapshot) : null;
        if (snap) {
          const i = div.querySelectorAll("input");
          i[0].value = snap.name || "";
          i[1].value = snap.color || "";
          i[2].value = snap.size || "";
          i[3].value = snap.qty != null ? snap.qty : "";
          i[4].value = snap.price != null ? snap.price : "";
        }
        div.dataset.status = "sent";
        delete div.dataset.snapshot;
        _applyProductUI(div);
        calc();
        saveData();
        return;
      }

      if (status !== "draft_saved") return;

      div.dataset.status = "draft_edit";
      _applyProductUI(div);

      const firstInput = div.querySelectorAll("input")[0];
      if (firstInput) firstInput.focus();

      calc();
      saveData();
    };
  }

  if (btnDeleteItem) {
    btnDeleteItem.onclick = () => {
      const status = div.dataset.status || "draft_edit";
      if (!_isDraftStatus(status)) return;
      if (!confirm("í•´ë‹¹ ìƒí’ˆì„ ì‚­ì œí• ê¹Œìš”?")) return;

      div.remove();
      if (!document.querySelector(".product")) addProduct();

      calc();
      saveData();
    };
  }

  if (btnChange) {
    btnChange.onclick = () => {
      const status = div.dataset.status || "draft_edit";
      if (status !== "sent") return;

      const snap = _copyProductValues(div);
      div.dataset.snapshot = JSON.stringify(snap);

      div.dataset.status = "sent_edit";
      _applyProductUI(div);

      const firstInput = div.querySelectorAll("input")[0];
      if (firstInput) firstInput.focus();

      saveData();
      applyFoldVisibility();
      renderFoldSummary();
    };
  }

  if (btnCancel) {
    btnCancel.onclick = () => {
      const status = div.dataset.status || "draft_edit";
      if (status !== "sent") return;

      if (!div.dataset.snapshot) {
        const snap = _copyProductValues(div);
        div.dataset.snapshot = JSON.stringify(snap);
      }

      div.dataset.status = "cancel_pending";
      _applyProductUI(div);
      calc();
      saveData();
    };
  }

  /* âœ… ëª¨ë“œë³„ ì²´í¬ë°•ìŠ¤ í•¸ë“¤ëŸ¬ */
  const chkEdit = div.querySelector(".chk-edit");
  const chkCancel = div.querySelector(".chk-cancel");

  if (chkEdit) {
    chkEdit.onchange = () => {
      const st = div.dataset.status || "draft_edit";
      if (MODE !== "edit") return;

      // ì²´í¬ ON: sent -> sent_edit ì§„ì…
      if (chkEdit.checked) {
        if (st === "sent") {
          if (btnChange) btnChange.onclick();
        }
      } else {
        // ì²´í¬ OFF: sent_editë©´ ì›ë³µ
        if (st === "sent_edit") {
          if (btnEdit) btnEdit.onclick();
        }
      }
    };
  }

  if (chkCancel) {
    chkCancel.onchange = () => {
      const st = div.dataset.status || "draft_edit";
      if (MODE !== "cancel") return;

      // ì²´í¬ ON: sent -> cancel_pending
      if (chkCancel.checked) {
        if (st === "sent") {
          if (btnCancel) btnCancel.onclick();
        }
      } else {
        // ì²´í¬ OFF: cancel_pending -> sent (ì·¨ì†Œ ë³µì›)
        if (st === "cancel_pending") {
          div.dataset.status = "sent";
          delete div.dataset.snapshot;
          _applyProductUI(div);
          calc();
          saveData();
        }
      }
    };
  }
}

function addProduct(preset, insertAfterRef) {
  const div = document.createElement("div");
  div.className = "product";

  const pid = (preset && preset.id) ? preset.id : _uid();
  const pstatus = (preset && preset.status) ? preset.status : "draft_edit";

  div.dataset.id = pid;
  div.dataset.status = pstatus;

  if (preset && preset.origin) div.dataset.origin = preset.origin;
  if (preset && preset.action) div.dataset.action = preset.action;
  if (preset && preset.modifiedFrom) div.dataset.modifiedFrom = preset.modifiedFrom;

  if (preset && preset.snapshot) div.dataset.snapshot = preset.snapshot;

  div.innerHTML = `
    <div class="field">
      <label>ìƒí’ˆëª…</label>
      <div class="product-title-row">
        <input class="product-name" placeholder="ì˜ˆ) ì•„ë¯¸ ë§¨íˆ¬ë§¨ / í´ë¡œ ê½ˆë°°ê¸° ë‹ˆíŠ¸ / ë©”ì¢… í›„ë“œí‹° / ê¼¼ë° ê¸´íŒ”í‹° / ì•Œë¡œ ì…‹ì—…">
        <div class="status-badge status-draft"><span class="sq"></span>ì „ì†¡ëŒ€ê¸°</div>
      </div>

      <div class="mode-toggles">
        <label class="toggle toggle-edit"><input type="checkbox" class="chk-edit"> ìˆ˜ì • ì„ íƒ</label>
        <label class="toggle toggle-cancel"><input type="checkbox" class="chk-cancel"> ì·¨ì†Œ ì„ íƒ</label>
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>ìƒ‰ìƒ</label>
        <input placeholder="ì˜ˆ) ë¸”ë™ / ê²€ì •">
      </div>
      <div class="field">
        <label>ì‚¬ì´ì¦ˆ</label>
        <input placeholder="ì˜ˆ) L / ë¼ì§€ / 100">
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>ìˆ˜ëŸ‰</label>
        <input type="number" value="" placeholder="ì˜ˆ) 1">
      </div>
      <div class="field">
        <label>ê°€ê²©</label>
        <input type="number" placeholder="ì˜ˆ) 59000">
      </div>
    </div>
    <div class="product-actions" style="display:none;">
      <button class="btn-save" type="button">ì €ì¥</button>
      <button class="btn-edit" type="button">ìˆ˜ì •</button>
      <button class="btn-delete-item" type="button">ì‚­ì œ</button>
      <button class="btn-change" type="button">ìˆ˜ì •</button>
      <button class="btn-cancel" type="button">ì·¨ì†Œ</button>
    </div>
  `;

  const inputs = div.querySelectorAll("input");
  inputs.forEach(i => {
    i.addEventListener("input", calc);
    i.addEventListener("input", saveData);
  });

  if (preset) {
    inputs[0].value = preset.name || "";
    inputs[1].value = preset.color || "";
    inputs[2].value = preset.size || "";
    inputs[3].value = preset.qty != null ? preset.qty : "";
    inputs[4].value = preset.price != null ? preset.price : "";
  }

  if (insertAfterRef && typeof insertAfterRef !== "boolean" && insertAfterRef.nodeType === 1 && insertAfterRef.parentNode) {
    insertAfterRef.insertAdjacentElement("afterend", div);
  } else {
    productsDiv.appendChild(div);
  }

  _attachActionHandlers(div);
  _applyProductUI(div);

  calc();
  applyFoldVisibility();
  renderFoldSummary();
  if (!IS_LOADING) saveData();
  return div;
}

function removeLastProduct() {
  const items = document.querySelectorAll(".product");
  if (items.length === 0) return;

  for (let idx = items.length - 1; idx >= 0; idx--) {
    const st = items[idx].dataset.status || "draft_edit";
    if (_isDraftStatus(st)) {
      items[idx].remove();
      break;
    }
  }

  calc();
  saveData();
  applyFoldVisibility();
  renderFoldSummary();
}

/* âœ… ìƒíƒœë³„ ìµœì¢…í•©ê³„ ê³„ì‚° */
function calc() {
  let sum = 0;

  document.querySelectorAll(".product").forEach(p => {
    const st = p.dataset.status || "draft_edit";
    const action = (p.dataset.action || "").trim();
    const i = p.querySelectorAll("input");

    const curQty = Number((i[3]?.value || "").trim() || 0);
    const curPrice = Number((i[4]?.value || "").trim() || 0);
    const curAmt = curQty * curPrice;

    const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : null;
    const snapQty = snap ? Number(String(snap.qty || "").trim() || 0) : 0;
    const snapPrice = snap ? Number(String(snap.price || "").trim() || 0) : 0;
    const snapAmt = snapQty * snapPrice;

    if (st === "sent") {
      sum += curAmt;
      return;
    }

    if (_isDraftStatus(st) && action !== "modify") {
      sum += curAmt;
      return;
    }

    if (_isDraftStatus(st) && action === "modify") {
      const delta = snap ? (curAmt - snapAmt) : 0;
      sum += delta;
      return;
    }

    if (st === "cancel_pending") {
      const cancelAmt = snap ? snapAmt : curAmt;
      sum -= cancelAmt;
      return;
    }
  });

  let shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

  sumEl.innerText = sum.toLocaleString() + "ì›";
  shippingEl.innerText = shipping.toLocaleString() + "ì›";
  totalEl.innerText = (sum + shipping).toLocaleString() + "ì›";

  applyFoldVisibility();
  renderFoldSummary();
}

const sumEl = document.getElementById("sum");
const shippingEl = document.getElementById("shipping");
const totalEl = document.getElementById("total");

function copyAccount() {
  const text = accountText.innerText;
  const accountNumberOnly = text.replace(/[^0-9]/g, "");
  navigator.clipboard.writeText(accountNumberOnly);
  alert("ê³„ì¢Œë²ˆí˜¸ë§Œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function searchAddress() {
  if (MODE === "complete" || MODE === "cancel") return; // ì™„ë£Œ/ì·¨ì†Œ í™”ë©´ì—ì„œëŠ” ê²€ìƒ‰ ë§‰ìŒ
  new daum.Postcode({
    oncomplete: function(data) {
      document.getElementById("address").value = data.address;
      document.getElementById("addressDetail").focus();
      saveData();
    }
  }).open();
}

function checkOrder() {
  let text = "[ê³ ê° ì •ë³´]\n";
  text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
  text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
  text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
  text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

  text += "[ìƒí’ˆ ì •ë³´]\n";

  const pendingItems = [];
  document.querySelectorAll(".product").forEach(p => {
    const st = p.dataset.status || "draft_edit";
    if (_isDraftStatus(st) || st === "cancel_pending") pendingItems.push(p);
  });

  if (pendingItems.length === 0) {
    text += "ì „ì†¡ ëŒ€ê¸° / ì·¨ì†Œ ìš”ì²­ / ìˆ˜ì • ìš”ì²­ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.\n";
  } else {
    pendingItems.forEach((p, idx) => {
      const inputs = p.querySelectorAll("input");
      const st = p.dataset.status || "draft_edit";
      const action = (p.dataset.action || "").trim();

      if (_isDraftStatus(st)) {
        const prefix = (action === "modify") ? "[ìˆ˜ì •ìš”ì²­] " : "";
        text += `${idx+1}. ${prefix}${inputs[0].value} / ${inputs[1].value} / ${inputs[2].value} / ${inputs[3].value}ê°œ / ${inputs[4].value}ì›\n`;
      } else if (st === "cancel_pending") {
        const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : null;
        const q = snap ? (snap.qty || "") : (inputs[3].value || "");
        const pr = snap ? (snap.price || "") : (inputs[4].value || "");
        text += `${idx+1}. [ì·¨ì†Œìš”ì²­] ${inputs[0].value} / ${inputs[1].value} / ${inputs[2].value} / ${q}ê°œ / ${pr}ì›\n`;
      }
    });
  }

  text += `\nìƒí’ˆí•©ê³„: ${sumEl.innerText}\n`;
  text += `ë°°ì†¡ë¹„: ${shippingEl.innerText}\n`;
  text += `ì´ ê²°ì œê¸ˆì•¡: ${totalEl.innerText}\n\n`;
  text += "ìœ„ ë‚´ìš©ì´ ë§ìœ¼ë©´ ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";

  alert(text);
}

function checkFinalOrder() {
  let text = "[ê³ ê° ì •ë³´]\n";
  text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
  text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
  text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
  text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

  text += "[ìƒí’ˆ ì •ë³´]\n";

  const finalItems = [];
  document.querySelectorAll(".product").forEach(p => {
    const st = p.dataset.status || "draft_edit";
    if (st === "sent" || st === "canceled") finalItems.push(p);
  });

  let sum = 0;

  if (finalItems.length === 0) {
    text += "(ì „ì†¡ ì™„ë£Œ/ì·¨ì†Œ ì™„ë£Œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
  } else {
    finalItems.forEach((p, i) => {
      const inputs = p.querySelectorAll("input");
      const st = p.dataset.status || "draft_edit";

      if (st === "sent") {
        const qty = Number(inputs[3].value || 0);
        const price = Number(inputs[4].value || 0);
        sum += qty * price;
        text += `${i+1}. ${inputs[0].value} / ${inputs[1].value} / ${inputs[2].value} / ${inputs[3].value}ê°œ / ${inputs[4].value}ì›\n`;
      } else if (st === "canceled") {
        const qtyText = (inputs[3].value || "").trim();
        const priceText = (inputs[4].value || "").trim();
        const q = qtyText ? `${qtyText}ê°œ` : "0ê°œ";
        const pr = priceText ? `${priceText}ì›` : "0ì›";
        text += `${i+1}. [ì·¨ì†Œì™„ë£Œ] ${inputs[0].value} / ${inputs[1].value} / ${inputs[2].value} / ${q} / ${pr}\n`;
      }
    });
  }

  let shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

  text += `\nìƒí’ˆí•©ê³„: ${sum.toLocaleString()}ì›\n`;
  text += `ë°°ì†¡ë¹„: ${shipping.toLocaleString()}ì›\n`;
  text += `ì´ ê²°ì œê¸ˆì•¡: ${(sum + shipping).toLocaleString()}ì›\n`;

  alert(text);
}

function _validateBeforeSubmit_() {
  const nickname = document.getElementById("nickname");
  const name = document.getElementById("name");
  const phone = document.getElementById("phone");
  const address = document.getElementById("address");
  const addressDetail = document.getElementById("addressDetail");

  if (!nickname.value.trim()) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); nickname.focus(); return false; }
  if (!name.value.trim()) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); name.focus(); return false; }
  if (!phone.value.trim()) { alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); phone.focus(); return false; }
  if (!address.value.trim()) { alert("ì£¼ì†Œê²€ìƒ‰ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return false; }
  if (!addressDetail.value.trim()) { alert("ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); addressDetail.focus(); return false; }

  let hasSendTarget = false;

  const products = document.querySelectorAll(".product");
  for (let idx = 0; idx < products.length; idx++) {
    const p = products[idx];
    const st = p.dataset.status || "draft_edit";
    const i = p.querySelectorAll("input");

    const pName = (i[0]?.value || "").trim();
    const pColor = (i[1]?.value || "").trim();
    const pSize = (i[2]?.value || "").trim();
    const pQty = (i[3]?.value || "").trim();
    const pPrice = (i[4]?.value || "").trim();

    if (_isDraftStatus(st) || st === "cancel_pending") {
      hasSendTarget = true;

      if (!pName) { alert("ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[0].focus(); return false; }
      if (!pColor) { alert("ìƒ‰ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[1].focus(); return false; }
      if (!pSize) { alert("ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[2].focus(); return false; }

      if (_isDraftStatus(st)) {
        const nQty = Number(pQty || 0);
        const nPrice = Number(pPrice || 0);
        if (!pQty || nQty <= 0) { alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[3].focus(); return false; }
        if (!pPrice || nPrice <= 0) { alert("ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[4].focus(); return false; }
      }
    }
  }

  if (!hasSendTarget) {
    alert("ì „ì†¡ ëŒ€ê¸° / ì·¨ì†Œ ìš”ì²­ / ìˆ˜ì • ìš”ì²­ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
    return false;
  }

  return true;
}

function _amountOf_(obj) {
  const q = Number(obj.qty || 0);
  const p = Number(obj.price || 0);
  return q * p;
}

async function submitOrder() {
  if (!_validateBeforeSubmit_()) return;

  // âœ… ëª¨ë“œì— ë”°ë¼ í™•ì¸ë¬¸êµ¬ ë³€ê²½
  let confirmText = "ì£¼ë¬¸ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
  if (MODE === "edit") confirmText = "ìˆ˜ì •ì„ ì™„ë£Œí•˜ê³  ì „ì†¡í• ê¹Œìš”?";
  if (MODE === "cancel") confirmText = "ì„ íƒí•œ ì·¨ì†Œë¥¼ ì™„ë£Œí•˜ê³  ì „ì†¡í• ê¹Œìš”?";
  if (!confirm(confirmText)) return;

  saveData();

  const kstNowString = () => {
    const d = new Date(Date.now() + 9 * 60 * 60 * 1000);
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(d.getUTCDate()).padStart(2, "0");
    const hh = String(d.getUTCHours()).padStart(2, "0");
    const mi = String(d.getUTCMinutes()).padStart(2, "0");
    const ss = String(d.getUTCSeconds()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  };

  const items = [];
  const toFinalize = [];

  let deltaSum = 0;
  let hasNewItem = false;

  document.querySelectorAll(".product").forEach(p => {
    const st = p.dataset.status || "draft_edit";
    const i = p.querySelectorAll("input");
    const action = (p.dataset.action || "").trim();

    const cur = {
      name: (i[0].value || "").trim(),
      color: (i[1].value || "").trim(),
      size: (i[2].value || "").trim(),
      qty: Number(i[3].value || 0),
      price: Number(i[4].value || 0)
    };

    if (_isDraftStatus(st) && action === "modify") {
      const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : { qty: 0, price: 0 };
      const oldAmt = _amountOf_(snap);
      const newAmt = _amountOf_(cur);
      const delta = newAmt - oldAmt;

      items.push({
        productName: `[ìˆ˜ì •] ${cur.name}`.trim(),
        color: cur.color,
        size: cur.size,
        qty: cur.qty,
        price: cur.price,
        amountDelta: delta
      });

      deltaSum += delta;
      toFinalize.push({ el: p, nextStatus: "sent", clearAction: true, clearSnapshot: true });
      return;
    }

    if (_isDraftStatus(st) && action !== "modify") {
      items.push({
        productName: `${cur.name}`.trim(),
        color: cur.color,
        size: cur.size,
        qty: cur.qty,
        price: cur.price
      });

      deltaSum += _amountOf_(cur);
      hasNewItem = true;
      toFinalize.push({ el: p, nextStatus: "sent", clearAction: true, clearSnapshot: true });
      return;
    }

    if (st === "cancel_pending") {
      const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : cur;
      const oldAmt = _amountOf_(snap);
      const delta = -oldAmt;

      items.push({
        productName: `[ì·¨ì†Œ] ${cur.name}`.trim(),
        color: cur.color,
        size: cur.size,
        qty: 0,
        price: 0,
        amountDelta: delta
      });

      deltaSum += delta;
      toFinalize.push({ el: p, nextStatus: "canceled", clearAction: true, clearSnapshot: true });
      return;
    }
  });

  if (items.length === 0) {
    alert("ì „ì†¡ ëŒ€ê¸° / ì·¨ì†Œ ìš”ì²­ / ìˆ˜ì • ìš”ì²­ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  let shipping = 0;
  if (hasNewItem) {
    shipping = (deltaSum > 0 && deltaSum < 100000) ? SHIPPING : 0;
  } else {
    shipping = 0;
  }

  const payload = {
    orderId: ORDER_ID || newOrderId_(),
    orderTime: kstNowString(),
    customer: {
      nickname: document.getElementById("nickname").value || "",
      name: document.getElementById("name").value || "",
      phone: document.getElementById("phone").value || "",
      address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
    },
    items: items,
    sum: deltaSum,
    shipping: shipping,
    total: deltaSum + shipping
  };

  try {
    const body = JSON.stringify(payload);

    let sent = false;

    if (navigator.sendBeacon) {
      const blob = new Blob([body], { type: "text/plain;charset=UTF-8" });
      sent = navigator.sendBeacon(SCRIPT_URL, blob);
    }

    if (!sent) {
      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: body,
        keepalive: true
      });
    }

    toFinalize.forEach(x => {
      x.el.dataset.status = x.nextStatus;
      if (x.clearAction) {
        delete x.el.dataset.action;
        delete x.el.dataset.modifiedFrom;
      }
      if (x.clearSnapshot) {
        delete x.el.dataset.snapshot;
      }
      _applyProductUI(x.el);
    });

    calc();
    saveData();

    // âœ… ì „ì†¡ í›„ ëª¨ë“œ ì´ë™
    setMode("complete");

    alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  } catch (e) {
    alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
  }
}

/* âœ… ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼: ì „ì†¡ + ì£¼ë¬¸ì™„ë£Œ í™”ë©´ìœ¼ë¡œ ì´ë™ */
function orderNow(){
  submitOrder(); // ì „ì†¡ ì„±ê³µ ì‹œ setMode("complete")ë¡œ ì´ë™
}

/* âœ… ì™„ë£Œ í™”ë©´ -> ìˆ˜ì •/ì·¨ì†Œ ì§„ì… */
function enterEditMode(){
  setMode("edit");
}
function exitEditMode(){
  // ìˆ˜ì • í™”ë©´ì—ì„œ ë‚˜ê°€ê¸°: ì²´í¬ëœ sent_editëŠ” ì›ë³µ ì²˜ë¦¬(ì•ˆì „)
  document.querySelectorAll(".product").forEach(p=>{
    const st = p.dataset.status || "draft_edit";
    if (st === "sent_edit") {
      p.dataset.status = "sent";
      delete p.dataset.snapshot;
      _applyProductUI(p);
    }
  });
  calc();
  setMode("complete");
}

function enterCancelMode(){
  setMode("cancel");
}
function exitCancelMode(){
  // ì·¨ì†Œ í™”ë©´ì—ì„œ ë‚˜ê°€ê¸°: cancel_pending ì›ë³µ
  document.querySelectorAll(".product").forEach(p=>{
    const st = p.dataset.status || "draft_edit";
    if (st === "cancel_pending") {
      p.dataset.status = "sent";
      delete p.dataset.snapshot;
      _applyProductUI(p);
    }
  });
  calc();
  setMode("complete");
}

function newOrder() {
  if (!confirm("ìƒˆë¡œ ì£¼ë¬¸ì„ ì‹œì‘í• ê¹Œìš”?")) return;

  const data = JSON.parse(localStorage.getItem("orderData") || "{}");

  data.customer = data.customer || {
    nickname: document.getElementById("nickname").value,
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    addressDetail: document.getElementById("addressDetail").value
  };

  ORDER_ID = newOrderId_();
  data.orderId = ORDER_ID;

  data.products = [];
  data.mode = "create";
  localStorage.setItem("orderData", JSON.stringify(data));

  document.querySelectorAll(".product").forEach(p => p.remove());

  addProduct();
  calc();
  saveData();

  applyFoldVisibility();
  renderFoldSummary();

  setMode("create");
}

function saveData() {
  const data = {
    orderId: ORDER_ID,
    mode: MODE,
    customer: {
      nickname: document.getElementById("nickname").value,
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value,
      address: document.getElementById("address").value,
      addressDetail: document.getElementById("addressDetail").value
    },
    products: [],
    hideDone: HIDE_DONE
  };

  document.querySelectorAll(".product").forEach(p => {
    const i = p.querySelectorAll("input");
    data.products.push({
      id: p.dataset.id || _uid(),
      status: p.dataset.status || "draft_edit",
      origin: p.dataset.origin || "",
      action: p.dataset.action || "",
      modifiedFrom: p.dataset.modifiedFrom || "",
      snapshot: p.dataset.snapshot || "",
      name: i[0].value,
      color: i[1].value,
      size: i[2].value,
      qty: i[3].value,
      price: i[4].value
    });
  });

  localStorage.setItem("orderData", JSON.stringify(data));
}

function loadData() {
  const data = JSON.parse(localStorage.getItem("orderData") || "null");
  if (!data) {
    ORDER_ID = newOrderId_();
    saveData();
    setMode("create");
    return;
  }

  IS_LOADING = true;

  ORDER_ID = data.orderId || newOrderId_();

  document.getElementById("nickname").value = (data.customer && data.customer.nickname) ? data.customer.nickname : "";
  document.getElementById("name").value = (data.customer && data.customer.name) ? data.customer.name : "";
  document.getElementById("phone").value = (data.customer && data.customer.phone) ? data.customer.phone : "";
  document.getElementById("address").value = (data.customer && data.customer.address) ? data.customer.address : "";
  document.getElementById("addressDetail").value = (data.customer && data.customer.addressDetail) ? data.customer.addressDetail : "";

  productsDiv.innerHTML = "";

  (data.products || []).forEach(p => {
    const preset = {
      id: p.id || _uid(),
      status: p.status || "draft_edit",
      origin: p.origin || "",
      action: p.action || "",
      modifiedFrom: p.modifiedFrom || "",
      snapshot: p.snapshot || "",
      name: p.name,
      color: p.color,
      size: p.size,
      qty: p.qty,
      price: p.price
    };
    addProduct(preset, true);
  });

  HIDE_DONE = !!data.hideDone;
  const btn = document.querySelector('button[onclick="toggleFold()"]');
  if (btn) btn.innerText = HIDE_DONE ? "ì™„ë£Œëª©ë¡ í¼ì¹˜ê¸° â–¼" : "ì™„ë£Œëª©ë¡ ì ‘ê¸° â–²";

  calc();
  applyFoldVisibility();
  renderFoldSummary();

  IS_LOADING = false;

  // âœ… ëª¨ë“œ ë³µêµ¬
  const m = data.mode || "create";
  setMode(m);

  saveData();
}

["nickname","name","phone","addressDetail"].forEach(id=>{
  document.getElementById(id).addEventListener("input", saveData);
});

loadData();
if (!document.querySelector(".product")) addProduct();
</script>

</body>
</html>