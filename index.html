<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>셀프정산 주문서</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-top: 30px; }
  .form-group { margin-bottom: 10px; }
  label { display: block; font-weight: bold; margin-bottom: 3px; }
  input { padding: 6px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
  .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  .product .form-group { margin-bottom: 5px; }
  .buttons { margin-top: 20px; }
  button { margin-right: 10px; padding: 8px 12px; cursor: pointer; }
  #orderModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #orderModalContent { background:white; padding:20px; max-width:500px; width:90%; max-height:80%; overflow:auto; border-radius:5px; }
</style>
</head>
<body>

<h2>고객 정보</h2>
<div class="form-group"><label>닉네임</label><input id="nickname" placeholder="닉네임"></div>
<div class="form-group"><label>이름</label><input id="name" placeholder="이름"></div>
<div class="form-group"><label>연락처</label><input id="phone" placeholder="010-1234-5678"></div>
<div class="form-group"><label>주소</label><input id="address" placeholder="주소"></div>

<h2>상품 목록</h2>
<div>
  <button onclick="addProduct()">+ 상품 추가</button>
  <button onclick="deleteAllProducts()" style="background:red; color:white;">상품목록 모두 삭제</button>
</div>
<div id="products"></div>

<h3>총 결제금액: <span id="totalAmount">0</span>원</h3>
<p>입금계좌: 카카오뱅크 3333-09797-1111 유혜정(유세연)
<button onclick="copyAccount()">복사</button></p>

<div class="buttons">
  <button onclick="checkOrder()">주문서 확인</button>
  <button onclick="submitOrderDirect()">주문 완료</button>
  <button onclick="newOrder()">새 주문</button>
</div>

<!-- 주문서 확인 모달 -->
<div id="orderModal">
  <div id="orderModalContent">
    <h2>주문서 확인</h2>
    <div id="orderSummary"></div>
    <button onclick="editOrder()" style="background:gray; color:white;">수정</button>
    <button onclick="submitOrder()" style="background:blue; color:white;">주문 완료</button>
    <button onclick="closeModal()">닫기</button>
  </div>
</div>

<script>
const productsDiv = document.getElementById("products");
const totalAmountEl = document.getElementById("totalAmount");
const SHIPPING = 4000;

function addProduct(data={}) {
  const div = document.createElement("div");
  div.className = "product";
  div.innerHTML = `
    <div class="form-group"><label>상품명</label><input class="name" value="${data.name||''}" placeholder="상품명"></div>
    <div class="form-group"><label>색상</label><input class="color" value="${data.color||''}" placeholder="색상"></div>
    <div class="form-group"><label>사이즈</label><input class="size" value="${data.size||''}" placeholder="사이즈"></div>
    <div class="form-group"><label>수량</label><input type="number" class="qty" min="1" value="${data.qty||1}"></div>
    <div class="form-group"><label>가격</label><input type="number" class="price" min="0" value="${data.price||0}"></div>
    <button onclick="removeProduct(this)">삭제</button>
  `;
  div.querySelectorAll("input").forEach(i=>i.addEventListener("input", calculateTotal));
  productsDiv.appendChild(div);
  calculateTotal();
}

function removeProduct(btn){ btn.parentElement.remove(); calculateTotal(); }

function deleteAllProducts(){
  if(confirm("상품목록을 모두 삭제하시겠습니까?")){
    productsDiv.innerHTML = "";
    calculateTotal();
  }
}

function getProductsArray(){
  const arr=[];
  document.querySelectorAll(".product").forEach(p=>{
    arr.push({
      name: p.querySelector(".name").value,
      color: p.querySelector(".color").value,
      size: p.querySelector(".size").value,
      qty: Number(p.querySelector(".qty").value),
      price: Number(p.querySelector(".price").value)
    });
  });
  return arr;
}

function calculateTotal(){
  let sum=0;
  getProductsArray().forEach(p=>{ sum += p.qty * p.price; });
  const shipping = sum >= 100000 || sum===0 ? 0 : SHIPPING;
  totalAmountEl.textContent = (sum+shipping).toLocaleString();
  return sum+shipping;
}

function copyAccount(){
  navigator.clipboard.writeText("카카오뱅크 3333-09797-1111 유혜정(유세연)");
  alert("계좌번호가 복사되었습니다.");
}

function validateOrder(){
  if(!document.getElementById("nickname").value || !document.getElementById("name").value || !document.getElementById("phone").value){
    alert("고객 정보를 모두 입력해주세요."); return false;
  }
  const products = getProductsArray();
  if(products.length===0){ alert("상품을 하나 이상 추가해주세요."); return false; }
  for(let p of products){
    if(!p.name || !p.qty || !p.price){ alert("상품명, 수량, 가격을 모두 입력해주세요."); return false; }
  }
  return true;
}

// 주문서 확인
function checkOrder(){
  if(!validateOrder()) return;
  let html=`<p>닉네임: ${document.getElementById("nickname").value}</p>
  <p>이름: ${document.getElementById("name").value}</p>
  <p>연락처: ${document.getElementById("phone").value}</p>
  <p>주소: ${document.getElementById("address").value}</p>
  <h3>상품 목록</h3><ul>`;
  getProductsArray().forEach((p,i)=>{
    html+=`<li>${i+1}. ${p.name} / ${p.color} / ${p.size} / ${p.qty}개 / ${p.price}원</li>`;
  });
  html+=`</ul><p>총 결제금액: ${totalAmountEl.textContent}원</p>
  <p>입금계좌: 카카오뱅크 3333-09797-1111 유혜정(유세연)</p>`;
  document.getElementById("orderSummary").innerHTML = html;
  document.getElementById("orderModal").style.display = "flex";
}

function closeModal(){ document.getElementById("orderModal").style.display="none"; }
function editOrder(){ closeModal(); }

// 주문 완료 (모달에서)
function submitOrder(){
  if(!confirm("주문을 완료하시겠습니까?")) return;
  sendOrderData();
  closeModal();
}

// 주문 완료 (바로)
function submitOrderDirect(){
  if(!confirm("주문을 완료하시겠습니까?")) return;
  sendOrderData();
}

function sendOrderData(){
  const data={
    nickname: document.getElementById("nickname").value,
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    total: Number(totalAmountEl.textContent.replace(/,/g,'')),
    shipping: Number(totalAmountEl.textContent.replace(/,/g,'')) - getProductsArray().reduce((a,p)=>a+p.qty*p.price,0),
    products: getProductsArray()
  };
  fetch("https://script.google.com/macros/s/AKfycby46Q9iopmJHmsh37thoaJ1fJGlm3gWHjc2W0sVm84Ue9q0W31CyFR3KAd69qBqySXk/exec",{
    method:"POST",
    body: JSON.stringify(data)
  }).then(r=>r.json()).then(r=>{
    if(r.status==="success"){ alert("주문이 정상적으로 전송되었습니다!"); }
    else{ alert("주문 전송 실패: "+r.message); }
  }).catch(e=>alert("주문 전송 실패"));
}

// 새 주문
function newOrder(){
  if(confirm("새 주문을 시작하면 현재 입력한 내용은 모두 초기화됩니다.")){
    location.reload();
  }
}

window.onload=()=>{ addProduct(); calculateTotal(); }
</script>

</body>
</html>
