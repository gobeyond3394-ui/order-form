<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>셀프 정산 주문서</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  h1, h2 { margin-top: 20px; }
  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 10px;
  }
  label {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 2px;
  }
  input {
    padding: 6px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
  }
  .product {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  .product .form-group {
    flex: 1 1 120px;
  }
  .price {
    width: 100px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  button { padding: 5px; cursor: pointer; margin-top:5px; }
  .product-buttons { margin-bottom: 10px; }
</style>
</head>
<body>

<h1>셀프 정산 주문서</h1>

<h2>고객 정보</h2>
<div class="form-group">
  <label for="nickname">닉네임</label>
  <input id="nickname" type="text" placeholder="닉네임">
</div>
<div class="form-group">
  <label for="name">이름</label>
  <input id="name" type="text" placeholder="이름">
</div>
<div class="form-group">
  <label for="phone">연락처</label>
  <input id="phone" type="text" placeholder="010-1234-5678">
</div>
<div class="form-group">
  <label for="address">주소</label>
  <input id="address" type="text" placeholder="주소">
</div>

<hr>

<h2>상품 목록</h2>

<div class="product-buttons">
  <button onclick="addProduct()">+ 상품 추가</button>
  <button onclick="removeAllProducts()" style="margin-left:10px; background-color:red; color:white;">상품목록 모두 삭제</button>
</div>

<div id="productList"></div>

<hr>
<p>상품 합계: <strong id="productSum">0</strong> KRW</p>
<p>배송비: <strong id="shippingFee">4000</strong> KRW</p>
<h2 style="color: blue;">총 결제금액: <span id="finalTotal">0</span> KRW</h2>

<div style="margin-top: 20px;">
  <button onclick="submitOrder()" style="background-color:blue; color:white; padding:8px 15px;">주문 완료</button>
</div>

<div id="orderMessage" style="display:none; color:green; font-weight:bold; margin-top:20px;">
  주문이 완료되었습니다!
</div>

<script>
const productList = document.getElementById("productList");
const productSumEl = document.getElementById("productSum");
const shippingFeeEl = document.getElementById("shippingFee");
const finalTotalEl = document.getElementById("finalTotal");

// 데이터 저장
function saveData() {
  const data = {
    nickname: document.getElementById("nickname").value,
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    products: []
  };
  document.querySelectorAll(".product").forEach(p => {
    data.products.push({
      name: p.querySelector(".name").value,
      color: p.querySelector(".color").value,
      size: p.querySelector(".size").value,
      price: p.querySelector(".priceInput").value,
      qty: p.querySelector(".qtyInput").value
    });
  });
  localStorage.setItem("orderData", JSON.stringify(data));
}

// 데이터 불러오기
function loadData() {
  const data = JSON.parse(localStorage.getItem("orderData")) || {};
  document.getElementById("nickname").value = data.nickname || "";
  document.getElementById("name").value = data.name || "";
  document.getElementById("phone").value = data.phone || "";
  document.getElementById("address").value = data.address || "";
  productList.innerHTML = "";
  if (data.products && data.products.length > 0) {
    data.products.forEach(p => addProduct(p));
  } else {
    addProduct();
  }
}

// 상품 추가
function addProduct(data = {}) {
  const div = document.createElement("div");
  div.className = "product";
  div.innerHTML = `
    <div class="form-group">
      <label>상품명</label>
      <input class="name" placeholder="상품명" value="${data.name || ''}">
    </div>
    <div class="form-group">
      <label>색상</label>
      <input class="color" placeholder="색상" value="${data.color || ''}">
    </div>
    <div class="form-group">
      <label>사이즈</label>
      <input class="size" placeholder="사이즈" value="${data.size || ''}">
    </div>
    <div class="form-group">
      <label>수량</label>
      <input type="number" class="qtyInput" value="${data.qty || 1}" min="1">
    </div>
    <div class="form-group">
      <label>가격</label>
      <input type="number" class="priceInput" placeholder="가격" value="${data.price || ''}">
    </div>
    <button onclick="removeProduct(this)">삭제</button>
    <span class="price">0 KRW</span>
  `;
  productList.appendChild(div);
  div.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", () => {
      calculate();
      saveData();
    });
  });
  calculate();
}

// 상품 삭제
function removeProduct(btn) {
  btn.parentElement.remove();
  calculate();
  saveData();
}

// 상품목록 모두 삭제
function removeAllProducts() {
  if(!confirm("상품목록을 모두 삭제하시겠습니까?")) return;
  productList.innerHTML = "";
  addProduct(); // 최소 한 개 상품 입력란 유지
  calculate();
  saveData();
}

// 계산
function calculate() {
  let sum = 0;
  document.querySelectorAll(".product").forEach(product => {
    const price = Number(product.querySelector(".priceInput").value) || 0;
    const qty = Number(product.querySelector(".qtyInput").value) || 0;
    const total = price * qty;
    product.querySelector(".price").textContent = total.toLocaleString() + " KRW";
    sum += total;
  });
  const shipping = sum >= 100000 ? 0 : 4000;
  const finalTotal = sum + shipping;
  productSumEl.textContent = sum.toLocaleString();
  shippingFeeEl.textContent = shipping.toLocaleString();
  finalTotalEl.textContent = finalTotal.toLocaleString();
}

// 주문 완료
function submitOrder() {
  if(!confirm("주문을 완료하시겠습니까?")) return;
  const data = JSON.parse(localStorage.getItem("orderData")) || {};

  // fetch("여기에_AppsScript_URL_붙여넣기") // 실제 연동 시 Apps Script URL 넣기

  // 테스트용: 바로 alert + 상품 초기화
  alert("주문이 완료되었습니다!");
  data.products = [];
  localStorage.setItem("orderData", JSON.stringify(data));
  calculate();
  document.getElementById("orderMessage").style.display = "block";
}

// 초기화
window.onload = () => {
  loadData();
  document.querySelectorAll("input").forEach(i => i.addEventListener("input", saveData));
}
</script>
</body>
</html>
