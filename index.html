<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì‹¸U ë¼ì´ë¸Œ ì£¼ë¬¸ ğŸ”´ LIVE</title>

<style>
  body{
    margin:0; padding:16px;
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    background:#fff; color:#111;
  }
  h1{ text-align:center; font-size:20px; margin:0 0 12px; color:#005FAE; }

  /* âœ… ë¼ë²¨/ìš”ì•½/ê³„ì¢Œ/í•©ê³„ */
  label{ font-weight:800; font-size:15px; }
  .summary-line{ font-size:14px; display:flex; justify-content:space-between; }
  .summary-line span{ font-weight:900; }
  .account-text{ font-weight:900; font-size:14px; flex:1; }
  input{ font-weight:400; font-size:15px; }
  input::placeholder{ color:#999; font-weight:500; }

  button{
    padding:12px 14px;
    font-size:14px;
    font-weight:900;
    border-radius:8px;
    border:none;
    cursor:pointer;
    transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
    -webkit-tap-highlight-color: transparent;
  }
  button:active{ transform: scale(0.98); filter: brightness(0.96); }
  button:focus-visible{
    outline: 3px solid rgba(0,95,174,.25);
    outline-offset: 2px;
  }

  /* âœ… ì™„ë£Œ ë°°ë„ˆ */
  .mode-banner{
    display:none;
    text-align:center;
    padding:10px 12px;
    border-radius:10px;
    font-weight:900;
    margin:0 auto 14px;
    max-width:560px;
    outline:none;
    line-height:1.35;
  }
  .mode-banner .banner-main{
    color:#005FAE;
    font-weight:900;
    font-size:15px;
  }
  .mode-banner .banner-oid{
    margin-top:6px;
    color:#111;
    font-weight:400; /* âœ… ê²€ì •ìƒ‰, ì§„í•˜ì§€ ì•Šê²Œ */
    font-size:13px;
  }
  body.mode-complete .mode-banner{
    display:block;
    background:#e8f2ff;
    border:1px solid #c8ddff;
  }
  body.mode-complete h1{ display:none; }

  .section{ margin-bottom:28px; }
  .section-title{ font-size:15px; font-weight:800; margin-bottom:10px; color:#005FAE; }
  .divider{ border-top:1px solid #eee; margin:12px 0 16px; }
  .field{ margin-bottom:12px; }

  input{
    width:100%;
    padding:12px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
  }

  .address-row{ display:flex; gap:8px; }
  .address-row input{ flex:1; }
  .addr-btn{
    background:#005FAE; color:#fff;
    border:none;
    border-radius:8px;
    padding:12px 14px;
    font-size:14px;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
  }

  /* âœ… ë°°ì†¡ì§€ ìš”ì•½(ì™„ë£Œ í™”ë©´ì—ì„œ í‘œì‹œ) */
  #shipSummary{
    display:none;
    background:#f7f7f7;
    border:1px solid #e5e5e5;
    border-radius:10px;
    padding:12px;
    font-size:14px;
    line-height:1.55;
    font-weight:800;
  }
  body.mode-complete #shipSummary{ display:block; }
  body.mode-complete #customerFormFields{ display:none; }

  .ship-actions{
    display:none;
    gap:8px;
    margin-top:10px;
  }
  body.mode-complete .ship-actions{ display:flex; }

  .btn-mini{
    padding:10px 10px;
    font-size:13px;
    font-weight:900;
    border-radius:10px;
    border:none;
    cursor:pointer;
  }
  .btn-gray{ background:#e0e0e0; color:#111; }
  .btn-blue{ background:#005FAE; color:#fff; }
  .btn-red{ background:#e74c3c; color:#fff; }

  .product{
    border-top:1px solid #eee;
    padding-top:12px;
    margin-top:12px;
  }

  .row{ display:flex; gap:8px; }
  .row .field{ flex:1; }

  .button-line-3{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:12px;
  }
  .button-line-3 button{
    flex:0 0 calc((100% - 16px)/3);
    max-width:calc((100% - 16px)/3);
    white-space:nowrap;
  }
  .button-line-2{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:10px;
  }
  .button-line-2 button{
    flex:0 0 calc((100% - 8px)/2);
    max-width:calc((100% - 8px)/2);
    white-space:nowrap;
  }

  .btn-check{ background:#E0E0E0; color:#333; }
  .btn-order{ background:#005FAE; color:#fff; }
  .btn-add{ background:#005FAE; color:#fff; }
  .btn-delete{ background:#e74c3c; color:#fff; }

  .btn-edit-go{
    background:#fff7e6;
    color:#9a6b00;
    border:1px solid #ffe1a6;
    font-weight:900;
  }
  .btn-cancel-do{
    background:#fff;
    color:#e74c3c;
    border:1px solid #e74c3c;
    font-weight:900;
  }
  .btn-add-order{ background:#005FAE; color:#fff; font-weight:900; }

  .account-box{
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:#f4f7ff;
    border:1px solid #d6e0ff;
    border-radius:8px;
    padding:10px;
    gap:8px;
  }
  .copy-btn{
    background:#005FAE;
    color:#fff;
    font-size:12px;
    font-weight:900;
    padding:6px 10px;
    border-radius:6px;
    border:none;
  }

  /* âœ… ì…ê¸ˆí™•ì¸ ë¬¸êµ¬(ê³„ì¢Œ ì•„ë˜) */
  .pay-note{
    margin-top:8px;
    font-size:13px;
    font-weight:900;
    color:#c0392b;
    line-height:1.4;
  }

  .product-title-row{ display:flex; align-items:center; gap:8px; }
  .product-title-row input{ flex:1; }

  .status-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:900;
    padding:6px 10px;
    border-radius:6px;
    white-space:nowrap;
    user-select:none;
  }
  .status-badge .sq{ width:10px; height:10px; border-radius:2px; display:inline-block; }

  .status-sent{ background:#e8f2ff; color:#005FAE; border:1px solid #c8ddff; }
  .status-sent .sq{ background:#005FAE; }

  .status-modified{ background:#fff7e6; color:#9a6b00; border:1px solid #ffe1a6; }
  .status-modified .sq{ background:#9a6b00; }

  /* âœ… ë°œì†¡ì™„ë£Œ ë°°ì§€ */
  .status-shipped{ background:#e8fff1; color:#1e7e34; border:1px solid #bfead0; }
  .status-shipped .sq{ background:#1e7e34; }

  /* âœ… ì·¨ì†Œ ì™„ë£Œ ë°°ì§€: ë¹¨ê°„ìƒ‰ í†µì¼ */
  .status-canceled{ background:#ffe9e9; color:#c0392b; border:1px solid #ffc9c9; }
  .status-canceled .sq{ background:#e74c3c; }

  /* âœ… ìˆ˜ì •ì¤‘ ë°°ì§€(ê·¸ë ˆì´) */
  .status-editing{ background:#ededed; color:#333; border:1px solid #cfcfcf; }
  .status-editing .sq{ background:#777; }

  #doneSummary{
    display:none;
    font-size:13px;
    color:#333;
    background:#f7f9ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    padding:10px;
    margin:6px 0 10px;
    line-height:1.55;
    font-weight:900;
  }
  body.mode-form #doneSummary{ display:block; }
  body.mode-complete #doneSummary{ display:block; }

  .edit-row{ display:none; margin-top:10px; gap:8px; justify-content:flex-end; }
  .edit-row button{ padding:10px 12px; font-size:13px; border-radius:10px; }

  .product.is-locked input{
    background:#f2f2f2 !important;
    color:#777 !important;
    border-color:#ddd !important;
  }
  .product.is-locked input::placeholder{ color:#aaa !important; }
  .product.is-locked input:disabled{
    background:#f2f2f2 !important;
    color:#777 !important;
    -webkit-text-fill-color:#777 !important;
    opacity:1 !important;
  }

  .summary{ border-top:1px solid #eee; padding-top:14px; }
  .summary-total{ font-weight:900; font-size:16px; color:#005FAE; }

  body.mode-complete .form-product-controls{ display:none !important; }

  .half-center-line{
    display:flex;
    justify-content:center;
    margin-top:10px;
  }
  .half-center-line button{
    width:50%;
    max-width:280px;
  }

  #formControls{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }
  #formControls .button-line-3{ margin-top:0; }
  #formControls .half-center-line{ margin-top:0; }

  /* âœ… ì£¼ë¬¸ìƒì„¸ ë³´ê¸°/ë‹«ê¸° ë²„íŠ¼(ì™„ë£Œí™”ë©´ ì „ìš©) */
  #detailToggleWrap{ display:none; }
  body.mode-complete #detailToggleWrap{ display:block; }

  .small-link-btn{
    width:100%;
    margin-top:10px;
    background:#fff;
    border:1px solid #ddd;
    color:#333;
    font-weight:900;
  }
  .detail-note{
    margin-top:6px;
    font-size:12px;
    font-weight:900;
    color:#666;
    line-height:1.3;
  }

  /* âœ… ê°œë³„ ì·¨ì†Œ ë²„íŠ¼ ì¤„ */
  .cancel-row{
    margin-top:10px;
    display:none;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  body.mode-complete .cancel-row{ display:flex; }

  .btn-item-cancel{
    background:#e74c3c;
    color:#fff;
    font-weight:900;
    border:none;
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
  }
  .btn-item-cancel:disabled{
    opacity:.55;
    cursor:not-allowed;
  }
</style>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="mode-form">
<h1>ì‹¸U ë¼ì´ë¸Œ ì£¼ë¬¸ ğŸ”´ LIVE</h1>

<div class="mode-banner" id="modeBanner" tabindex="-1">
  <div class="banner-main">ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
  <div class="banner-oid"></div>
</div>

<div class="section">
  <div class="section-title" id="customerSectionTitle">ê³ ê° ì •ë³´</div>
  <div class="divider"></div>

  <div id="shipSummary"></div>

  <div class="ship-actions" id="shipActions" style="display:none;">
    <button class="btn-mini btn-edit-go" type="button" onclick="enterShipEdit()">ë°°ì†¡ì§€ ìˆ˜ì •</button>
  </div>

  <div id="customerFormFields">
    <div class="field">
      <label>ë‹‰ë„¤ì„</label>
      <input id="nickname" placeholder="ì˜ˆ) GOë¹„ìš˜ë“œ">
    </div>
    <div class="field">
      <label>ì´ë¦„</label>
      <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™">
    </div>
    <div class="field">
      <label>ì—°ë½ì²˜</label>
      <input id="phone" placeholder="ì˜ˆ) 010-1234-5678">
    </div>
    <div class="field">
      <label>ì£¼ì†Œ</label>
      <div class="address-row">
        <input id="address" placeholder="ì£¼ì†Œê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" readonly>
        <button class="addr-btn" type="button" onclick="searchAddress()">ì£¼ì†Œê²€ìƒ‰</button>
      </div>
    </div>
    <div class="field">
      <label>ìƒì„¸ì£¼ì†Œ</label>
      <input id="addressDetail" placeholder="ì˜ˆ) 101ë™ 1203í˜¸">
    </div>

    <div class="button-line-2" id="shipEditControls" style="display:none;">
      <button class="btn-blue" type="button" onclick="saveShipEdit()">ë°°ì†¡ì§€ ì €ì¥</button>
      <button class="btn-mini btn-gray" type="button" onclick="cancelShipEdit()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title" id="productSectionTitle">ìƒí’ˆ ì •ë³´</div>

  <div id="doneSummary"></div>

  <!-- âœ… ì™„ë£Œí™”ë©´ì—ì„œë§Œ: ì£¼ë¬¸ìƒì„¸ ë³´ê¸°/ë‹«ê¸° -->
  <div id="detailToggleWrap">
    <button class="small-link-btn" id="detailToggleBtn" type="button" onclick="toggleOrderDetail()">ì£¼ë¬¸ìƒì„¸ ë³´ê¸° â–¼</button>
    <div class="detail-note">â€» ì£¼ë¬¸ ìƒì„¸ì—ì„œ ìˆ˜ì • / ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  </div>

  <div id="products"></div>

  <div class="form-product-controls">
    <div class="button-line-2">
      <button class="btn-add" type="button" onclick="addProduct()">+ ìƒí’ˆ ì¶”ê°€</button>
      <button class="btn-delete" type="button" onclick="removeLastProduct()">- ìƒí’ˆ ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="section summary" id="summarySection">
  <div class="summary-line"><span>ìƒí’ˆ í•©ê³„</span><span id="sum">0ì›</span></div>
  <div class="summary-line"><span>ë°°ì†¡ë¹„</span><span id="shipping">4,000ì›</span></div>
  <div class="summary-line summary-total"><span>ì´ ê²°ì œê¸ˆì•¡</span><span id="total">4,000ì›</span></div>
</div>

<div class="section">
  <div class="section-title">ì…ê¸ˆ ê³„ì¢Œ</div>
  <div class="account-box">
    <div class="account-text" id="accountText">ì¹´ì¹´ì˜¤ë±…í¬ 3333-09797-1111 ìœ í˜œì •(ìœ ì„¸ì—°)</div>
    <button class="copy-btn" type="button" onclick="copyAccount()">ë³µì‚¬</button>
  </div>
  <div class="pay-note" id="payNoteBelow">âš ï¸ ì…ê¸ˆ í™•ì¸ í›„ ìƒí’ˆì´ ë°œì†¡ë©ë‹ˆë‹¤.</div>
</div>

<!-- âœ… ì£¼ë¬¸ ì…ë ¥ í™”ë©´ í•˜ë‹¨ ë²„íŠ¼ ìˆœì„œ ë³€ê²½ -->
<div id="formControls">
  <div class="button-line-3">
    <button class="btn-check" type="button" onclick="checkOrder()">ì£¼ë¬¸ë‚´ìš©í™•ì¸</button>
    <button class="btn-order" type="button" onclick="submitOrder()">ì£¼ë¬¸í•˜ê¸°</button>
    <button class="btn-cancel-do" type="button" onclick="goCompletePreview()">ì£¼ë¬¸ì ‘ìˆ˜ê²°ê³¼ ë‹¤ì‹œë³´ê¸°</button>
  </div>
  <div class="half-center-line">
    <button class="btn-red" type="button" onclick="newOrder()">ìƒˆë¡œ ì£¼ë¬¸í•˜ê¸°</button>
  </div>
</div>

<!-- âœ… ì™„ë£Œ í™”ë©´ í•˜ë‹¨ ë²„íŠ¼ ìˆœì„œ ë³€ê²½ -->
<div class="button-line-3" id="completeControls" style="display:none;">
  <button class="btn-gray" type="button" onclick="showOrderHistory()">ì£¼ë¬¸í™•ì¸ì„œ ë³´ê¸°</button>
  <button class="btn-cancel-do" type="button" onclick="submitCancel()">ì·¨ì†Œí•˜ê¸°</button>
  <button class="btn-add-order" type="button" onclick="goToFormForAdd()">ì¶”ê°€ ì£¼ë¬¸í•˜ê¸°</button>
</div>

<div class="half-center-line" id="completeHalfNew" style="display:none;">
  <button class="btn-red" type="button" onclick="newOrder()">ìƒˆë¡œ ì£¼ë¬¸í•˜ê¸°</button>
</div>

<script>
  const SHIPPING = 4000;
  const productsDiv = document.getElementById("products");

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypKfZsjR0uu9Lcc7OirR2tiyjIzzLwREGd3Bw3szXmLVIHHNGhwlmoOdRaInh2xebf/exec";

  const PAY_NOTICE = "âš ï¸ ì…ê¸ˆ í™•ì¸ í›„ ìƒí’ˆì´ ë°œì†¡ë©ë‹ˆë‹¤.";

  let IS_LOADING = false;

  // âœ… ì£¼ë¬¸ìƒì„¸(ì™„ë£Œí™”ë©´) ì ‘ê¸°/í¼ì¹˜ê¸°
  let ORDER_DETAIL_OPEN = false;

  // âœ… ê³ ê°ì´ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ” ì´ìƒ, ê¸°í•œ ì—†ì´ ì €ì¥ (customerëŠ” ë³„ë„ ë³´ê´€)
  const LS_CUSTOMER_KEY = "orderCustomer";
  const LS_ORDER_KEY = "orderData";
  const ORDER_TTL_MS = 5 * 24 * 60 * 60 * 1000; // 5ì¼

  // âœ… ì£¼ë¬¸ IDëŠ” (ì£¼ë¬¸ ë°°ì¹˜ ë‹¨ìœ„)ë¡œ ì‚¬ìš©
  let ACTIVE_DRAFT_ORDER_ID = "";
  let LAST_DONE_ORDER_ID = "";

  function newOrderId_(){
    return "oid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }
  function ensureDraftOrderId_(){
    if (!ACTIVE_DRAFT_ORDER_ID) ACTIVE_DRAFT_ORDER_ID = newOrderId_();
    return ACTIVE_DRAFT_ORDER_ID;
  }

  let MODE = "form"; // form | complete

  let SHIP_EDITING = false;
  let SHIP_SNAPSHOT = null;

  function hasAnyDoneItems_(){
    return Array.from(document.querySelectorAll(".product")).some(p=>{
      const st = p.dataset.status || "draft";
      return (st === "sent" || st === "modified" || st === "canceled" || st === "shipped");
    });
  }

  function setBanner(text){
    const banner = document.getElementById("modeBanner");
    if (!banner) return;

    const main = banner.querySelector(".banner-main");
    const oidBox = banner.querySelector(".banner-oid");

    if (main) main.textContent = text || "";

    const oid = (LAST_DONE_ORDER_ID || "").trim();
    if (oidBox){
      oidBox.textContent = oid ? `ì£¼ë¬¸ë²ˆí˜¸ëŠ” ${oid} ì…ë‹ˆë‹¤.` : "";
    }
  }

  function focusBanner(){
    const banner = document.getElementById("modeBanner");
    if (!banner) return;
    banner.scrollIntoView({ behavior:"smooth", block:"start" });
    setTimeout(()=>banner.focus(), 250);
  }

  function goCompletePreview(){
    if (!hasAnyDoneItems_()){
      alert("ì£¼ë¬¸ ì ‘ìˆ˜ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    setMode("complete", "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.", { detailClosedOnEnter:true });
  }

  function copyAccount(){
    const text = accountText.innerText;
    const accountNumberOnly = text.replace(/[^0-9]/g, "");
    navigator.clipboard.writeText(accountNumberOnly);
    alert("ê³„ì¢Œë²ˆí˜¸ë§Œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function searchAddress(){
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById("address").value = data.address;
        document.getElementById("addressDetail").focus();
        saveData();
      }
    }).open();
  }

  function _uid(){
    return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  function _fmtMoney_(v){
    const n = Number(v || 0);
    return n.toLocaleString() + "ì›";
  }

  function snapshotCustomer(){
    return {
      nickname: document.getElementById("nickname").value || "",
      name: document.getElementById("name").value || "",
      phone: document.getElementById("phone").value || "",
      address: document.getElementById("address").value || "",
      addressDetail: document.getElementById("addressDetail").value || ""
    };
  }

  function renderShippingSummary(){
    const box = document.getElementById("shipSummary");
    if (!box) return;

    const c = snapshotCustomer();
    const fullAddr = `${(c.address||"").trim()} ${(c.addressDetail||"").trim()}`.trim();

    box.innerHTML = `
      <div>ë‹‰ë„¤ì„: <b>${(c.nickname||"-")}</b></div>
      <div>ìˆ˜ë ¹ì¸: <b>${(c.name||"-")}</b></div>
      <div>ì—°ë½ì²˜: <b>${(c.phone||"-")}</b></div>
      <div style="margin-top:6px;">ì£¼ì†Œ: <b>${fullAddr || "-"}</b></div>
    `;
  }

  function lockProductInputs(div, lock){
    const inputs = div.querySelectorAll("input");
    for (let k=0;k<5;k++){
      if (!inputs[k]) continue;
      inputs[k].readOnly = lock;
      inputs[k].disabled = lock;
    }
    if (lock) div.classList.add("is-locked");
    else div.classList.remove("is-locked");
  }

  function updateDetailToggleUI_(){
    const btn = document.getElementById("detailToggleBtn");
    if (!btn) return;
    btn.textContent = ORDER_DETAIL_OPEN ? "ì£¼ë¬¸ìƒì„¸ ë‹«ê¸° â–²" : "ì£¼ë¬¸ìƒì„¸ ë³´ê¸° â–¼";
  }

  function applyProductVisibility_(){
    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";

      // âœ… ì™„ë£Œí™”ë©´: ì£¼ë¬¸ìƒì„¸ ì—´ì—ˆì„ ë•Œë§Œ ì™„ë£Œìƒí’ˆ ì¹´ë“œ ë³´ì´ê¸°
      if (MODE === "complete"){
        if (st === "draft"){
          p.style.display = "none";
          return;
        }
        p.style.display = ORDER_DETAIL_OPEN ? "block" : "none";
        return;
      }

      // âœ… ì…ë ¥í™”ë©´: ì‘ì„±ì¤‘(draft)ë§Œ ì¹´ë“œë¡œ ë³´ì´ê¸°, ì™„ë£Œ/ìˆ˜ì •/ì·¨ì†ŒëŠ” ìš”ì•½(#doneSummary)ë¡œë§Œ ë³´ì—¬ì¤Œ
      if (st === "draft"){
        p.style.display = "block";
      } else {
        p.style.display = "none";
      }
    });

    updateDetailToggleUI_();
  }

  function toggleOrderDetail(){
    if (MODE !== "complete") return;
    ORDER_DETAIL_OPEN = !ORDER_DETAIL_OPEN;
    applyProductVisibility_();
    saveData();
  }

  function setMode(mode, bannerText, opts){
    opts = opts || {};

    if (mode === "complete" && !opts.allowEmpty && !hasAnyDoneItems_()){
      alert("ì£¼ë¬¸ ì ‘ìˆ˜ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    MODE = mode;

    document.body.classList.remove("mode-form","mode-complete");
    document.body.classList.add("mode-" + MODE);

    const formControls = document.getElementById("formControls");
    const completeControls = document.getElementById("completeControls");
    const completeHalfNew = document.getElementById("completeHalfNew");
    const shipActions = document.getElementById("shipActions");

    const customerTitle = document.getElementById("customerSectionTitle");
    const productTitle = document.getElementById("productSectionTitle");

    if (MODE === "complete"){
      formControls.style.display = "none";
      completeControls.style.display = "flex";
      completeHalfNew.style.display = "flex";
      shipActions.style.display = "flex";

      if (customerTitle) customerTitle.textContent = "ë°°ì†¡ì§€ ì •ë³´";
      if (productTitle) productTitle.textContent = "ì£¼ë¬¸ ìƒí’ˆ ì •ë³´";

      setBanner(bannerText || "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");

      if (opts.detailClosedOnEnter === true) ORDER_DETAIL_OPEN = false;

      exitShipEdit(true);

      renderShippingSummary();
      renderDoneSummary();

      // âœ… ë°œì†¡ì™„ë£Œ ìë™ ë°˜ì˜
      updateShippingStatuses_(true);

      document.querySelectorAll(".product").forEach(p=>{
        const isEditing = (p.dataset.editing === "1");
        lockProductInputs(p, !isEditing);
        setBadge(p);
      });

      applyProductVisibility_();
      calc();
      saveData();
      setTimeout(focusBanner, 50);
      return;
    }

    formControls.style.display = "flex";
    completeControls.style.display = "none";
    completeHalfNew.style.display = "none";
    shipActions.style.display = "none";

    if (customerTitle) customerTitle.textContent = "ê³ ê° ì •ë³´";
    if (productTitle) productTitle.textContent = "ìƒí’ˆ ì •ë³´";

    exitShipEdit(true);

    // âœ… ì…ë ¥í™”ë©´ì—ì„œë„ ìš”ì•½ì€ ê³„ì† ë³´ì—¬ì•¼ í•¨
    renderDoneSummary();
    document.querySelectorAll(".product").forEach(p=>{
      lockProductInputs(p, false);
      setBadge(p);
    });

    // âœ… ë°œì†¡ì™„ë£Œ ìë™ ë°˜ì˜
    updateShippingStatuses_(true);

    applyProductVisibility_();
    calc();
    saveData();
  }

  function setBadge(div){
    const st = div.dataset.status || "draft";
    const badge = div.querySelector(".status-badge");
    if (!badge) return;

    badge.style.display = "inline-flex";
    badge.className = "status-badge";

    if (MODE === "complete" && div.dataset.editing === "1"){
      badge.classList.add("status-editing");
      badge.innerHTML = `<span class="sq"></span>ìˆ˜ì •ì¤‘`;
      return;
    }

    if (st === "canceled"){
      badge.classList.add("status-canceled");
      badge.innerHTML = `<span class="sq"></span>ì·¨ì†Œì™„ë£Œ`;
      return;
    }
    if (st === "shipped"){
      badge.classList.add("status-shipped");
      badge.innerHTML = `<span class="sq"></span>ë°œì†¡ì™„ë£Œ`;
      return;
    }
    if (st === "modified"){
      badge.classList.add("status-modified");
      badge.innerHTML = `<span class="sq"></span>ìˆ˜ì •ì™„ë£Œ`;
      return;
    }
    if (st === "sent"){
      badge.classList.add("status-sent");
      badge.innerHTML = `<span class="sq"></span>ì£¼ë¬¸ì™„ë£Œ`;
      return;
    }

    badge.style.display = "none";
  }

  function renderDoneSummary(){
    const box = document.getElementById("doneSummary");
    if (!box) return;

    const lines = [];

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified" || st === "canceled" || st === "shipped")) return;

      const i = p.querySelectorAll("input");
      const name = (i[0]?.value || "").trim();
      const color = (i[1]?.value || "").trim();
      const size = (i[2]?.value || "").trim();
      const qty = Number((i[3]?.value || "").trim() || 0);
      const price = Number((i[4]?.value || "").trim() || 0);

      const qtyText = qty ? `${qty}ê°œ` : "0ê°œ";
      const priceText = price ? _fmtMoney_(price) : "0ì›";

      const tag =
        (st === "canceled") ? "[ì·¨ì†Œì™„ë£Œ]" :
        (st === "shipped") ? "[ë°œì†¡ì™„ë£Œ]" :
        (st === "modified") ? "[ìˆ˜ì •ì™„ë£Œ]" :
        "[ì£¼ë¬¸ì™„ë£Œ]";

      lines.push(`â€¢ <b>${tag}</b> ${name} / ${color} / ${size} / ${qtyText} / ${priceText}`);
    });

    if (lines.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    box.style.display = "block";
    box.innerHTML = lines.join("<br>");
  }

  function calc(){
    let sum = 0;

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      const i = p.querySelectorAll("input");
      const qty = Number((i[3]?.value || "").trim() || 0);
      const price = Number((i[4]?.value || "").trim() || 0);
      const amt = qty * price;

      if (MODE === "complete"){
        if (st === "sent" || st === "modified" || st === "shipped") sum += amt;
        return;
      }

      if (st === "draft") sum += amt;
    });

    const shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

    document.getElementById("sum").innerText = sum.toLocaleString() + "ì›";
    document.getElementById("shipping").innerText = shipping.toLocaleString() + "ì›";
    document.getElementById("total").innerText = (sum + shipping).toLocaleString() + "ì›";
  }

  async function sendPayload(payload){
    const body = JSON.stringify(payload);

    let sent = false;
    if (navigator.sendBeacon){
      const blob = new Blob([body], { type:"text/plain;charset=UTF-8" });
      sent = navigator.sendBeacon(SCRIPT_URL, blob);
    }
    if (!sent){
      await fetch(SCRIPT_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"text/plain;charset=UTF-8" },
        body,
        keepalive:true
      });
    }
  }

  function kstNowDate_(){
    return new Date(Date.now() + 9 * 60 * 60 * 1000);
  }
  function kstNowString(){
    const d = kstNowDate_();
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(d.getUTCDate()).padStart(2, "0");
    const hh = String(d.getUTCHours()).padStart(2, "0");
    const mi = String(d.getUTCMinutes()).padStart(2, "0");
    const ss = String(d.getUTCSeconds()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  // âœ… "YYYY-MM-DD HH:MM:SS" (KST ê¸°ì¤€ ë¬¸ìì—´) -> Date(UTCê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ëœ KST)
  function parseKstStringToDate_(s){
    try{
      const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/);
      if (!m) return null;
      const yyyy = Number(m[1]);
      const mm = Number(m[2]);
      const dd = Number(m[3]);
      const hh = Number(m[4]);
      const mi = Number(m[5]);
      const ss = Number(m[6]);
      // KSTë¥¼ UTCë¡œ ë§ì¶”ê¸° ìœ„í•´ Date.UTCë¡œ ìƒì„±(ì´ë¯¸ KSTë¥¼ UTCí•„ë“œë¡œ ë„£ëŠ” ë°©ì‹)
      return new Date(Date.UTC(yyyy, mm-1, dd, hh, mi, ss));
    }catch(e){
      return null;
    }
  }

  function nextMondayNoonKst_(dKst){
    const dow = dKst.getUTCDay(); // 0ì¼~6í†  (KSTë¥¼ UTCí•„ë“œë¡œ ì‚¬ìš©)
    const add = ( (8 - dow) % 7 ) || 7; // ë‹¤ìŒ ì›”ìš”ì¼ê¹Œì§€
    const nd = new Date(Date.UTC(dKst.getUTCFullYear(), dKst.getUTCMonth(), dKst.getUTCDate()+add, 12, 0, 0));
    return nd;
  }

  function shippingDueAt_(orderTimeKstStr){
    const d = parseKstStringToDate_(orderTimeKstStr);
    if (!d) return null;

    const dow = d.getUTCDay(); // 0ì¼ 1ì›” 2í™” 3ìˆ˜ 4ëª© 5ê¸ˆ 6í† 
    // ì›”~ëª©: ë‹¤ìŒë‚  12ì‹œ, ê¸ˆ~ì¼: ë‹¤ìŒ ì›”ìš”ì¼ 12ì‹œ
    if (dow >= 1 && dow <= 4){
      return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()+1, 12, 0, 0));
    }
    return nextMondayNoonKst_(d);
  }

  function updateShippingStatuses_(silentSave){
    const now = kstNowDate_(); // KSTë¥¼ UTCí•„ë“œë¡œ ì‚¬ìš©ì¤‘
    let changed = false;

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified")) return;

      const ot = p.dataset.orderTime || "";
      const due = shippingDueAt_(ot);
      if (!due) return;

      if (now.getTime() >= due.getTime()){
        p.dataset.status = "shipped";
        setBadge(p);
        changed = true;
      }
    });

    if (changed){
      renderDoneSummary();
      calc();
      if (!silentSave) saveData();
      else if (!IS_LOADING) saveData();
    }
  }

  function _productSnapshot_(div){
    const i = div.querySelectorAll("input");
    return JSON.stringify({
      name: i[0]?.value || "",
      color: i[1]?.value || "",
      size: i[2]?.value || "",
      qty: i[3]?.value || "",
      price: i[4]?.value || ""
    });
  }

  function _applySnapshot_(div, snapStr){
    try{
      const s = JSON.parse(snapStr || "{}");
      const i = div.querySelectorAll("input");
      i[0].value = s.name || "";
      i[1].value = s.color || "";
      i[2].value = s.size || "";
      i[3].value = s.qty || "";
      i[4].value = s.price || "";
    }catch(e){}
  }

  function _validateProductInputs_(div){
    const i = div.querySelectorAll("input");
    const name = (i[0].value || "").trim();
    const color = (i[1].value || "").trim();
    const size = (i[2].value || "").trim();
    const qty = Number((i[3].value || "").trim() || 0);
    const price = Number((i[4].value || "").trim() || 0);

    if (!name) { alert("ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[0].focus(); return false; }
    if (!color) { alert("ìƒ‰ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[1].focus(); return false; }
    if (!size) { alert("ì‚¬ì´ì¦ˆë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[2].focus(); return false; }
    if (!qty || qty <= 0) { alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[3].focus(); return false; }
    if (!price || price <= 0) { alert("ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); i[4].focus(); return false; }
    return true;
  }

  function addProduct(preset){
    const div = document.createElement("div");
    div.className = "product";

    div.dataset.id = (preset && preset.id) ? preset.id : _uid();
    div.dataset.status = (preset && preset.status) ? preset.status : "draft";
    div.dataset.editing = (preset && preset.editing) ? preset.editing : "";
    div.dataset.snapshot = (preset && preset.snapshot) ? preset.snapshot : "";

    // âœ… ì£¼ë¬¸ ë°°ì¹˜/ì‹œê°„(ì™„ë£Œìƒí’ˆì˜ ë°œì†¡ì™„ë£Œ ê³„ì‚°ì— ì‚¬ìš©)
    div.dataset.orderId = (preset && preset.orderId) ? preset.orderId : "";
    div.dataset.orderTime = (preset && preset.orderTime) ? preset.orderTime : "";

    div.innerHTML = `
      <div class="field">
        <label>ìƒí’ˆëª…</label>
        <div class="product-title-row">
          <input class="product-name" placeholder="ì˜ˆ) ì•„ë¯¸ ë§¨íˆ¬ë§¨ / í´ë¡œ ê½ˆë°°ê¸° ë‹ˆíŠ¸ / ë©”ì¢… í›„ë“œí‹° / ê¼¼ë° ê¸´íŒ”í‹° / ì•Œë¡œ ì…‹ì—…">
          <div class="status-badge status-sent"><span class="sq"></span>ì£¼ë¬¸ì™„ë£Œ</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ìƒ‰ìƒ</label>
          <input placeholder="ì˜ˆ) ë¸”ë™ / ê²€ì •">
        </div>
        <div class="field">
          <label>ì‚¬ì´ì¦ˆ</label>
          <input placeholder="ì˜ˆ) L / ë¼ì§€ / 100">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ìˆ˜ëŸ‰</label>
          <input type="number" value="" placeholder="ì˜ˆ) 1">
        </div>
        <div class="field">
          <label>ê°€ê²©</label>
          <input type="number" placeholder="ì˜ˆ) 59000">
        </div>
      </div>

      <div class="edit-row" data-edit-open="1">
        <button class="btn-mini btn-edit-go" type="button">ìˆ˜ì •í•˜ê¸°</button>
      </div>

      <div class="edit-row" data-edit-controls="1">
        <button class="btn-mini btn-blue" type="button">ìˆ˜ì •ì™„ë£Œ</button>
        <button class="btn-mini btn-gray" type="button">ìˆ˜ì •ì·¨ì†Œ</button>
      </div>

      <!-- âœ… ì£¼ë¬¸ìƒì„¸ì—ì„œ ê°œë³„ ì·¨ì†Œ -->
      <div class="cancel-row" data-cancel-row="1">
        <button class="btn-item-cancel" type="button">ì·¨ì†Œí•˜ê¸°</button>
      </div>
    `;

    const inputs = div.querySelectorAll("input");
    if (preset){
      inputs[0].value = preset.name || "";
      inputs[1].value = preset.color || "";
      inputs[2].value = preset.size || "";
      inputs[3].value = preset.qty != null ? preset.qty : "";
      inputs[4].value = preset.price != null ? preset.price : "";
    }

    for (let k=0;k<5;k++){
      inputs[k].addEventListener("input", ()=>{
        if (MODE !== "form" && div.dataset.editing !== "1") return;
        calc();
        saveData();
      });
    }

    const editOpenRow = div.querySelector('[data-edit-open="1"]');
    const editBtn = editOpenRow.querySelector("button");
    const editControlsRow = div.querySelector('[data-edit-controls="1"]');
    const editDoneBtn = editControlsRow.querySelectorAll("button")[0];
    const editCancelBtn = editControlsRow.querySelectorAll("button")[1];

    editControlsRow.style.display = "none";
    editOpenRow.style.display = "none";

    function refreshRows_(){
      const st = div.dataset.status || "draft";
      const cancelRow = div.querySelector('[data-cancel-row="1"]');
      if (!cancelRow) return;

      // âœ… ì™„ë£Œí™”ë©´ + ì£¼ë¬¸ìƒì„¸ ì—´ë¦¼ + (ì£¼ë¬¸ì™„ë£Œ/ìˆ˜ì •ì™„ë£Œë§Œ) ê°œë³„ì·¨ì†Œ ê°€ëŠ¥
      const canCancel = (MODE === "complete" && ORDER_DETAIL_OPEN && (st === "sent" || st === "modified"));
      cancelRow.style.display = canCancel ? "flex" : "none";

      // âœ… ë°œì†¡ì™„ë£Œ/ì·¨ì†Œì™„ë£ŒëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”
      const btn = cancelRow.querySelector("button");
      if (btn){
        btn.disabled = !(st === "sent" || st === "modified");
      }
    }

    function enterEdit_(){
      if (MODE !== "complete") return;
      const st = div.dataset.status || "";
      if (!(st === "sent" || st === "modified")) return;
      if (div.dataset.editing === "1") return;

      div.dataset.snapshot = _productSnapshot_(div);
      div.dataset.editing = "1";

      editOpenRow.style.display = "none";
      editControlsRow.style.display = "flex";

      lockProductInputs(div, false);

      setBadge(div);
      refreshRows_();
      saveData();
    }

    function exitEdit_(restore){
      if (restore){
        _applySnapshot_(div, div.dataset.snapshot || "");
      }
      div.dataset.editing = "";

      editControlsRow.style.display = "none";
      editOpenRow.style.display = (MODE === "complete" && (div.dataset.status !== "draft") && ORDER_DETAIL_OPEN) ? "flex" : "none";

      if (MODE === "complete") lockProductInputs(div, true);

      setBadge(div);
      calc();
      renderDoneSummary();
      refreshRows_();
      saveData();
    }

    editBtn.onclick = enterEdit_;

    editCancelBtn.onclick = () => {
      exitEdit_(true);
    };

    editDoneBtn.onclick = async () => {
      if (MODE !== "complete") return;
      if (!_validateProductInputs_(div)) return;

      if (!confirm("ìˆ˜ì • ë‚´ìš©ì„ ì €ì¥í• ê¹Œìš”?")) return;

      const i = div.querySelectorAll("input");
      const item = {
        productName: (i[0].value || "").trim(),
        color: (i[1].value || "").trim(),
        size: (i[2].value || "").trim(),
        qty: Number((i[3].value || "").trim() || 0),
        price: Number((i[4].value || "").trim() || 0)
      };

      const useOrderId = div.dataset.orderId || LAST_DONE_ORDER_ID || newOrderId_();

      const payload = {
        orderId: useOrderId,
        orderTime: kstNowString(),
        eventType: "modify",
        customer: {
          nickname: document.getElementById("nickname").value || "",
          name: document.getElementById("name").value || "",
          phone: document.getElementById("phone").value || "",
          address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
        },
        items: [item],
        sum: 0,
        shipping: 0,
        total: 0
      };

      try{
        await sendPayload(payload);

        div.dataset.status = "modified";
        exitEdit_(false);

        setBanner("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch(e){
        alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    };

    // âœ… ê°œë³„ ì·¨ì†Œ ë²„íŠ¼
    const cancelBtn = div.querySelector('[data-cancel-row="1"] button');
    if (cancelBtn){
      cancelBtn.onclick = async () => {
        if (MODE !== "complete") return;

        const st = div.dataset.status || "";
        if (!(st === "sent" || st === "modified")){
          alert("í˜„ì¬ ìƒíƒœì—ì„œëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if (div.dataset.editing === "1"){
          alert("ìˆ˜ì • ì¤‘ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if (!confirm("ì´ ìƒí’ˆì„ ì·¨ì†Œí• ê¹Œìš”?\n(ì·¨ì†Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)")) return;

        const i = div.querySelectorAll("input");
        const item = {
          productName: (i[0].value || "").trim(),
          color: (i[1].value || "").trim(),
          size: (i[2].value || "").trim(),
          qty: Number((i[3].value || "").trim() || 0),
          price: Number((i[4].value || "").trim() || 0)
        };

        const useOrderId = div.dataset.orderId || LAST_DONE_ORDER_ID || newOrderId_();

        const payload = {
          orderId: useOrderId,
          orderTime: kstNowString(),
          eventType: "cancel",
          customer: {
            nickname: document.getElementById("nickname").value || "",
            name: document.getElementById("name").value || "",
            phone: document.getElementById("phone").value || "",
            address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
          },
          items: [item],
          sum: 0,
          shipping: 0,
          total: 0
        };

        try{
          await sendPayload(payload);

          div.dataset.status = "canceled";
          lockProductInputs(div, true);
          setBadge(div);
          refreshRows_();

          setBanner("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          calc();
          renderDoneSummary();
          saveData();
          alert("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e){
          alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      };
    }

    productsDiv.appendChild(div);

    // ì´ˆê¸° í‘œì‹œ ìƒíƒœ
    const st0 = div.dataset.status || "draft";
    if (MODE === "complete"){
      lockProductInputs(div, true);
      editOpenRow.style.display = (st0 !== "draft" && ORDER_DETAIL_OPEN) ? "flex" : "none";
    } else {
      lockProductInputs(div, false);
      editOpenRow.style.display = "none";
    }

    setBadge(div);
    refreshRows_();

    calc();
    renderDoneSummary();
    applyProductVisibility_();

    if (!IS_LOADING) saveData();
    return div;
  }

  function removeLastProduct(){
    if (MODE !== "form") return;

    const items = Array.from(document.querySelectorAll(".product"));
    for (let idx = items.length - 1; idx >= 0; idx--){
      const st = items[idx].dataset.status || "draft";
      if (st === "draft"){
        items[idx].remove();
        break;
      }
    }
    if (!document.querySelector('.product[data-status="draft"]')) addProduct();

    calc();
    saveData();
    renderDoneSummary();
    applyProductVisibility_();
  }

  // âœ… ì£¼ë¬¸ë‚´ìš©í™•ì¸(alert) ë¬¸êµ¬ ë³€ê²½ + PAY_NOTICE ì‚­ì œ
  function checkOrder(){
    let text = "[ê³ ê° ì •ë³´]\n";
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[ì‘ì„± ì¤‘ ìƒí’ˆ]\n";
    const targets = Array.from(document.querySelectorAll(".product")).filter(p => (p.dataset.status === "draft"));
    if (targets.length === 0){
      text += "(ì‘ì„± ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      targets.forEach((p, idx)=>{
        const i = p.querySelectorAll("input");
        text += `${idx+1}. ${i[0].value} / ${i[1].value} / ${i[2].value} / ${i[3].value}ê°œ / ${_fmtMoney_(i[4].value)}\n`;
      });
    }

    text += `\nìƒí’ˆí•©ê³„: ${document.getElementById("sum").innerText}\n`;
    text += `ë°°ì†¡ë¹„: ${document.getElementById("shipping").innerText}\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${document.getElementById("total").innerText}\n`;

    text += `\në‚´ìš©ì´ ë§ìœ¼ë©´ ì•„ë˜ í™”ë©´ì—ì„œ â€˜ì£¼ë¬¸í•˜ê¸°â€™ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.\nì£¼ë¬¸ í›„ì—ëŠ” â€˜ì£¼ë¬¸ì ‘ìˆ˜ê²°ê³¼â€™ì—ì„œ ìˆ˜ì •/ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n`;

    alert(text);
  }

  // âœ… ì£¼ë¬¸í™•ì¸ì„œ ë³´ê¸°(ì™„ë£Œí™”ë©´)
  function showOrderHistory(){
    let text = "[ë°°ì†¡ì§€ ì •ë³´]\n";
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[ì™„ë£Œ ìƒí’ˆ]\n";
    const items = Array.from(document.querySelectorAll(".product")).filter(p=>{
      const st = p.dataset.status || "draft";
      return (st === "sent" || st === "modified" || st === "canceled" || st === "shipped");
    });

    if (items.length === 0){
      text += "(ì™„ë£Œëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      items.forEach((p, idx)=>{
        const st = p.dataset.status;
        const i = p.querySelectorAll("input");
        const qty = Number(i[3].value || 0);
        const price = Number(i[4].value || 0);

        const prefix =
          (st === "canceled") ? "[ì·¨ì†Œì™„ë£Œ] " :
          (st === "shipped") ? "[ë°œì†¡ì™„ë£Œ] " :
          (st === "modified") ? "[ìˆ˜ì •ì™„ë£Œ] " :
          "[ì£¼ë¬¸ì™„ë£Œ] ";

        text += `${idx+1}. ${prefix}${i[0].value} / ${i[1].value} / ${i[2].value} / ${qty}ê°œ / ${price.toLocaleString()}ì›\n`;
      });
    }

    text += `\nìƒí’ˆí•©ê³„: ${document.getElementById("sum").innerText}\n`;
    text += `ë°°ì†¡ë¹„: ${document.getElementById("shipping").innerText}\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${document.getElementById("total").innerText}\n`;

    alert(text);
  }

  function _validateCustomer_(){
    const nickname = document.getElementById("nickname");
    const name = document.getElementById("name");
    const phone = document.getElementById("phone");
    const address = document.getElementById("address");
    const addressDetail = document.getElementById("addressDetail");

    if (!nickname.value.trim()) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); nickname.focus(); return false; }
    if (!name.value.trim()) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); name.focus(); return false; }
    if (!phone.value.trim()) { alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); phone.focus(); return false; }
    if (!address.value.trim()) { alert("ì£¼ì†Œê²€ìƒ‰ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return false; }
    if (!addressDetail.value.trim()) { alert("ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); addressDetail.focus(); return false; }
    return true;
  }

  async function submitOrder(){
    if (MODE !== "form") return;
    if (!_validateCustomer_()) return;

    const targets = Array.from(document.querySelectorAll(".product")).filter(p => (p.dataset.status === "draft"));
    if (targets.length === 0){
      alert("ì‘ì„± ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // âœ… confirmì—ëŠ” PAY_NOTICE ìœ ì§€(ìš”ì²­: alert ë¬¸êµ¬ì—ì„œë§Œ ì‚­ì œ)
    if (!confirm(`ì£¼ë¬¸ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${PAY_NOTICE}`)) return;

    const items = [];
    let sum = 0;

    for (const p of targets){
      if (!_validateProductInputs_(p)) return;

      const i = p.querySelectorAll("input");
      const name = (i[0].value || "").trim();
      const color = (i[1].value || "").trim();
      const size = (i[2].value || "").trim();
      const qty = Number((i[3].value || "").trim() || 0);
      const price = Number((i[4].value || "").trim() || 0);

      items.push({ productName:name, color, size, qty, price });
      sum += (qty * price);
    }

    const shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

    const batchOrderId = ensureDraftOrderId_();
    const orderTimeStr = kstNowString();

    const payload = {
      orderId: batchOrderId,
      orderTime: orderTimeStr,
      eventType: "order",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum,
      shipping,
      total: sum + shipping
    };

    try{
      await sendPayload(payload);

      targets.forEach(p=>{
        p.dataset.status = "sent";
        p.dataset.editing = "";
        p.dataset.snapshot = "";
        p.dataset.orderId = batchOrderId;
        p.dataset.orderTime = orderTimeStr;
        setBadge(p);
      });

      LAST_DONE_ORDER_ID = batchOrderId;
      ACTIVE_DRAFT_ORDER_ID = ""; // ë‹¤ìŒ ì£¼ë¬¸ì„ ìœ„í•´ ì´ˆê¸°í™”

      // âœ… ì£¼ë¬¸ í›„ì—ëŠ” ì™„ë£Œí™”ë©´(ì£¼ë¬¸ìƒì„¸ ë‹«íŒ ìƒíƒœ)ë¡œ
      setMode("complete", "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.", { detailClosedOnEnter:true });

      calc();
      renderDoneSummary();
      saveData();

      alert("ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì™„ë£Œ í™”ë©´ì—ì„œ ìˆ˜ì •/ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    } catch(e){
      alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  // âœ… (ìš”ì²­) ì™„ë£Œí™”ë©´ í•˜ë‹¨ 'ì·¨ì†Œí•˜ê¸°' = ì£¼ë¬¸ì™„ë£Œ/ìˆ˜ì •ì™„ë£Œ ì „ì²´ ì·¨ì†Œ
  async function submitCancel(){
    if (MODE !== "complete") return;

    const targets = Array.from(document.querySelectorAll(".product")).filter(p=>{
      const st = p.dataset.status || "";
      return (st === "sent" || st === "modified");
    });

    if (targets.length === 0){
      alert("ì·¨ì†Œí•  ìˆ˜ ìˆëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    if (!confirm("ì£¼ë¬¸ì™„ë£Œ/ìˆ˜ì •ì™„ë£Œ ìƒí’ˆì„ ëª¨ë‘ ì·¨ì†Œí• ê¹Œìš”?\n(ì·¨ì†Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)")) return;

    const items = targets.map(p=>{
      const i = p.querySelectorAll("input");
      return {
        productName: (i[0].value || "").trim(),
        color: (i[1].value || "").trim(),
        size: (i[2].value || "").trim(),
        qty: Number((i[3].value || "").trim() || 0),
        price: Number((i[4].value || "").trim() || 0)
      };
    });

    const useOrderId = (LAST_DONE_ORDER_ID || targets[0]?.dataset.orderId || newOrderId_());

    const payload = {
      orderId: useOrderId,
      orderTime: kstNowString(),
      eventType: "cancel",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum: 0,
      shipping: 0,
      total: 0
    };

    try{
      await sendPayload(payload);

      targets.forEach(p=>{
        p.dataset.status = "canceled";
        lockProductInputs(p, true);
        setBadge(p);

        const editOpenRow = p.querySelector('[data-edit-open="1"]');
        const editControlsRow = p.querySelector('[data-edit-controls="1"]');
        if (editControlsRow) editControlsRow.style.display = "none";
        if (editOpenRow) editOpenRow.style.display = "none";
      });

      setBanner("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      calc();
      renderDoneSummary();
      saveData();
      alert("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e){
      alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  function goToFormForAdd(){
    if (SHIP_EDITING){ alert("ë°°ì†¡ì§€ ìˆ˜ì • ì¤‘ì—ëŠ” ì¶”ê°€ì£¼ë¬¸ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    setMode("form");

    let firstDraft = document.querySelector('.product[data-status="draft"]');
    if (!firstDraft){
      firstDraft = addProduct();
    }
    setTimeout(()=>{
      const nameInput = firstDraft.querySelector(".product-name");
      if (nameInput){
        nameInput.focus();
        try{
          const len = nameInput.value.length;
          nameInput.setSelectionRange(len, len);
        } catch(e){}
      }
      firstDraft.scrollIntoView({ behavior:"smooth", block:"center" });
    }, 50);

    calc();
    renderDoneSummary();
    saveData();
  }

  // âœ… (ìš”ì²­) ìƒˆë¡œ ì£¼ë¬¸í•˜ê¸°ë¥¼ ëˆŒëŸ¬ë„ ì™„ë£Œ ìš”ì•½ì€ ê³„ì† ë– ì•¼ í•¨
  // - draftë§Œ ì •ë¦¬í•˜ê³ , done(ì£¼ë¬¸/ìˆ˜ì •/ì·¨ì†Œ/ë°œì†¡ì™„ë£Œ)ì€ ìœ ì§€
  // - 5ì¼ ê²½ê³¼ ì‹œì—ë§Œ ì™„ì „ ì´ˆê¸°í™”
  function newOrder(){
    if (!confirm("ì‘ì„± ì¤‘ì¸ ìƒí’ˆì„ ì´ˆê¸°í™”í•˜ê³  ìƒˆ ì£¼ë¬¸ì„ ì‹œì‘í• ê¹Œìš”?")) return;

    // draftë§Œ ì œê±°
    Array.from(document.querySelectorAll('.product')).forEach(p=>{
      const st = p.dataset.status || "draft";
      if (st === "draft") p.remove();
    });

    // ìƒˆ draft ì¶”ê°€
    if (!document.querySelector('.product[data-status="draft"]')) addProduct();

    // draftìš© ì£¼ë¬¸ID ìƒˆë¡œ ì¤€ë¹„
    ACTIVE_DRAFT_ORDER_ID = newOrderId_();

    // ì…ë ¥ í™”ë©´ìœ¼ë¡œ
    setMode("form");
    calc();
    renderDoneSummary();
    saveData();

    setTimeout(()=>{
      const first = document.querySelector(".product .product-name");
      if (first) first.focus();
    }, 30);
  }

  function enterShipEdit(){
    if (MODE !== "complete") return;

    SHIP_EDITING = true;
    SHIP_SNAPSHOT = snapshotCustomer();

    document.getElementById("shipSummary").style.display = "none";
    document.getElementById("customerFormFields").style.display = "block";
    document.getElementById("shipEditControls").style.display = "flex";
    document.getElementById("shipActions").style.display = "none";

    setTimeout(()=>{
      const nick = document.getElementById("nickname");
      if (nick){ nick.focus(); }
    }, 30);

    saveData();
  }

  function exitShipEdit(silent){
    SHIP_EDITING = false;
    SHIP_SNAPSHOT = null;

    const shipSummary = document.getElementById("shipSummary");
    const customerFormFields = document.getElementById("customerFormFields");
    const shipEditControls = document.getElementById("shipEditControls");
    const shipActions = document.getElementById("shipActions");

    if (MODE === "complete"){
      shipSummary.style.display = "block";
      customerFormFields.style.display = "none";
      shipEditControls.style.display = "none";
      shipActions.style.display = "flex";
    } else {
      shipSummary.style.display = "none";
      customerFormFields.style.display = "block";
      shipEditControls.style.display = "none";
      shipActions.style.display = "none";
    }

    if (!silent) saveData();
  }

  function cancelShipEdit(){
    if (!SHIP_EDITING) return;

    const s = SHIP_SNAPSHOT || {};
    document.getElementById("nickname").value = s.nickname || "";
    document.getElementById("name").value = s.name || "";
    document.getElementById("phone").value = s.phone || "";
    document.getElementById("address").value = s.address || "";
    document.getElementById("addressDetail").value = s.addressDetail || "";

    renderShippingSummary();
    exitShipEdit(false);

    setBanner("ë°°ì†¡ì§€ ìˆ˜ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    focusBanner();
  }

  async function saveShipEdit(){
    if (!SHIP_EDITING) return;

    if (!_validateCustomer_()) return;
    if (!confirm("ë°°ì†¡ì§€ë¥¼ ì €ì¥í• ê¹Œìš”?")) return;

    const payload = {
      orderId: LAST_DONE_ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      eventType: "ship_update",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items: [],
      sum: 0,
      shipping: 0,
      total: 0
    };

    try{
      await sendPayload(payload);

      renderShippingSummary();
      exitShipEdit(false);

      setBanner("ë°°ì†¡ì§€ ìˆ˜ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      focusBanner();
      alert("ë°°ì†¡ì§€ ì €ì¥ ì™„ë£Œ");
    } catch(e){
      alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  // âœ… customerëŠ” ë³„ë„ ì €ì¥(ê¸°í•œ ì—†ìŒ)
  function saveCustomerOnly_(){
    const c = snapshotCustomer();
    localStorage.setItem(LS_CUSTOMER_KEY, JSON.stringify(c));
  }
  function loadCustomerOnly_(){
    const c = JSON.parse(localStorage.getItem(LS_CUSTOMER_KEY) || "null");
    if (!c) return null;
    return c;
  }

  function saveData(){
    // customerëŠ” ë³„ë„ ì €ì¥(ë¬´ê¸°í•œ)
    saveCustomerOnly_();

    const data = {
      savedAt: Date.now(),
      mode: MODE,
      detailOpen: ORDER_DETAIL_OPEN,
      shipEditing: SHIP_EDITING,
      lastDoneOrderId: LAST_DONE_ORDER_ID,
      activeDraftOrderId: ACTIVE_DRAFT_ORDER_ID,
      products: []
    };

    document.querySelectorAll(".product").forEach(p=>{
      const i = p.querySelectorAll("input");
      data.products.push({
        id: p.dataset.id || _uid(),
        status: p.dataset.status || "draft",
        snapshot: p.dataset.snapshot || "",
        editing: p.dataset.editing || "",
        orderId: p.dataset.orderId || "",
        orderTime: p.dataset.orderTime || "",
        name: i[0]?.value || "",
        color: i[1]?.value || "",
        size: i[2]?.value || "",
        qty: i[3]?.value || "",
        price: i[4]?.value || ""
      });
    });

    localStorage.setItem(LS_ORDER_KEY, JSON.stringify(data));
  }

  function loadData(){
    // âœ… customer ë¬´ê¸°í•œ ë¡œë“œ
    const savedCustomer = loadCustomerOnly_();
    if (savedCustomer){
      document.getElementById("nickname").value = savedCustomer.nickname || "";
      document.getElementById("name").value = savedCustomer.name || "";
      document.getElementById("phone").value = savedCustomer.phone || "";
      document.getElementById("address").value = savedCustomer.address || "";
      document.getElementById("addressDetail").value = savedCustomer.addressDetail || "";
    }

    const data = JSON.parse(localStorage.getItem(LS_ORDER_KEY) || "null");

    // âœ… ì£¼ë¬¸ ë°ì´í„°(ìƒí’ˆ/ì£¼ë¬¸ê²°ê³¼)ëŠ” 5ì¼ ìœ ì§€, ì´ˆê³¼ ì‹œ ì´ˆê¸°í™”(ê³ ê°ì •ë³´ëŠ” ìœ ì§€)
    const expired = (!data || !data.savedAt || (Date.now() - Number(data.savedAt)) > ORDER_TTL_MS);

    if (expired){
      IS_LOADING = true;
      productsDiv.innerHTML = "";
      ACTIVE_DRAFT_ORDER_ID = newOrderId_();
      LAST_DONE_ORDER_ID = "";
      ORDER_DETAIL_OPEN = false;

      addProduct();

      IS_LOADING = false;

      renderShippingSummary();
      renderDoneSummary();
      calc();

      setMode("form");
      setBanner("ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
      saveData();
      return;
    }

    IS_LOADING = true;

    MODE = data.mode || "form";
    ORDER_DETAIL_OPEN = !!data.detailOpen;
    SHIP_EDITING = !!data.shipEditing;

    LAST_DONE_ORDER_ID = data.lastDoneOrderId || "";
    ACTIVE_DRAFT_ORDER_ID = data.activeDraftOrderId || "";

    productsDiv.innerHTML = "";
    (data.products || []).forEach(p=>{
      addProduct({
        id: p.id,
        status: p.status,
        snapshot: p.snapshot,
        editing: p.editing,
        orderId: p.orderId,
        orderTime: p.orderTime,
        name: p.name,
        color: p.color,
        size: p.size,
        qty: p.qty,
        price: p.price
      });
    });

    if (!document.querySelector('.product[data-status="draft"]')) addProduct();

    IS_LOADING = false;

    renderShippingSummary();
    renderDoneSummary();
    calc();

    // âœ… ë°œì†¡ì™„ë£Œ ìë™ ë°˜ì˜
    updateShippingStatuses_(true);

    if (MODE === "complete"){
      if (hasAnyDoneItems_()){
        setMode("complete", "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.", { allowEmpty:true });
      } else {
        setMode("form");
      }
    } else {
      setMode("form");
    }

    setBanner("ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
    saveData();
  }

  ["nickname","name","phone","addressDetail"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      renderShippingSummary();
      saveData();
    });
  });

  loadData();

  // âœ… í˜ì´ì§€ ì—´ë ¤ìˆëŠ” ë™ì•ˆë„ ë°œì†¡ì™„ë£Œ ìë™ ì—…ë°ì´íŠ¸(5ë¶„ë§ˆë‹¤)
  setInterval(()=>updateShippingStatuses_(true), 5 * 60 * 1000);
</script>

</body>
</html>