<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì‹¸U ë¼ì´ë¸Œ ì£¼ë¬¸ ğŸ”´ LIVE</title>

<style>
  body{
    margin:0; padding:16px;
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    background:#fff; color:#111;
    /* âœ… (ë³€ê²½) bottomBar ê³ ì • ì œê±° â†’ body padding-bottom ìë™ ë³´ì • ë¶ˆí•„ìš” */
    padding-bottom: 16px;
  }
  h1{ text-align:center; font-size:20px; margin:0 0 12px; color:#005FAE; }

  /* âœ… ë¼ë²¨/ìš”ì•½/ê³„ì¢Œ/í•©ê³„ */
  label{ font-weight:800; font-size:15px; }
  .summary-line{ font-size:14px; display:flex; justify-content:space-between; }
  .summary-line span{ font-weight:900; }
  .account-text{ font-weight:900; font-size:14px; flex:1; }
  input{ font-weight:400; font-size:15px; }
  input::placeholder{ color:#999; font-weight:500; }

  button{
    padding:12px 14px;
    font-size:14px;
    font-weight:900;
    border-radius:8px;
    border:none;
    cursor:pointer;
    transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
    -webkit-tap-highlight-color: transparent;
  }
  button:active{ transform: scale(0.98); filter: brightness(0.96); }
  button:focus-visible{
    outline: 3px solid rgba(0,95,174,.25);
    outline-offset: 2px;
  }

  /* âœ… (ì¶”ê°€) + / âˆ’ ë™ê·¸ë¼ë¯¸ ì•„ì´ì½˜ ì²˜ë¦¬ */
  .btn-circle{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
  }
  .icon-circle{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    border-radius:50%;
    border:2px solid #fff;   /* â­• ë™ê·¸ë¼ë¯¸ */
    color:#fff;              /* + / âˆ’ í°ìƒ‰ */
    font-size:14px;
    font-weight:900;
    line-height:1;
  }

  /* âœ… ì™„ë£Œ ë°°ë„ˆ */
  .mode-banner{
    display:none;
    text-align:center;
    padding:10px 12px;
    border-radius:10px;
    font-weight:900;
    margin:0 auto 14px;
    max-width:560px;
    outline:none;
    line-height:1.35;
  }
  .mode-banner .banner-main{
    color:#005FAE;
    font-weight:900;
    font-size:15px;
  }
  .mode-banner .banner-oid{
    margin-top:6px;
    color:#111;
    font-weight:400;
    font-size:13px;
  }
  body.mode-complete .mode-banner{
    display:block;
    background:#e8f2ff;
    border:1px solid #c8ddff;
  }
  body.mode-complete h1{ display:none; }

  .section{ margin-bottom:28px; }
  .section-title{ font-size:15px; font-weight:800; margin-bottom:10px; color:#005FAE; }
  .divider{ border-top:1px solid #eee; margin:12px 0 16px; }
  .field{ margin-bottom:12px; }

  input{
    width:100%;
    padding:12px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
  }

  /* âœ… (ìš”ì²­ 3) select(ì‚¬ì´ì¦ˆ/ìˆ˜ëŸ‰) ê¸°ë³¸ ìŠ¤íƒ€ì¼: inputê³¼ ë™ì¼í•œ ë°•ìŠ¤ + ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ */
  select{
    width:100%;
    padding:12px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
    font-size:15px;
    font-weight:400;
    background:#fff;
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, #777 50%),
      linear-gradient(135deg, #777 50%, transparent 50%);
    background-position:
      calc(100% - 18px) 50%,
      calc(100% - 12px) 50%;
    background-size:6px 6px, 6px 6px;
    background-repeat:no-repeat;
    padding-right:40px;
  }
  select:focus-visible{
    outline: 3px solid rgba(0,95,174,.25);
    outline-offset: 2px;
  }
  select:invalid{ color:#999; font-weight:500; }

  .address-row{ display:flex; gap:8px; }
  .address-row input{ flex:1; }
  .addr-btn{
    background:#005FAE; color:#fff;
    border:none;
    border-radius:8px;
    padding:12px 14px;
    font-size:14px;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
  }

  /* âœ… ë°°ì†¡ì§€ ìš”ì•½(ì™„ë£Œ í™”ë©´ì—ì„œ í‘œì‹œ) */
  #shipSummary{
    display:none;
    background:#f7f7f7;
    border:1px solid #e5e5e5;
    border-radius:10px;
    padding:12px;
    font-size:14px;
    line-height:1.55;
    font-weight:800;
  }
  body.mode-complete #shipSummary{ display:block; }
  body.mode-complete #customerFormFields{ display:none; }

  .ship-actions{
    display:none;
    gap:8px;
    margin-top:10px;
  }
  body.mode-complete .ship-actions{ display:flex; }

  .btn-mini{
    padding:10px 10px;
    font-size:13px;
    font-weight:900;
    border-radius:10px;
    border:none;
    cursor:pointer;
  }
  .btn-gray{ background:#e0e0e0; color:#111; }
  .btn-blue{ background:#005FAE; color:#fff; }
  .btn-red{ background:#e74c3c; color:#fff; }

  .product{
    border-top:1px solid #eee;
    padding-top:12px;
    margin-top:12px;
  }

  .row{ display:flex; gap:8px; }
  .row .field{ flex:1; }

  .button-line-3{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:12px;
  }
  .button-line-3 button{
    flex:0 0 calc((100% - 16px)/3);
    max-width:calc((100% - 16px)/3);
    white-space:nowrap;
  }
  .button-line-2{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:10px;
  }
  .button-line-2 button{
    flex:0 0 calc((100% - 8px)/2);
    max-width:calc((100% - 8px)/2);
    white-space:nowrap;
  }

  .btn-check{ background:#E0E0E0; color:#333; }
  .btn-order{ background:#005FAE; color:#fff; }
  .btn-add{ background:#005FAE; color:#fff; }
  .btn-delete{ background:#e74c3c; color:#fff; }

  /* âœ… ì£¼ë¬¸ì ‘ìˆ˜ê²°ê³¼ ë‹¤ì‹œë³´ê¸°(ë” ì—°í•œ íšŒìƒ‰ + í…Œë‘ë¦¬) */
  .btn-preview{
    background:#f2f2f2;
    color:#333;
    border:1px solid #d7d7d7;
  }

  .btn-edit-go{
    background:#fff7e6;
    color:#9a6b00;
    border:1px solid #ffe1a6;
    font-weight:900;
  }
  .btn-cancel-do{
    background:#fff;
    color:#e74c3c;
    border:1px solid #e74c3c;
    font-weight:900;
  }
  .btn-add-order{ background:#005FAE; color:#fff; font-weight:900; }

  .account-box{
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:#f4f7ff;
    border:1px solid #d6e0ff;
    border-radius:8px;
    padding:10px;
    gap:8px;
  }
  .copy-btn{
    background:#005FAE;
    color:#fff;
    font-size:12px;
    font-weight:900;
    padding:6px 10px;
    border-radius:6px;
    border:none;
  }

  .pay-note{
    margin-top:8px;
    font-size:13px;
    font-weight:900;
    color:#c0392b;
    line-height:1.4;
  }

  .product-title-row{ display:flex; align-items:center; gap:8px; }
  .product-title-row input{ flex:1; }

  /* âœ… ë°°ì§€ í¬ê¸° ì•½ê°„ í¬ê²Œ */
  .status-badge{
    display:inline-flex;
    align-items:center;
    gap:7px;
    font-size:13px;
    font-weight:900;
    padding:7px 12px;
    border-radius:7px;
    white-space:nowrap;
    user-select:none;
  }
  .status-badge .sq{ width:11px; height:11px; border-radius:3px; display:inline-block; }

  .status-sent{ background:#e8f2ff; color:#005FAE; border:1px solid #c8ddff; }
  .status-sent .sq{ background:#005FAE; }

  .status-modified{ background:#fff7e6; color:#9a6b00; border:1px solid #ffe1a6; }
  .status-modified .sq{ background:#9a6b00; }

  /* âœ… ë°œì†¡ì™„ë£Œ ë°°ì§€: ë³´ë¼ìƒ‰ */
  .status-shipped{ background:#f3e8ff; color:#6f2dbd; border:1px solid #dbc5ff; }
  .status-shipped .sq{ background:#6f2dbd; }

  .status-canceled{ background:#ffe9e9; color:#c0392b; border:1px solid #ffc9c9; }
  .status-canceled .sq{ background:#e74c3c; }

  .status-editing{ background:#ededed; color:#333; border:1px solid #cfcfcf; }
  .status-editing .sq{ background:#777; }

  #doneSummary{
    display:none;
    font-size:13px;
    color:#333;
    background:#f7f9ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    padding:10px;
    margin:6px 0 10px;
    line-height:1.55;
    font-weight:900;
  }
  /* âœ… (ìš”ì²­) ì£¼ë¬¸ì…ë ¥ í™”ë©´ì—ì„œëŠ” ì™„ë£Œ ìš”ì•½ ìˆ¨ê¹€ */
  body.mode-form #doneSummary{ display:none; }
  body.mode-complete #doneSummary{ display:block; }

  /* âœ… (ì¶”ê°€) ì£¼ë¬¸ì…ë ¥ í™”ë©´ì—ì„œë§Œ: ì‘ì„± ì¤‘ ìƒí’ˆ ìš”ì•½ */
  #draftSummary{
    display:none;
    font-size:13px;
    color:#333;
    background:#f7f9ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    padding:10px;
    margin:6px 0 10px;
    line-height:1.55;
    font-weight:900;
  }
  body.mode-form #draftSummary{ display:block; }
  body.mode-complete #draftSummary{ display:none; }

  .edit-row{ display:none; margin-top:10px; gap:8px; justify-content:flex-end; }
  .edit-row button{ padding:10px 12px; font-size:13px; border-radius:10px; }

  .product.is-locked input,
  .product.is-locked select{
    background:#f2f2f2 !important;
    color:#777 !important;
    border-color:#ddd !important;
  }
  .product.is-locked input::placeholder{ color:#aaa !important; }
  .product.is-locked input:disabled,
  .product.is-locked select:disabled{
    background:#f2f2f2 !important;
    color:#777 !important;
    -webkit-text-fill-color:#777 !important;
    opacity:1 !important;
  }

  .summary{ border-top:1px solid #eee; padding-top:14px; }
  .summary-total{ font-weight:900; font-size:16px; color:#005FAE; }

  body.mode-complete .form-product-controls{ display:none !important; }

  /* âœ… ì£¼ë¬¸ì…ë ¥ í™”ë©´ ë²„íŠ¼ì˜ì—­ */
  #formControls{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }
  #formControls .button-line-3{ margin-top:0; }

  /* âœ… (ì¶”ê°€/ìˆ˜ì •) ì™„ë£Œí™”ë©´ ë²„íŠ¼ì˜ì—­ë„ formControlsì™€ ë™ì¼í•œ ê°„ê²© ì ìš© */
  #completeControls{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }

  /* âœ… ì£¼ë¬¸ìƒì„¸ ë³´ê¸°/ë‹«ê¸° ë²„íŠ¼(ì™„ë£Œí™”ë©´ ì „ìš©) */
  #detailToggleWrap{ display:none; }
  body.mode-complete #detailToggleWrap{ display:block; }

  .small-link-btn{
    width:100%;
    margin-top:10px;
    background:#fff;
    border:1px solid #ddd;
    color:#333;
    font-weight:900;
  }
  .detail-note{
    margin-top:6px;
    font-size:12px;
    font-weight:900;
    color:#666;
    line-height:1.3;
  }

  /* âœ… ê°œë³„ ì·¨ì†Œ ë²„íŠ¼ */
  .cancel-row{
    margin-top:10px;
    display:none;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  body.mode-complete .cancel-row{ display:flex; }

  .btn-item-cancel{
    background:#e74c3c;
    color:#fff;
    font-weight:900;
    border:none;
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
  }
  .btn-item-cancel:disabled{
    opacity:.55;
    cursor:not-allowed;
  }

  /* âœ… ë¬¸ì˜í•˜ê¸°(ë§í’ì„ ) */
  .help-wrap{
    margin-top:10px;
    border:1px solid #eee;
    border-radius:12px;
    padding:10px 12px;
    background:#fff;
  }
  .help-title{
    font-size:12px;
    font-weight:900;
    color:#555;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .help-title .bubble{
    font-size:14px;
    line-height:1;
  }
  .help-link{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:13px;
    font-weight:900;
    color:#005FAE;
    cursor:pointer;
    user-select:none;
    text-decoration:none;
  }
  .help-link .bubble{
    font-size:14px;
    line-height:1;
  }

  /* âœ… (ì¶”ê°€) ë¬¸ì˜ í•œ ì¤„ ì •ë ¬ */
  .help-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .help-row .help-title{
    margin-bottom:0;
  }

  /* âœ… (ì¶”ê°€) ê°€ìš´ë° 1ê°œ ë²„íŠ¼(í­ 2/3) */
  .button-center-one{
    display:flex;
    justify-content:center;
    margin-top:12px;
  }
  .button-center-one button{
    width:66.666%;
    max-width:560px;
  }

  /* âœ… (ì¶”ê°€) ì™„ë£Œëœ ì£¼ë¬¸ ë‹¤ì‹œë³´ê¸° ë²„íŠ¼(ìˆ˜ì •ì™„ë£Œ í†¤ + ê¸€ì”¨ ê²€ì •) */
  .btn-replay{
    background:#fff7e6;
    color:#111;
    border:1px solid #ffe1a6;
  }

  /* âœ… (ì¶”ê°€) ê°€ê²© ì…ë ¥ì¹¸ ì˜¤ë¥¸ìª½ "ì›" í‘œì‹œ */
  .money-wrap{ position:relative; }
  .money-wrap input{ padding-right:40px; }
  .money-wrap .money-suffix{
    position:absolute;
    right:12px;
    top:50%;
    transform:translateY(-50%);
    font-size:14px;
    font-weight:900;
    color:#666;
    pointer-events:none;
    user-select:none;
  }

  /* âœ… (ì¶”ê°€) ìƒí’ˆ ì •ë³´ íƒ€ì´í‹€ + ë‚ ì§œ í•„í„° ë²„íŠ¼(ì˜¤ëŠ˜~1ì£¼) */
  .section-title-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .section-title-row .section-title{
    margin-bottom:0;
    white-space:nowrap;
  }
  .day-filter{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .day-filter button{
    padding:6px 8px;
    font-size:12px;
    font-weight:900;
    border-radius:10px;
    background:#f2f2f2;
    border:1px solid #d7d7d7;
    color:#333;
    cursor:pointer;
  }
  .day-filter button.is-active{
    background:#e8f2ff;
    border:1px solid #c8ddff;
    color:#005FAE;
  }

  /* âœ… ë‚ ì§œ í•„í„° ë²„íŠ¼: ì…ë ¥í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€, ì™„ë£Œí™”ë©´ì—ì„œëŠ” í‘œì‹œ */
  body.mode-form #dayFilter{ display:none !important; }
  body.mode-complete #dayFilter{ display:flex !important; }

  /* ==================================================
     âœ…âœ…âœ… [ìš”ì²­ ë°˜ì˜]
     1) ì…ë ¥ ë‚´ìš© í™•ì¸ ë²„íŠ¼: ì‹¸U íŒŒë€ìƒ‰ í…Œë‘ë¦¬/ê¸€ì”¨ (ë°°ê²½ í°ìƒ‰)
     2) ì£¼ë¬¸ ë‚´ì—­ ë³´ê¸° ë²„íŠ¼: ì‹¸U íŒŒë€ìƒ‰ í…Œë‘ë¦¬/ê¸€ì”¨ (ë°°ê²½ í°ìƒ‰)
     4) ì£¼ë¬¸ ë‚´ì—­ ë³µì‚¬ ë²„íŠ¼: íšŒìƒ‰ ì±„ì›€ + ì§„íšŒìƒ‰(ë” ì—°í•œ) í…Œë‘ë¦¬ + ì§„í•œ ê²€ì • ê¸€ì”¨
     5) ì§€ì •ëœ 8ê°œ ë²„íŠ¼ ê¸€ì”¨ 1ì‚¬ì´ì¦ˆ í¬ê²Œ(14 -> 15)
     ================================================== */
  .btn-outline-blue{
    background:#fff;
    color:#005FAE;
    border:1px solid #7aa7d9;
    font-weight:900;
  }
  .btn-outline-gray{
    background:#fff;
    color:#777;
    border:1px solid #cfcfcf;
    font-weight:900;
  }

  /* âœ… (ìš”ì²­ 5) 8ê°œ ë²„íŠ¼ë§Œ 1ì‚¬ì´ì¦ˆ í¬ê²Œ */
  .btn-add,
  .btn-delete,
  .btn-order,
  .btn-replay,
  .btn-add-order,
  .btn-check,
  .btn-history-view,
  .btn-history-copy{
    font-size:15px;
  }

  /* âœ… (ìš”ì²­ 5) ì£¼ë¬¸ ë‚´ì—­ ë³µì‚¬ ë²„íŠ¼ í…Œë‘ë¦¬ë¥¼ ë” ì—°í•œ íšŒìƒ‰ìœ¼ë¡œ */
  .btn-history-copy{
    background:#e0e0e0;        /* íšŒìƒ‰ ì±„ì›€ */
    color:#111;               /* ì§„í•œ ê²€ì • */
    border:1px solid #bdbdbd; /* âœ… ë” ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ */
    font-weight:900;
  }

  /* âœ… (ìš”ì²­ 6) ì£¼ë¬¸í•˜ê¸°/ì¶”ê°€ì£¼ë¬¸í•˜ê¸° ê¸€ì”¨ +1 */
  .btn-order,
  .btn-add-order{
    font-size:16px; /* âœ… 15 -> 16 */
  }

  /* âœ… (ìš”ì²­ 7) ì„¸ë¡œ ê¸¸ì´ ì¡°ì • */
  .btn-order,
  .btn-add-order{
    padding:14px 14px; /* âœ… í•œ ë‹¨ê³„ ë” í¬ê²Œ */
  }

  /* âœ… (ìš”ì²­ 4) 4ê°œ ë²„íŠ¼ ì„¸ë¡œê¸¸ì´ í•œ ë‹¨ê³„ í¬ê²Œ */
  .btn-check,
  .btn-replay,
  .btn-history-view,
  .btn-history-copy{
    padding:12px 14px; /* âœ… 10 -> 12 */
  }

  /* âœ… (ìš”ì²­ 2) ìƒí’ˆ ì¶”ê°€/ì‚­ì œ ì•„ë˜ ì•ˆë‚´ ë¬¸êµ¬ */
  .form-under-note{
    margin-top:8px;
    font-size:12px;
    font-weight:900;
    color:#666;
    line-height:1.35;
    text-align:center;
  }

  /* ==================================================
     âœ…âœ…âœ… (ë³€ê²½: ìš”ì²­ 2) í•˜ë‹¨ ê³ ì • ë°” ì‚­ì œ(=ê³ ì • ì œê±°)
     - ê¸°ì¡´ fixedë¥¼ staticìœ¼ë¡œ ë³€ê²½ â†’ ë³¸ë¬¸ íë¦„ì—ì„œ ë§¨ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ë©´ ë³´ì´ê²Œ ë¨
     ================================================== */
  #bottomBar{
    position:static;
    left:auto; right:auto; bottom:auto;
    background:#fff;
    border-top:0;
    padding:0;
    z-index:auto;
    margin-top:12px;
  }
  #bottomBarInner{
    max-width:560px;
    margin:0 auto;
  }

  /* âœ… (ìš”ì²­ 2) ë§ˆì§€ë§‰ ê°€ê²© ì…ë ¥ "ì™„ë£Œ/í™•ì¸" í›„ ì£¼ë¬¸í•˜ê¸° ìœ ë„(ê°•ì¡°) */
  @keyframes pulseBtn {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,95,174,.35); }
    70%{ transform: scale(1.02); box-shadow: 0 0 0 10px rgba(0,95,174,0); }
    100%{ transform: scale(1); box-shadow: 0 0 0 0 rgba(0,95,174,0); }
  }
  .btn-pulse{
    animation:pulseBtn .9s ease-out 1;
  }
</style>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="mode-form">
<h1>ì‹¸U ë¼ì´ë¸Œ ì£¼ë¬¸ ğŸ”´ LIVE</h1>

<div class="mode-banner" id="modeBanner" tabindex="-1">
  <div class="banner-main">ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
  <div class="banner-oid"></div>
</div>

<div class="section">
  <div class="section-title" id="customerSectionTitle">ê³ ê° ì •ë³´</div>
  <!-- âœ… 2) ë°°ì†¡ì§€ ì •ë³´ ë°‘ ê·¸ë ˆì´ êµ¬ë¶„ì„  ì œê±° -->
  <!-- <div class="divider"></div> -->

  <div id="shipSummary"></div>

  <div class="ship-actions" id="shipActions" style="display:none;">
    <button class="btn-mini btn-edit-go" type="button" onclick="enterShipEdit()">ë°°ì†¡ì§€ ë³€ê²½</button>
  </div>

  <div id="customerFormFields">
    <div class="field">
      <label>ë‹‰ë„¤ì„</label>
      <input id="nickname" placeholder="ì˜ˆ) GOë¹„ìš˜ë“œ">
    </div>
    <div class="field">
      <label>ì´ë¦„</label>
      <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™">
    </div>
    <div class="field">
      <label>ì—°ë½ì²˜</label>
      <input id="phone" placeholder="ì˜ˆ) 010-1234-5678" inputmode="numeric">
    </div>
    <div class="field">
      <label>ì£¼ì†Œ</label>
      <div class="address-row">
        <input id="address" placeholder="ì£¼ì†Œê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" readonly>
        <button class="addr-btn" type="button" onclick="searchAddress()">ì£¼ì†Œê²€ìƒ‰</button>
      </div>
    </div>
    <div class="field">
      <!-- âœ… 4) ë¼ë²¨ ë³€ê²½ -->
      <label>ìƒì„¸ì£¼ì†Œ(ë™/í˜¸ìˆ˜ ê¼­ ì…ë ¥)</label>
      <!-- âœ…âœ…âœ… (ìš”ì²­ 1) ì™„ë£Œ ë²„íŠ¼ ì‚¬ìš© ê°€ëŠ¥ -->
      <input id="addressDetail" placeholder="ì˜ˆ) 101ë™ 1203í˜¸" enterkeyhint="done">
    </div>

    <div class="button-line-2" id="shipEditControls" style="display:none;">
      <button class="btn-blue" type="button" onclick="saveShipEdit()">ë°°ì†¡ì§€ ì €ì¥</button>
      <button class="btn-mini btn-gray" type="button" onclick="cancelShipEdit()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title-row">
    <!-- âœ… (ìš”ì²­ 1) ì…ë ¥í™”ë©´ì—ì„œëŠ” 'ìƒí’ˆì •ë³´', ì™„ë£Œí™”ë©´ì—ì„œëŠ” 'ì£¼ë¬¸ìƒí’ˆ ì •ë³´'ë¡œ JSì—ì„œ í† ê¸€ -->
    <div class="section-title" id="productSectionTitle">ìƒí’ˆì •ë³´</div>

    <!-- âœ… ì™„ë£Œí™”ë©´ì—ì„œë§Œ ë³´ì¼ ë‚ ì§œ í•„í„° (ìš”ì²­ 2) ì˜¤ëŠ˜/ì–´ì œ/ê·¸ì œ/3ì¼ì „/4ì¼ì „/1ì£¼ -->
    <div class="day-filter" id="dayFilter">
      <button type="button" data-day="0" class="is-active">ì˜¤ëŠ˜</button>
      <button type="button" data-day="1">ì–´ì œ</button>
      <button type="button" data-day="2">ê·¸ì œ</button>
      <button type="button" data-day="3">3ì¼ì „</button>
      <button type="button" data-day="4">4ì¼ì „</button>
      <button type="button" data-day="7">1ì£¼</button>
    </div>
  </div>

  <!-- âœ… ì£¼ë¬¸ì…ë ¥ í™”ë©´: ì‘ì„± ì¤‘(ì…ë ¥ì¤‘/ì…ë ¥ì™„ë£Œ) ìƒí’ˆ ìš”ì•½ -->
  <div id="draftSummary"></div>

  <!-- âœ… ì™„ë£Œ í™”ë©´ì—ì„œë§Œ: ì™„ë£Œëœ ì£¼ë¬¸ëª©ë¡ ìš”ì•½ -->
  <div id="doneSummary"></div>

  <!-- âœ… ì™„ë£Œí™”ë©´ì—ì„œë§Œ: ì£¼ë¬¸ìƒì„¸ ë³´ê¸°/ë‹«ê¸° -->
  <div id="detailToggleWrap">
    <button class="small-link-btn" id="detailToggleBtn" type="button" onclick="toggleOrderDetail()">ì£¼ë¬¸ìƒì„¸ ë³´ê¸° â–¼</button>
    <!-- âœ… (ìˆ˜ì •) ë¬¸êµ¬ ë³€ê²½ -->
    <div class="detail-note">â€» ë°©ì†¡ì¢…ë£Œ ì „ê¹Œì§€ë§Œ â€˜ì£¼ë¬¸ìƒì„¸ ë³´ê¸°â€™ì—ì„œ ë³€ê²½ / ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  </div>

  <div id="products"></div>

  <div class="form-product-controls">
    <div class="button-line-2">
      <!-- âœ… (ìˆ˜ì •) + / âˆ’ ë¥¼ ë™ê·¸ë¼ë¯¸ ì²˜ë¦¬ -->
      <button class="btn-add btn-circle" type="button" onclick="addProduct()">
        <span class="icon-circle">+</span>
        ìƒí’ˆ ì¶”ê°€
      </button>
      <button class="btn-delete btn-circle" type="button" onclick="removeLastProduct()">
        <span class="icon-circle">âˆ’</span>
        ìƒí’ˆ ì‚­ì œ
      </button>
    </div>

    <!-- âœ… (ìš”ì²­ 2) ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€ -->
    <div class="form-under-note">â€» ì…ë ¥ í›„ ë°˜ë“œì‹œ 'ì£¼ë¬¸í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì£¼ë¬¸ì´ ì ‘ìˆ˜ë©ë‹ˆë‹¤.</div>
  </div>
</div>

<div class="section summary" id="summarySection">
  <div class="summary-line"><span>ìƒí’ˆ í•©ê³„</span><span id="sum">0ì›</span></div>
  <div class="summary-line"><span>ë°°ì†¡ë¹„(ê¸ˆÂ·í† Â·ì¼ ì£¼ë¬¸ í•©ë°°ì†¡ ìë™ ì ìš©)</span><span id="shipping">4,000ì›</span></div>
  <div class="summary-line summary-total"><span>ì´ ê²°ì œê¸ˆì•¡</span><span id="total">4,000ì›</span></div>
</div>

<div class="section">
  <div class="section-title">ì…ê¸ˆ ê³„ì¢Œ</div>
  <div class="account-box">
    <div class="account-text" id="accountText">ì¹´ì¹´ì˜¤ë±…í¬ 3333-09797-1111 ìœ í˜œì •(ìœ ì„¸ì—°)</div>
    <button class="copy-btn" type="button" onclick="copyAccount()">ë³µì‚¬</button>
  </div>
  <div class="pay-note" id="payNoteBelow">âš ï¸ ë°©ì†¡ ì¢…ë£Œ ì „ê¹Œì§€ ê¼­ ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.</div>
</div>

<!-- âœ… (ë³€ê²½: ìš”ì²­ 2) ì´ì œ bottomBarëŠ” ê³ ì •ì´ ì•„ë‹ˆë¼, ë³¸ë¬¸ ë§¨ ì•„ë˜ íë¦„ì— ìì—°ìŠ¤ëŸ½ê²Œ ìœ„ì¹˜ -->
<div id="bottomBar">
  <div id="bottomBarInner">

    <!-- âœ… ì£¼ë¬¸ ì…ë ¥ í™”ë©´ í•˜ë‹¨ -->
    <div id="formControls">
      <!-- âœ… ì£¼ë¬¸í•˜ê¸°: ê°€ìš´ë° ì •ë ¬ 1ê°œ(í­ 2/3) -->
      <div class="button-center-one">
        <button class="btn-order" type="button" onclick="submitOrder()">ì£¼ë¬¸í•˜ê¸°</button>
      </div>

      <!-- âœ… ë‹¤ìŒ ì¤„: ì…ë ¥ ë‚´ìš© í™•ì¸ / ì™„ë£Œëœ ì£¼ë¬¸ ë‹¤ì‹œë³´ê¸° -->
      <div class="button-line-2">
        <!-- âœ… (ìš”ì²­ 4) ë¬¸êµ¬ ë³€ê²½ -->
        <button class="btn-check btn-outline-blue" type="button" onclick="checkOrder()">ì…ë ¥ ë‚´ìš© í™•ì¸í•˜ê¸°</button>
        <button class="btn-replay" type="button" onclick="goCompletePreview()">ì™„ë£Œëœ ì£¼ë¬¸ ë‹¤ì‹œë³´ê¸°</button>
      </div>
    </div>

    <!-- âœ… ì™„ë£Œ í™”ë©´ í•˜ë‹¨ -->
    <div id="completeControls" style="display:none;">
      <!-- âœ… ì¶”ê°€ ì£¼ë¬¸í•˜ê¸°: ê°€ìš´ë° ì •ë ¬ 1ê°œ(í­ 2/3) -->
      <div class="button-center-one">
        <!-- âœ…âœ…âœ… (ë³€ê²½) ë¬¸êµ¬: "ì¶”ê°€ ì£¼ë¬¸í•˜ê¸°" â†’ "ê³„ì† ì£¼ë¬¸í•˜ê¸°" (ì›í•˜ë©´ ìœ ì§€í•´ë„ ë¨) -->
        <button class="btn-add-order" type="button" onclick="goToFormForAdd()">ê³„ì† ì£¼ë¬¸í•˜ê¸°</button>
      </div>

      <!-- âœ… ë‹¤ìŒ ì¤„: ì£¼ë¬¸ ë‚´ì—­ ë³´ê¸° / ì£¼ë¬¸ ë‚´ì—­ ë³µì‚¬ -->
      <div class="button-line-2">
        <button class="btn-history-view btn-outline-blue" type="button" onclick="showOrderHistory()">ì£¼ë¬¸ ë‚´ì—­ ë³´ê¸°</button>
        <!-- âœ… (ìš”ì²­ 6) ë¬¸êµ¬ + ìŠ¤íƒ€ì¼ ë³€ê²½ -->
        <button class="btn-history-copy" type="button" onclick="copyOrderHistory()">ì£¼ë¬¸ ë‚´ì—­ ë³µì‚¬í•˜ê¸°</button>
      </div>
    </div>

    <!-- âœ… (ìš”ì²­) ë§¨ í•˜ë‹¨: ë§í’ì„ (ì™¼ìª½) + ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜(ì˜¤ë¥¸ìª½) -->
    <div class="help-wrap">
      <div class="help-row">
        <div class="help-title"><span class="bubble">ğŸ’¬</span>ì£¼ë¬¸ í›„ ë¬¸ì˜ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?</div>
        <a class="help-link" href="http://pf.kakao.com/_exnahX/chat"><span class="bubble">ğŸ’¬</span>ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜í•˜ê¸° &gt;</a>
      </div>
    </div>

  </div>
</div>

<script>
  const SHIPPING = 4000;
  const productsDiv = document.getElementById("products");

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCu_DcAqqKEMficVO9Wo-P3tq5rjP-ETtXFBauRWXie1uObRQ_EAAeAuBwuoKfhMr-vQ/exec";
  const PAY_NOTICE = "âš ï¸ ë°©ì†¡ ì¢…ë£Œ ì „ê¹Œì§€ ê¼­ ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.";

  // âœ… 7) ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜ ë§í¬
  const KAKAO_CHAT_URL = "http://pf.kakao.com/_exnahX/chat";

  let IS_LOADING = false;

  // âœ… ì£¼ë¬¸ìƒì„¸(ì™„ë£Œí™”ë©´) ì ‘ê¸°/í¼ì¹˜ê¸°
  let ORDER_DETAIL_OPEN = false;

  // âœ… ê³ ê°ì´ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ” ì´ìƒ, ê¸°í•œ ì—†ì´ ì €ì¥ (customerëŠ” ë³„ë„ ë³´ê´€)
  const LS_CUSTOMER_KEY = "orderCustomer";
  const LS_ORDER_KEY = "orderData";
  const ORDER_TTL_MS = 7 * 24 * 60 * 60 * 1000; // âœ… (ìš”ì²­ 4) 7ì¼

  // âœ… ì£¼ë¬¸ IDëŠ” (ì£¼ë¬¸ ë°°ì¹˜ ë‹¨ìœ„)ë¡œ ì‚¬ìš©
  let ACTIVE_DRAFT_ORDER_ID = "";
  let LAST_DONE_ORDER_ID = "";

  // âœ… (ì¶”ê°€) ì™„ë£Œ ìš”ì•½ ë‚ ì§œ í•„í„°(ê¸°ë³¸: ì˜¤ëŠ˜=0)
  let DONE_FILTER_OFFSET = 0;

  // ==================================================
  // âœ…âœ…âœ… [ë³€ê²½] ë°°ì†¡ë¹„ ë¶€ê³¼ìš© ìƒíƒœ
  // - í‰ì¼(ì›”~ëª©): orderId|ë°©ì†¡ì¼ì(08:00 ê¸°ì¤€) 1íšŒ
  // - ì£¼ë§(ê¸ˆ/í† /ì¼): orderId|WEEKEND:ê·¸ ì£¼ì˜ ê¸ˆìš”ì¼ ë‚ ì§œ 1íšŒ (ê¸ˆ~ì¼ í†µí‹€ì–´ 1íšŒ)
  // ==================================================
  let SHIPPING_CHARGED = {}; // { ["orderId|..."]: true }

  // âœ… (ë³€ê²½: ìš”ì²­ 2) í•˜ë‹¨ë°” ë†’ì´ ë³´ì •ì€ ë¶ˆí•„ìš” â†’ í•­ìƒ 16px ìœ ì§€
  function updateBottomSpacing(){
    document.body.style.paddingBottom = "16px";
  }
  window.addEventListener("load", updateBottomSpacing);
  window.addEventListener("resize", updateBottomSpacing);
  window.addEventListener("orientationchange", updateBottomSpacing);

  /* ==================================================
     âœ…âœ…âœ… (ë³€ê²½: ìš”ì²­ 2) í‚¤ë³´ë“œ open/closeë¡œ bottomBar ìˆ¨ê¹€ ê¸°ëŠ¥ ì‚­ì œ
     - ê¸°ì¡´ í•¨ìˆ˜ í˜¸ì¶œì´ ë‚¨ì•„ ìˆì–´ë„ ì•ˆì „í•˜ê²Œ noop ì²˜ë¦¬
     ================================================== */
  function setKeyboardOpen_(open){
    // no-op (bottomBar ê³ ì • ì‚­ì œë¨)
    return;
  }

  /* ==================================================
     âœ…âœ…âœ… [ì¶”ê°€] ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ ê°•ì¡°(ë§ˆì§€ë§‰ ì…ë ¥ ì™„ë£Œ ìœ ë„)
     ================================================== */
  function pulseOrderBtn_(){
    const btn = document.querySelector('#formControls .btn-order');
    if (!btn) return;
    btn.classList.remove("btn-pulse");
    // reflow
    void btn.offsetWidth;
    btn.classList.add("btn-pulse");
    setTimeout(()=>btn.classList.remove("btn-pulse"), 950);
  }

  /* ==================================================
     âœ…âœ…âœ… [ì¶”ê°€] ì„ì˜ ë²„íŠ¼ ê°•ì¡°(ë°°ì†¡ì§€ ì €ì¥ / ë³€ê²½ì™„ë£Œ ë“± ê³µìš©)
     ================================================== */
  function pulseBtnEl_(btn){
    if (!btn) return;
    btn.classList.remove("btn-pulse");
    void btn.offsetWidth;
    btn.classList.add("btn-pulse");
    setTimeout(()=>btn.classList.remove("btn-pulse"), 950);
  }

  /* ==================================================
     âœ…âœ…âœ… [ì¶”ê°€] ëª¨ë°”ì¼ í‚¤ë³´ë“œ ê°•ì œ ë‹«ê¸°(í¬ì»¤ìŠ¤ í•´ì œ)
     - ë§ˆì§€ë§‰ ì…ë ¥ ì™„ë£Œ í›„ ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ìœ¼ë¡œ ìœ ë„í•  ë•Œ ì‚¬ìš©
     ================================================== */
  function closeKeyboard_(){
    try{
      const a = document.activeElement;
      if (a && typeof a.blur === "function") a.blur();
    }catch(e){}
  }

  /* ==================================================
     âœ…âœ…âœ… (ë³€ê²½: ìš”ì²­ 2) bottomBar ê°€ë¦¼ ë³´ì • ë¶ˆí•„ìš”(ê³ ì • ì•„ë‹˜)
     - ê·¸ë˜ë„ ê¸°ì¡´ í˜¸ì¶œì„ ìœ ì§€í•˜ê¸° ìœ„í•´ scrollIntoView ì¤‘ì‹¬ ë³´ì •ë§Œ ì‚´ì§
     ================================================== */
  function ensureVisibleWithBottomBar_(el){
    try{
      if (!el) return;
      const r = el.getBoundingClientRect();
      if (r.top < 8 || r.bottom > window.innerHeight - 8){
        el.scrollIntoView({ behavior:"smooth", block:"center" });
      }
    }catch(e){}
  }

  // í¬ì»¤ìŠ¤ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ë³´ì • (form ëª¨ë“œì—ì„œë§Œ)
  document.addEventListener("focusin", (e)=>{
    const t = e.target;
    if (!t) return;
    if (MODE !== "form") return;
    if (!(t.matches("input, select, textarea"))) return;

    // âœ… (ê¸°ì¡´ í˜¸ì¶œ ìœ ì§€ / noop)
    setKeyboardOpen_(true);

    setTimeout(()=>ensureVisibleWithBottomBar_(t), 50);
  });

  document.addEventListener("focusout", ()=>{
    setTimeout(()=>{
      if (MODE !== "form") return;
      const a = document.activeElement;
      const stillInput = a && (a.matches && a.matches("input, select, textarea"));
      if (!stillInput) setKeyboardOpen_(false);
    }, 120);
  });

  function newOrderId_(){
    return "oid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }
  function ensureDraftOrderId_(){
    if (!ACTIVE_DRAFT_ORDER_ID) ACTIVE_DRAFT_ORDER_ID = newOrderId_();
    return ACTIVE_DRAFT_ORDER_ID;
  }

  /* ==================================================
     âœ…âœ…âœ… [ì¶”ê°€] eventId ìƒì„± (í´ë¦­/ì´ë²¤íŠ¸ ë‹¨ìœ„ ë°°ì¹˜ID)
     ================================================== */
  function newEventId_(){
    return "ev_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  let MODE = "form"; // form | complete

  let SHIP_EDITING = false;
  let SHIP_SNAPSHOT = null;

  function hasAnyDoneItems_(){
    return Array.from(document.querySelectorAll(".product")).some(p=>{
      const st = p.dataset.status || "draft";
      return (st === "sent" || st === "modified" || st === "canceled" || st === "shipped");
    });
  }

  function pad2_(n){ return String(n).padStart(2,"0"); }

  function formatKstDateOnly_(d){
    const yyyy = d.getUTCFullYear();
    const mm = pad2_(d.getUTCMonth()+1);
    const dd = pad2_(d.getUTCDate());
    return `${yyyy}.${mm}.${dd}`;
  }

  /* ==================================================
     âœ… (ì¶”ê°€/ìˆ˜ì •) KST ê³ ì • + ë°©ì†¡ ì‹œíŠ¸ ë‚ ì§œ ê·œì¹™
     - 08:00~23:59 => ì˜¤ëŠ˜ ë‚ ì§œ
     - 00:00~07:59 => ì „ë‚  ë‚ ì§œ
     ================================================== */
  function _kstPartsNow_(){
    const parts = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Asia/Seoul",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).formatToParts(new Date());
    const get = (t)=> parts.find(p=>p.type===t)?.value;
    return {
      yyyy: Number(get("year")),
      mm: Number(get("month")),
      dd: Number(get("day")),
      hh: Number(get("hour")),
      mi: Number(get("minute")),
      ss: Number(get("second"))
    };
  }

  // âœ… "í˜„ì¬ KST"ë¥¼ Date(UTCê¸°ë°˜)ë¡œ ë°˜í™˜ (í•´ì™¸ì—ì„œë„ ë™ì¼)
  function kstNowDate_(){
    const p = _kstPartsNow_();
    return new Date(Date.UTC(p.yyyy, p.mm-1, p.dd, p.hh, p.mi, p.ss));
  }

  // âœ… KST ë¬¸ìì—´ (yyyy-MM-dd HH:mm:ss)
  function kstNowString(){
    const p = _kstPartsNow_();
    const yyyy = String(p.yyyy);
    const mm = pad2_(p.mm);
    const dd = pad2_(p.dd);
    const hh = pad2_(p.hh);
    const mi = pad2_(p.mi);
    const ss = pad2_(p.ss);
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  // âœ… ë°©ì†¡ ì‹œíŠ¸ëª… (yyyy-MM-dd) / ì™„ë£Œ ìš”ì•½ ë‚ ì§œ ê¸°ì¤€ë„ ë™ì¼ ì‚¬ìš©
  function getBroadcastSheetNameKST_(){
    const p = _kstPartsNow_(); // KST
    const baseUtc = new Date(Date.UTC(p.yyyy, p.mm-1, p.dd, 0, 0, 0)); // KST ìì •(í‘œí˜„ì€ UTCê¸°ë°˜)
    if (p.hh < 8) baseUtc.setUTCDate(baseUtc.getUTCDate() - 1);

    const y = baseUtc.getUTCFullYear();
    const m = pad2_(baseUtc.getUTCMonth()+1);
    const d = pad2_(baseUtc.getUTCDate());
    return `${y}-${m}-${d}`;
  }

  // âœ…âœ…âœ… [ì¶”ê°€] ì£¼ë§(ê¸ˆ/í† /ì¼) ë¬¶ìŒìš©: "ê·¸ ì£¼ì˜ ê¸ˆìš”ì¼" ë‚ ì§œí‚¤(yyyy-MM-dd) êµ¬í•˜ê¸°
  function weekendAnchorFridayKey_(broadcastDateKey){
    const m = String(broadcastDateKey||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return broadcastDateKey;

    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    const dt = new Date(Date.UTC(y, mo-1, d, 0, 0, 0));
    const dow = dt.getUTCDay(); // 0=ì¼,1=ì›”,...,5=ê¸ˆ,6=í† 

    // ê¸ˆ(5)ë©´ ê·¸ëŒ€ë¡œ, í† (6)ë©´ -1ì¼, ì¼(0)ë©´ -2ì¼ -> ëª¨ë‘ ê¸ˆìš”ì¼ë¡œ ê³ ì •
    if (dow === 6) dt.setUTCDate(dt.getUTCDate() - 1);
    else if (dow === 0) dt.setUTCDate(dt.getUTCDate() - 2);

    const yy = dt.getUTCFullYear();
    const mm = pad2_(dt.getUTCMonth()+1);
    const dd = pad2_(dt.getUTCDate());
    return `${yy}-${mm}-${dd}`;
  }

  // âœ…âœ…âœ… [ì¶”ê°€] ë°°ì†¡ë¹„ 1íšŒ ë¶€ê³¼ìš© key ìƒì„±: ì£¼ë§ì´ë©´ "ì£¼ë§ê·¸ë£¹", í‰ì¼ì´ë©´ "ë‚ ì§œë³„"
  function shippingChargeKey_(orderId, broadcastDateKey){
    const oid = String(orderId || "").trim();
    const dk  = String(broadcastDateKey || "").trim();
    if (!oid || !dk) return "";

    const m = dk.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return `${oid}|${dk}`;

    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    const dt = new Date(Date.UTC(y, mo-1, d, 0, 0, 0));
    const dow = dt.getUTCDay(); // 0=ì¼,5=ê¸ˆ,6=í† 

    const isWeekend = (dow === 5 || dow === 6 || dow === 0);
    if (isWeekend){
      const friKey = weekendAnchorFridayKey_(dk);
      return `${oid}|WEEKEND:${friKey}`; // ê¸ˆ/í† /ì¼ì€ ê°™ì€ í‚¤ë¡œ ë¬¶ì„
    }

    return `${oid}|${dk}`; // ì›”~ëª©ì€ ë‚ ì§œë³„
  }

  function isShippingChargedForOrderDate_(orderId, dateKey){
    const k = shippingChargeKey_(orderId, dateKey);
    if (!k) return false;
    return !!SHIPPING_CHARGED[k];
  }
  function markShippingCharged_(orderId, dateKey){
    const k = shippingChargeKey_(orderId, dateKey);
    if (!k) return;
    SHIPPING_CHARGED[k] = true;
  }

  // âœ… offsetì¼ ì „(0=ì˜¤ëŠ˜) ë°©ì†¡ì¼ì yyyy-MM-dd
  function getBroadcastSheetNameKSTByOffset_(offsetDays){
    const today = getBroadcastSheetNameKST_(); // yyyy-MM-dd
    const m = String(today).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return today;
    const y = Number(m[1]), mo = Number(m[2]), da = Number(m[3]);
    const d0 = new Date(Date.UTC(y, mo-1, da, 0, 0, 0));
    d0.setUTCDate(d0.getUTCDate() - Number(offsetDays || 0));
    const yy = d0.getUTCFullYear();
    const mm = pad2_(d0.getUTCMonth()+1);
    const dd = pad2_(d0.getUTCDate());
    return `${yy}-${mm}-${dd}`;
  }

  function formatBroadcastDateText_(yyyy_mm_dd){
    const m = String(yyyy_mm_dd||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return "";
    return `${m[1]}.${m[2]}.${m[3]}`;
  }

  /* ==================================================
     âœ…âœ…âœ… (ìš”ì²­ 3) "1ì£¼" ì„ íƒ ì‹œ: ìµœê·¼ 1ì£¼(7ì¼) ì „ì²´ ë‚ ì§œ ëª©ë¡
     - offset==7 ì¼ ë•Œ: ì˜¤ëŠ˜(0)ë¶€í„° 6ì¼ ì „ê¹Œì§€
     ================================================== */
  function getTargetDateListByOffset_(offset){
    const off = Number(offset);
    if (off === 7){
      const arr = [];
      for (let i=0; i<=6; i++){
        arr.push(getBroadcastSheetNameKSTByOffset_(i));
      }
      return arr; // ìµœì‹  -> ê³¼ê±°(0,1,2..)
    }
    return [ getBroadcastSheetNameKSTByOffset_(off) ];
  }

  function formatDateRangeTextFromList_(dateList){
    if (!dateList || dateList.length === 0) return "";
    if (dateList.length === 1) return formatBroadcastDateText_(dateList[0]);
    // dateListëŠ” [ì˜¤ëŠ˜..6ì¼ì „] ì´ë¯€ë¡œ, í‘œì‹œìš©ì€ (6ì¼ì „ ~ ì˜¤ëŠ˜)
    const newest = dateList[0];
    const oldest = dateList[dateList.length - 1];
    return `${formatBroadcastDateText_(oldest)} ~ ${formatBroadcastDateText_(newest)}`;
  }

  // âœ… (ìš”ì²­ 3) ë‚ ì§œ ê¸°ì¤€: ë°œì†¡ì™„ë£Œë¡œ ë°”ë€Œì–´ë„ "ì›ë˜ ì£¼ë¬¸ ë‚ ì§œ(doneDate)" ìœ ì§€
  function _itemDateKey_(p){
    return (p.dataset.doneDate || "").trim();
  }

  function _hasAnyForDates_(dateList){
    const set = new Set((dateList || []).map(String));
    return Array.from(document.querySelectorAll(".product")).some(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified" || st === "canceled" || st === "shipped")) return false;
      return set.has(_itemDateKey_(p));
    });
  }

  // âœ… (ìš”ì²­ 1) "ì™„ì „ ë¹ˆ" ìƒí’ˆì¹´ë“œ íŒë³„ (input + select)
  function isBlankProductCard_(p){
    const els = p.querySelectorAll("input, select");
    const name  = (els[0]?.value || "").trim();
    const color = (els[1]?.value || "").trim();
    const size  = (els[2]?.value || "").trim();
    const qty   = (els[3]?.value || "").trim();
    const price = (els[4]?.value || "").trim();
    return (!name && !color && !size && !qty && !price);
  }

  // âœ… 1) ì™„ë£Œ ë°°ë„ˆ ë¬¸êµ¬(ìˆœì„œ/ë¬¸êµ¬ ë³€ê²½ + íŒŒë€ìƒ‰ ê°•ì¡°)
  function setBanner(text){
    const banner = document.getElementById("modeBanner");
    if (!banner) return;

    const main = banner.querySelector(".banner-main");
    const oidBox = banner.querySelector(".banner-oid");

    if (main) main.textContent = text || "";

    const oid = (LAST_DONE_ORDER_ID || "").trim();

    // âœ… (ìˆ˜ì •) ì£¼ë¬¸ë²ˆí˜¸ ì• ë‚ ì§œë¥¼ "ë°©ì†¡ì¼ì(08:00 ê¸°ì¤€)"ë¡œ í‘œì‹œ
    const broadcastDateText = formatBroadcastDateText_(getBroadcastSheetNameKST_());
    const line1 = oid ? `${broadcastDateText} ì£¼ë¬¸ë²ˆí˜¸ëŠ” ${oid} ì…ë‹ˆë‹¤.` : "";

    const line3 = `â€» ê¸°ê¸°Â·ë¸Œë¼ìš°ì €ê°€ ë‹¤ë¥´ë©´ ì´ì „ ì£¼ë¬¸ì´ ë³´ì´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;

    if (oidBox){
      oidBox.innerHTML = `
        ${line1 ? `<div>${line1}</div>` : ""}
        <div style="color:#005FAE; font-weight:900;">${line3}</div>
      `;
    }
  }

  function focusBanner(){
    const banner = document.getElementById("modeBanner");
    if (!banner) return;
    banner.scrollIntoView({ behavior:"smooth", block:"start" });
    setTimeout(()=>banner.focus(), 250);
  }

  function goCompletePreview(){
    if (!hasAnyDoneItems_()){
      alert("ì£¼ë¬¸ ì ‘ìˆ˜ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    setMode("complete", "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.", { detailClosedOnEnter:true });
  }

  // âœ… 7) ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜ ì´ë™ (í˜„ì¬ UIì—ì„œëŠ” ë²„íŠ¼ ì œê±°í–ˆì§€ë§Œ, í•¨ìˆ˜ëŠ” ìœ ì§€)
  function goKakaoChat(){
    window.location.href = KAKAO_CHAT_URL;
  }

  function copyAccount(){
    const el = document.getElementById("accountText");
    const text = el ? el.innerText : "";
    const accountNumberOnly = text.replace(/[^0-9]/g, "");
    try{
      navigator.clipboard.writeText(accountNumberOnly);
      alert("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³„ì¢Œë²ˆí˜¸ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
    }
  }

  function searchAddress(){
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById("address").value = data.address;
        document.getElementById("addressDetail").focus();
        setTimeout(()=>ensureVisibleWithBottomBar_(document.getElementById("addressDetail")), 50);
        saveData();
      }
    }).open();
  }

  function showHelp(){
    alert("ë¬¸ì˜ëŠ” ì¹´ì¹´ì˜¤í†¡ ì±„ë„(ë˜ëŠ” ìƒë‹´ì°½)ë¡œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n\nì˜ˆ) ì¹´ì¹´ì˜¤í†¡ì—ì„œ â€˜ì‹¸Uâ€™ ì±„ë„ì„ ê²€ìƒ‰ í›„ ë©”ì‹œì§€ ë³´ë‚´ê¸°");
  }

  function formatPhoneKR_(value){
    const digits = String(value || "").replace(/\D/g, "").slice(0, 11);
    if (digits.length <= 3) return digits;
    if (digits.length <= 7) return `${digits.slice(0,3)}-${digits.slice(3)}`;
    return `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7)}`;
  }

  function _uid(){
    return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  function _fmtMoney_(v){
    const n = Number(v || 0);
    return n.toLocaleString() + "ì›";
  }

  function snapshotCustomer(){
    return {
      nickname: document.getElementById("nickname").value || "",
      name: document.getElementById("name").value || "",
      phone: document.getElementById("phone").value || "",
      address: document.getElementById("address").value || "",
      addressDetail: document.getElementById("addressDetail").value || ""
    };
  }

  function renderShippingSummary(){
    const box = document.getElementById("shipSummary");
    if (!box) return;

    const c = snapshotCustomer();
    const fullAddr = `${(c.address||"").trim()} ${(c.addressDetail||"").trim()}`.trim();

    box.innerHTML = `
      <div>ë‹‰ë„¤ì„: <b>${(c.nickname||"-")}</b></div>
      <div>ìˆ˜ë ¹ì¸: <b>${(c.name||"-")}</b></div>
      <div>ì—°ë½ì²˜: <b>${(c.phone||"-")}</b></div>
      <div style="margin-top:6px;">ì£¼ì†Œ: <b>${fullAddr || "-"}</b></div>
    `;
  }

  function lockProductInputs(div, lock){
    const els = div.querySelectorAll("input, select");
    for (let k=0;k<5;k++){
      if (!els[k]) continue;
      els[k].readOnly = lock;
      els[k].disabled = lock;
    }
    if (lock) div.classList.add("is-locked");
    else div.classList.remove("is-locked");
  }

  function updateDetailToggleUI_(){
    const btn = document.getElementById("detailToggleBtn");
    if (!btn) return;
    btn.textContent = ORDER_DETAIL_OPEN ? "ì£¼ë¬¸ìƒì„¸ ë‹«ê¸° â–²" : "ì£¼ë¬¸ìƒì„¸ ë³´ê¸° â–¼";
  }

  function applyProductVisibility_(){
    const targetDates = getTargetDateListByOffset_(DONE_FILTER_OFFSET);
    const set = new Set(targetDates.map(String));

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";

      if (MODE === "complete"){
        if (st === "draft"){
          p.style.display = "none";
          return;
        }

        if (ORDER_DETAIL_OPEN){
          const key = _itemDateKey_(p);
          p.style.display = set.has(key) ? "block" : "none";
        } else {
          p.style.display = "none";
        }
        return;
      }

      if (st === "draft"){
        p.style.display = "block";
      } else {
        p.style.display = "none";
      }
    });

    updateDetailToggleUI_();

    document.querySelectorAll(".product").forEach(p=>{
      refreshProductActionRows_(p);
    });
  }

  function toggleOrderDetail(){
    if (MODE !== "complete") return;
    ORDER_DETAIL_OPEN = !ORDER_DETAIL_OPEN;
    applyProductVisibility_();
    saveData();
  }

  function setMode(mode, bannerText, opts){
    opts = opts || {};

    if (mode === "complete" && !opts.allowEmpty && !hasAnyDoneItems_()){
      alert("ì£¼ë¬¸ ì ‘ìˆ˜ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    MODE = mode;

    document.body.classList.remove("mode-form","mode-complete");
    document.body.classList.add("mode-" + MODE);

    const formControls = document.getElementById("formControls");
    const completeControls = document.getElementById("completeControls");
    const shipActions = document.getElementById("shipActions");

    const customerTitle = document.getElementById("customerSectionTitle");
    const productTitle = document.getElementById("productSectionTitle");

    if (MODE === "complete"){
      formControls.style.display = "none";
      completeControls.style.display = "flex";
      shipActions.style.display = "flex";

      if (customerTitle) customerTitle.textContent = "ë°°ì†¡ì§€ ì •ë³´";
      if (productTitle) productTitle.textContent = "ì£¼ë¬¸ìƒí’ˆ ì •ë³´";

      setBanner(bannerText || "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");

      if (opts.detailClosedOnEnter === true) ORDER_DETAIL_OPEN = false;

      exitShipEdit(true);

      renderShippingSummary();

      DONE_FILTER_OFFSET = 0;
      setActiveDayButton_(0);

      renderDoneSummary();
      renderDraftSummary();

      updateShippingStatuses_(true);

      document.querySelectorAll(".product").forEach(p=>{
        const isEditing = (p.dataset.editing === "1");
        lockProductInputs(p, !isEditing);
        setBadge(p);
      });

      applyProductVisibility_();
      calc();
      saveData();
      setTimeout(focusBanner, 50);

      setTimeout(updateBottomSpacing, 0);
      return;
    }

    formControls.style.display = "flex";
    completeControls.style.display = "none";
    shipActions.style.display = "none";

    if (customerTitle) customerTitle.textContent = "ê³ ê° ì •ë³´";
    if (productTitle) productTitle.textContent = "ìƒí’ˆì •ë³´";

    exitShipEdit(true);

    renderDoneSummary();
    renderDraftSummary();

    document.querySelectorAll(".product").forEach(p=>{
      lockProductInputs(p, false);
      setBadge(p);
    });

    updateShippingStatuses_(true);

    applyProductVisibility_();
    calc();
    saveData();

    setTimeout(updateBottomSpacing, 0);
  }

  function setBadge(div){
    const st = div.dataset.status || "draft";
    const badge = div.querySelector(".status-badge");
    if (!badge) return;

    badge.style.display = "inline-flex";
    badge.className = "status-badge";

    if (MODE === "complete" && div.dataset.editing === "1"){
      badge.classList.add("status-editing");
      badge.innerHTML = `<span class="sq"></span>ë³€ê²½ì¤‘`;
      return;
    }

    if (st === "canceled"){
      badge.classList.add("status-canceled");
      badge.innerHTML = `<span class="sq"></span>ì·¨ì†Œì™„ë£Œ`;
      return;
    }
    if (st === "shipped"){
      badge.classList.add("status-shipped");
      badge.innerHTML = `<span class="sq"></span>ë°œì†¡ì™„ë£Œ`;
      return;
    }
    if (st === "modified"){
      badge.classList.add("status-modified");
      badge.innerHTML = `<span class="sq"></span>ë³€ê²½ì™„ë£Œ`;
      return;
    }
    if (st === "sent"){
      badge.classList.add("status-sent");
      badge.innerHTML = `<span class="sq"></span>ì£¼ë¬¸ì™„ë£Œ`;
      return;
    }

    badge.style.display = "none";
  }

  // âœ… (ì¶”ê°€) ì™„ë£Œ ìš”ì•½ ë‚ ì§œ í•„í„° ë²„íŠ¼ í™œì„± í‘œì‹œ
  function setActiveDayButton_(offset){
    const wrap = document.getElementById("dayFilter");
    if (!wrap) return;
    wrap.querySelectorAll("button").forEach(b=>{
      const v = Number(b.getAttribute("data-day"));
      if (v === Number(offset)) b.classList.add("is-active");
      else b.classList.remove("is-active");
    });
  }

  // âœ… (ìˆ˜ì •) ì™„ë£Œ ìš”ì•½: ì„ íƒí•œ ë‚ ì§œ(ë°©ì†¡ì¼ì ê¸°ì¤€)ë§Œ í‘œì‹œ + ë‚ ì§œ 1íšŒë§Œ ì¶œë ¥
  // âœ… (ìš”ì²­ 3) 1ì£¼ ì„ íƒ ì‹œ: ìµœê·¼ 1ì£¼ ì „ì²´ í‘œì‹œ(ë‚ ì§œë³„ë¡œ ë¬¶ì–´ì„œ)
  function renderDoneSummary(){
    const box = document.getElementById("doneSummary");
    if (!box) return;

    if (MODE !== "complete"){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    const targetDates = getTargetDateListByOffset_(DONE_FILTER_OFFSET);
    const set = new Set(targetDates.map(String));

    const allItems = [];
    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified" || st === "canceled" || st === "shipped")) return;

      const key = _itemDateKey_(p);
      if (!set.has(key)) return;

      const els = p.querySelectorAll("input, select");
      const name = (els[0]?.value || "").trim();
      const color = (els[1]?.value || "").trim();
      const size = (els[2]?.value || "").trim();
      const qty = Number((els[3]?.value || "").trim() || 0);
      const price = Number((els[4]?.value || "").trim() || 0);

      const qtyText = qty ? `${qty}ê°œ` : "0ê°œ";
      const priceText = price ? _fmtMoney_(price) : "0ì›";

      const tag =
        (st === "canceled") ? "[ì·¨ì†Œì™„ë£Œ]" :
        (st === "shipped") ? "[ë°œì†¡ì™„ë£Œ]" :
        (st === "modified") ? "[ë³€ê²½ì™„ë£Œ]" :
        "[ì£¼ë¬¸ì™„ë£Œ]";

      allItems.push({
        dateKey: key,
        line: `â€¢ <b>${tag}</b> ${name} / ${color} / ${size} / ${qtyText} / ${priceText}`
      });
    });

    if (allItems.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    if (Number(DONE_FILTER_OFFSET) === 7){
      const rangeText = formatDateRangeTextFromList_(targetDates);
      const groups = {};
      allItems.forEach(x=>{
        (groups[x.dateKey] = groups[x.dateKey] || []).push(x.line);
      });

      const orderedDates = targetDates.filter(d=>groups[d] && groups[d].length);
      const htmlParts = [];
      htmlParts.push(`<div style="margin-bottom:8px; font-weight:900; color:#005FAE;">ìµœê·¼ 1ì£¼ (${rangeText})</div>`);

      orderedDates.forEach(d=>{
        htmlParts.push(`<div style="margin-top:8px; font-weight:900; color:#005FAE;">${formatBroadcastDateText_(d)}</div>`);
        htmlParts.push(`<div style="margin-top:6px;">${groups[d].join("<br>")}</div>`);
      });

      box.style.display = "block";
      box.innerHTML = htmlParts.join("");
      return;
    }

    const targetDate = targetDates[0];
    const dateTitle = formatBroadcastDateText_(targetDate);
    const lines = allItems.map(x=>x.line);

    box.style.display = "block";
    box.innerHTML = `
      <div style="margin-bottom:8px; font-weight:900; color:#005FAE;">${dateTitle}</div>
      ${lines.join("<br>")}
    `;
  }

  // âœ… ì£¼ë¬¸ì…ë ¥ í™”ë©´: ì‘ì„± ì¤‘ ìƒí’ˆ ìš”ì•½(ì…ë ¥ì¤‘/ì…ë ¥ì™„ë£Œ)
  function renderDraftSummary(){
    const box = document.getElementById("draftSummary");
    if (!box) return;

    if (MODE !== "form"){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    const lines = [];

    const drafts = Array.from(document.querySelectorAll(".product")).filter(p => (p.dataset.status === "draft"));
    drafts.forEach(p=>{
      if (isBlankProductCard_(p)) return;

      const els = p.querySelectorAll("input, select");
      const name = (els[0]?.value || "").trim();
      const color = (els[1]?.value || "").trim();
      const size = (els[2]?.value || "").trim();
      const qtyRaw = (els[3]?.value || "").trim();
      const priceRaw = (els[4]?.value || "").trim();

      const qty = Number(qtyRaw || 0);
      const price = Number(priceRaw || 0);

      const qtyText = qtyRaw ? `${qty}ê°œ` : "-";
      const priceText = priceRaw ? _fmtMoney_(price) : "-";

      const complete = (name && color && size && qty > 0 && price > 0);
      const tag = complete ? "[ì…ë ¥ì™„ë£Œ]" : "[ì…ë ¥ì¤‘]";

      lines.push(`â€¢ <b>${tag}</b> ${name || "-"} / ${color || "-"} / ${size || "-"} / ${qtyText} / ${priceText}`);
    });

    if (lines.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    box.style.display = "block";
    box.innerHTML = lines.join("<br>");
  }

  /* ==================================================
     âœ…âœ…âœ… [ìˆ˜ì •] ë‚ ì§œ í•„í„° ê¸°ì¤€ìœ¼ë¡œ í•©ê³„/ë°°ì†¡ë¹„/ì´ì•¡ ê³„ì‚°
     âœ…âœ…âœ… [ë³€ê²½] ë°°ì†¡ë¹„: (ì…ë ¥) ì£¼ë§ë¬¶ìŒ/í‰ì¼ë‚ ì§œë³„ í‚¤ / (ì™„ë£Œ) ë‚ ì§œí•„í„° ê¸°ì¤€
     ================================================== */
  function calc(){
    let sum = 0;

    if (MODE === "complete"){
      const targetDates = getTargetDateListByOffset_(DONE_FILTER_OFFSET);
      const set = new Set(targetDates.map(String));

      document.querySelectorAll(".product").forEach(p=>{
        const st = p.dataset.status || "draft";
        if (!(st === "sent" || st === "modified" || st === "shipped")) return;

        const key = _itemDateKey_(p);
        if (!set.has(key)) return;

        const els = p.querySelectorAll("input, select");
        const qty = Number((els[3]?.value || "").trim() || 0);
        const price = Number((els[4]?.value || "").trim() || 0);
        sum += (qty * price);
      });

    } else {
      document.querySelectorAll(".product").forEach(p=>{
        const st = p.dataset.status || "draft";
        if (st !== "draft") return;
        if (isBlankProductCard_(p)) return;

        const els = p.querySelectorAll("input, select");
        const qty = Number((els[3]?.value || "").trim() || 0);
        const price = Number((els[4]?.value || "").trim() || 0);
        sum += (qty * price);
      });
    }

    // âœ… ê¸°ë³¸ ë°°ì†¡ë¹„ ê·œì¹™ (10ë§Œ ì´ìƒ ë¬´ë£Œ)
    let shipping = 0;

    if (MODE === "complete"){
      // âœ… ì™„ë£Œí™”ë©´: ë‚ ì§œí•„í„° ê¸°ì¤€ìœ¼ë¡œ "ë‚ ì§œë³„ ë°°ì†¡ë¹„" í•©ì‚° í‘œì‹œ
      const targetDates = getTargetDateListByOffset_(DONE_FILTER_OFFSET);

      if (Number(DONE_FILTER_OFFSET) === 7){
        // ìµœê·¼ 1ì£¼: ë‚ ì§œë³„(ê° ë‚ ì§œ í•©ê³„ ê¸°ì¤€) ë°°ì†¡ë¹„ë¥¼ í•©ì‚°
        let shipSum = 0;
        targetDates.forEach(dateKey=>{
          let daySum = 0;
          document.querySelectorAll(".product").forEach(p=>{
            const st = p.dataset.status || "draft";
            if (!(st === "sent" || st === "modified" || st === "shipped")) return;
            if (_itemDateKey_(p) !== String(dateKey)) return;

            const els = p.querySelectorAll("input, select");
            const qty = Number((els[3]?.value || "").trim() || 0);
            const price = Number((els[4]?.value || "").trim() || 0);
            daySum += (qty * price);
          });
          shipSum += (daySum > 0 && daySum < 100000) ? SHIPPING : 0;
        });
        shipping = shipSum;
      } else {
        // ë‹¨ì¼ ë‚ ì§œ: ê·¸ ë‚ ì§œ í•©ê³„ ê¸°ì¤€ìœ¼ë¡œ ë°°ì†¡ë¹„ í‘œì‹œ
        shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;
      }

    } else {
      // âœ… ì…ë ¥í™”ë©´: (í‰ì¼) orderId+ë°©ì†¡ì¼ì ê¸°ì¤€ 1íšŒ / (ì£¼ë§) ê¸ˆ~ì¼ í†µí‹€ì–´ 1íšŒ
      shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

      const currentOrderId = (ACTIVE_DRAFT_ORDER_ID || "").trim();
      const todayKey = getBroadcastSheetNameKST_(); // âœ… ë°©ì†¡ì¼ì(08:00 ê¸°ì¤€)
      if (currentOrderId && isShippingChargedForOrderDate_(currentOrderId, todayKey)){
        shipping = 0;
      }
    }

    document.getElementById("sum").innerText = sum.toLocaleString() + "ì›";
    document.getElementById("shipping").innerText = shipping.toLocaleString() + "ì›";
    document.getElementById("total").innerText = (sum + shipping).toLocaleString() + "ì›";
  }

  /* ==================================================
     âœ…âœ…âœ… [êµì²´] sendPayload (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)
     ================================================== */
  async function sendPayload(payload){
    const body = JSON.stringify(payload);

    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 15000);

    try{
      if (navigator.sendBeacon){
        const blob = new Blob([body], { type:"text/plain;charset=UTF-8" });
        const ok = navigator.sendBeacon(SCRIPT_URL, blob);
        if (ok) return { ok:true, beacon:true };
      }

      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body,
        signal: controller.signal,
        keepalive: true
      });

      return { ok:true };
    } finally{
      clearTimeout(timeout);
    }
  }

  /***************************************
   * âœ…âœ…âœ… ë¯¸ì „ì†¡ í(Outbox) + ìë™ ì¬ì „ì†¡
   * - no-cors í™˜ê²½ì—ì„œ "í™•ì • ì„±ê³µ"ì„ ì•Œ ìˆ˜ ì—†ìœ¼ë‹ˆ
   *   1) ì¼ë‹¨ íì— ì €ì¥
   *   2) ê¸°íšŒ ë  ë•Œë§ˆë‹¤ ì¬ì „ì†¡
   *   3) ì„œë²„ëŠ” eventId ì¤‘ë³µë°©ì§€ë¡œ 1ë²ˆë§Œ ì €ì¥
   ***************************************/
  const OUTBOX_KEY = "orderOutboxQueue_v1";
  const OUTBOX_MAX = 50;                  // í ìµœëŒ€ ë³´ê´€ ê°œìˆ˜(ë„ˆë¬´ ìŒ“ì´ëŠ” ê±° ë°©ì§€)
  const OUTBOX_TTL_MS = 3 * 24 * 60 * 60 * 1000; // 3ì¼ ì§€ë‚˜ë©´ íê¸°
  const OUTBOX_FLUSH_MIN_INTERVAL = 8000; // flush ìµœì†Œ ê°„ê²©(ë„ˆë¬´ ìì£¼ ëŒì§€ ì•Šê²Œ)
  let OUTBOX_FLUSHING = false;
  let LAST_FLUSH_AT = 0;

  function outboxLoad_(){
    try{
      const arr = JSON.parse(localStorage.getItem(OUTBOX_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function outboxSave_(arr){
    // âœ… ì €ì¥ ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ë°˜í™˜(ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë§‰í˜/ìš©ëŸ‰ì´ˆê³¼ ëŒ€ë¹„)
    try{
      localStorage.setItem(OUTBOX_KEY, JSON.stringify(arr || []));
      return true;
    }catch(e){
      return false;
    }
  }
  function outboxCleanup_(arr){
    const now = Date.now();
    // ì˜¤ë˜ëœ ê²ƒ ì œê±°
    arr = (arr || []).filter(x => x && x.createdAt && (now - x.createdAt) <= OUTBOX_TTL_MS);
    // ê°œìˆ˜ ì œí•œ(ì˜¤ë˜ëœ ê²ƒë¶€í„° ì œê±°)
    if (arr.length > OUTBOX_MAX){
      arr.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
      arr = arr.slice(arr.length - OUTBOX_MAX);
    }
    return arr;
  }
  function outboxUpsert_(payload){
    const eid = String(payload?.eventId || "").trim();
    if (!eid) return false;

    let arr = outboxCleanup_(outboxLoad_());

    // ê°™ì€ eventIdë©´ ë®ì–´ì“°ê¸°(ì¤‘ë³µ ì €ì¥ ë°©ì§€)
    const idx = arr.findIndex(x => x.eventId === eid);
    const item = {
      eventId: eid,
      createdAt: Date.now(),
      tries: (idx >= 0 ? Number(arr[idx].tries||0) : 0),
      nextTryAt: Date.now(),
      payload
    };

    if (idx >= 0) arr[idx] = item;
    else arr.push(item);

    return outboxSave_(arr);
  }

  function outboxRemove_(eventId){
    const eid = String(eventId || "").trim();
    if (!eid) return true;
    const arr = outboxLoad_().filter(x => x && x.eventId !== eid);
    return outboxSave_(arr);
  }

  // âœ… ì¬ì‹œë„ ë°±ì˜¤í”„(ëŠë ¤ì§ ìµœì†Œ)
  function calcBackoffMs_(tries){
    // 0: ì¦‰ì‹œ, 1: 2s, 2: 5s, 3: 10s, 4: 20s, 5+: 30s
    const t = Number(tries || 0);
    if (t <= 0) return 0;
    if (t === 1) return 2000;
    if (t === 2) return 5000;
    if (t === 3) return 10000;
    if (t === 4) return 20000;
    return 30000;
  }

  // âœ… í ë¹„ìš°ê¸°(ì „ì†¡ ì‹œë„)
  async function flushOutbox_(opts){
    opts = opts || {};
    const now = Date.now();

    if (OUTBOX_FLUSHING) return;
    if (!opts.force && (now - LAST_FLUSH_AT) < OUTBOX_FLUSH_MIN_INTERVAL) return;

    let arr = outboxCleanup_(outboxLoad_());
    if (arr.length === 0) return;

    // ì•„ì§ ì‹œë„ì‹œê°„ ì•ˆ ëœ ê²ƒë“¤ì€ ì œì™¸
    const due = arr.filter(x => x && (Number(x.nextTryAt||0) <= now));
    if (due.length === 0){
      // ë„ˆë¬´ ìì£¼ ë„ëŠ” ê²ƒë§Œ ë§‰ê³  ì¢…ë£Œ
      LAST_FLUSH_AT = now;
      return;
    }

    OUTBOX_FLUSHING = true;
    LAST_FLUSH_AT = now;

    try{
      // ì˜¤ë˜ëœ ê²ƒë¶€í„° ìˆœì„œëŒ€ë¡œ (ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ë¶„ì‚°)
      due.sort((a,b)=>(Number(a.nextTryAt||0) - Number(b.nextTryAt||0)));

      for (const item of due){
        if (!item || !item.payload || !item.eventId) continue;

        // íê°€ ì¤‘ê°„ì— ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë‹ˆ ìµœì‹  ìƒíƒœ ì¬ë¡œë“œ í›„ ì¡´ì¬ì—¬ë¶€ í™•ì¸
        let latest = outboxCleanup_(outboxLoad_());
        const live = latest.find(x => x && x.eventId === item.eventId);
        if (!live) continue;

        // dueê°€ ì•„ë‹ˆë©´ íŒ¨ìŠ¤
        if (Number(live.nextTryAt||0) > Date.now()) continue;

        try{
          await sendPayload(live.payload);

          // âœ… ì „ì†¡ "ì‹œë„"ê°€ ì„±ê³µ(throw ì—†ìŒ) â†’ íì—ì„œ ì œê±°
          outboxRemove_(live.eventId);

        }catch(e){
          // âœ… ì‹¤íŒ¨ â†’ tries ì¦ê°€ + backoff ì ìš©
          latest = outboxCleanup_(outboxLoad_());
          const idx = latest.findIndex(x => x && x.eventId === live.eventId);
          if (idx >= 0){
            const t = Number(latest[idx].tries||0) + 1;
            latest[idx].tries = t;
            latest[idx].nextTryAt = Date.now() + calcBackoffMs_(t);
            outboxSave_(latest);
          }
        }
      }

    } finally{
      OUTBOX_FLUSHING = false;
    }
  }

  // âœ… payloadëŠ” "í•­ìƒ" íì— ë„£ê³ , flushëŠ” ê¸°íšŒë  ë•Œë§ˆë‹¤
  function queueSend_(payload){
    const ok = outboxUpsert_(payload);
    if (!ok){
      // localStorage ë§‰í˜/ìš©ëŸ‰ì´ˆê³¼ ë“±
      throw new Error("OUTBOX_SAVE_FAILED");
    }
    // fire-and-forget (UI ì²´ê° ëŠë ¤ì§ ìµœì†Œ)
    flushOutbox_({ force:true });
  }

  function parseKstStringToDate_(s){
    try{
      const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/);
      if (!m) return null;
      const yyyy = Number(m[1]);
      const mm = Number(m[2]);
      const dd = Number(m[3]);
      const hh = Number(m[4]);
      const mi = Number(m[5]);
      const ss = Number(m[6]);
      return new Date(Date.UTC(yyyy, mm-1, dd, hh, mi, ss));
    }catch(e){
      return null;
    }
  }

  /* ==================================================
     âœ…âœ…âœ… [ìˆ˜ì • 2] ë°œì†¡ì™„ë£Œ ìë™ ì „í™˜ ì‹œì : ì˜¤í›„ 5ì‹œ(17:00)
     ================================================== */
  function nextMondayNoonKst_(dKst){
    const dow = dKst.getUTCDay();
    const add = ((8 - dow) % 7) || 7;
    return new Date(Date.UTC(dKst.getUTCFullYear(), dKst.getUTCMonth(), dKst.getUTCDate()+add, 17, 0, 0));
  }

  function shippingDueAt_(orderTimeKstStr){
    const d = parseKstStringToDate_(orderTimeKstStr);
    if (!d) return null;

    const dow = d.getUTCDay();
    if (dow >= 1 && dow <= 4){
      return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()+1, 17, 0, 0));
    }
    return nextMondayNoonKst_(d);
  }

  function updateShippingStatuses_(silentSave){
    const now = kstNowDate_();
    let changed = false;

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified")) return;

      const ot = p.dataset.orderTime || "";
      const due = shippingDueAt_(ot);
      if (!due) return;

      if (now.getTime() >= due.getTime()){
        p.dataset.status = "shipped";
        if (!p.dataset.shipDate) p.dataset.shipDate = getBroadcastSheetNameKST_();
        setBadge(p);
        changed = true;
      }
    });

    if (changed){
      renderDoneSummary();
      renderDraftSummary();
      calc();
      applyProductVisibility_();
      if (!silentSave) saveData();
      else if (!IS_LOADING) saveData();
    }
  }

  function _productSnapshot_(div){
    const els = div.querySelectorAll("input, select");
    return JSON.stringify({
      name: els[0]?.value || "",
      color: els[1]?.value || "",
      size: els[2]?.value || "",
      qty: els[3]?.value || "",
      price: els[4]?.value || ""
    });
  }

  function _applySnapshot_(div, snapStr){
    try{
      const s = JSON.parse(snapStr || "{}");
      const els = div.querySelectorAll("input, select");
      els[0].value = s.name || "";
      els[1].value = s.color || "";
      els[2].value = s.size || "";
      els[3].value = s.qty || "";
      els[4].value = s.price || "";
    }catch(e){}
  }

  function _validateProductInputs_(div){
    const els = div.querySelectorAll("input, select");
    const name = (els[0].value || "").trim();
    const color = (els[1].value || "").trim();
    const size = (els[2].value || "").trim();
    const qty = Number((els[3].value || "").trim() || 0);
    const price = Number((els[4].value || "").trim() || 0);

    if (!name) { alert("ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); els[0].focus(); return false; }
    if (!color) { alert("ìƒ‰ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); els[1].focus(); return false; }
    if (!size) { alert("ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); els[2].focus(); return false; }
    if (!qty || qty <= 0) { alert("ìˆ˜ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); els[3].focus(); return false; }
    if (!price || price <= 0) { alert("ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); els[4].focus(); return false; }
    return true;
  }

  function refreshProductActionRows_(div){
    const st = div.dataset.status || "draft";

    const editOpenRow = div.querySelector('[data-edit-open="1"]');
    const editControlsRow = div.querySelector('[data-edit-controls="1"]');
    const cancelRow = div.querySelector('[data-cancel-row="1"]');

    const inDetail = (MODE === "complete" && ORDER_DETAIL_OPEN);

    const canEdit = inDetail && (st === "sent" || st === "modified") && (div.dataset.editing !== "1");
    if (editOpenRow) editOpenRow.style.display = canEdit ? "flex" : "none";

    if (editControlsRow) editControlsRow.style.display = (inDetail && div.dataset.editing === "1") ? "flex" : "none";

    if (cancelRow){
      const showOne = inDetail && (st === "sent" || st === "modified");
      cancelRow.style.display = showOne ? "flex" : "none";
      const btn = cancelRow.querySelector("button");
      if (btn) btn.disabled = !(st === "sent" || st === "modified");
    }
  }

  /* ==================================================
     âœ…âœ…âœ… (ìš”ì²­ 2) ê°€ê²© ì…ë ¥ "ì™„ë£Œ/í™•ì¸" ì²˜ë¦¬
     ================================================== */
  function handlePriceDone_(currentProductDiv){
    if (MODE !== "form") return;

    const drafts = Array.from(document.querySelectorAll('.product[data-status="draft"]'));
    const idx = drafts.indexOf(currentProductDiv);

    // âœ… ë‹¤ìŒ ìƒí’ˆì´ ìˆìœ¼ë©´ â†’ ë‹¤ìŒ ìƒí’ˆëª…ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™(í‚¤ë³´ë“œ ìœ ì§€)
    if (idx >= 0 && idx < drafts.length - 1){
      const next = drafts[idx + 1];
      const nameInput = next.querySelector(".product-name");
      if (nameInput){
        nameInput.focus();
        try{
          const len = nameInput.value.length;
          nameInput.setSelectionRange(len, len);
        }catch(e){}
        setTimeout(()=>ensureVisibleWithBottomBar_(nameInput), 50);
      }
      return;
    }

    // âœ…âœ…âœ… [ì¶”ê°€] ë§ˆì§€ë§‰ ìƒí’ˆì´ë©´ â†’ í‚¤ë³´ë“œ ë‹«ê³  ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ ìœ ë„
    closeKeyboard_();

    const btn = document.querySelector('#formControls .btn-order');
    if (btn){
      btn.scrollIntoView({ behavior:"smooth", block:"center" });
      setTimeout(()=>pulseOrderBtn_(), 120);
    }
  }

  function addProduct(preset){
    const div = document.createElement("div");
    div.className = "product";

    div.dataset.id = (preset && preset.id) ? preset.id : _uid();
    div.dataset.status = (preset && preset.status) ? preset.status : "draft";
    div.dataset.editing = (preset && preset.editing) ? preset.editing : "";
    div.dataset.snapshot = (preset && preset.snapshot) ? preset.snapshot : "";

    div.dataset.orderId = (preset && preset.orderId) ? preset.orderId : "";
    div.dataset.orderTime = (preset && preset.orderTime) ? preset.orderTime : "";

    div.dataset.doneDate = (preset && preset.doneDate) ? preset.doneDate : "";
    div.dataset.shipDate = (preset && preset.shipDate) ? preset.shipDate : "";

    div.innerHTML = `
      <div class="field">
        <label>ìƒí’ˆëª…</label>
        <div class="product-title-row">
          <input class="product-name" placeholder="ìƒí’ˆëª… í•˜ë‚˜ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.  ì˜ˆ) ì•„ë¯¸ ë§¨íˆ¬ë§¨">
          <div class="status-badge status-sent"><span class="sq"></span>ì£¼ë¬¸ì™„ë£Œ</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ìƒ‰ìƒ</label>
          <input placeholder="ì˜ˆ) ë¸”ë™ / ê²€ì •">
        </div>
        <div class="field">
          <label>ì‚¬ì´ì¦ˆ</label>
          <select required>
            <option value="" selected disabled>ì‚¬ì´ì¦ˆ ì„ íƒ</option>
            <option value="XS">XS(ì¼ë¶€ ìƒí’ˆë§Œ)</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="2XL">2XL(ì¼ë¶€ ìƒí’ˆë§Œ)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ìˆ˜ëŸ‰</label>
          <select required>
            <option value="" selected disabled>ìˆ˜ëŸ‰ ì„ íƒ</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
          </select>
        </div>
        <div class="field">
          <label>ê°€ê²©</label>
          <div class="money-wrap">
            <!-- âœ…âœ…âœ… (ìš”ì²­ 1) type="number" â†’ text + inputmode + enterkeyhint -->
            <input
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              enterkeyhint="done"
              placeholder="ì˜ˆ) 59000"
            >
            <span class="money-suffix">ì›</span>
          </div>
        </div>
      </div>

      <div class="edit-row" data-edit-open="1">
        <button class="btn-mini btn-edit-go" type="button">ë³€ê²½í•˜ê¸°</button>
      </div>

      <div class="edit-row" data-edit-controls="1">
        <button class="btn-mini btn-blue" type="button">ë³€ê²½ì™„ë£Œ</button>
        <button class="btn-mini btn-gray" type="button">ë³€ê²½ì·¨ì†Œ</button>
      </div>

      <div class="cancel-row" data-cancel-row="1">
        <button class="btn-item-cancel" type="button">ì´ ìƒí’ˆ ì·¨ì†Œí•˜ê¸°</button>
      </div>
    `;

    const els = div.querySelectorAll("input, select");
    if (preset){
      els[0].value = preset.name || "";
      els[1].value = preset.color || "";
      els[2].value = preset.size || "";
      els[3].value = (preset.qty != null ? String(preset.qty) : "");
      els[4].value = preset.price != null ? preset.price : "";
    }

    for (let k=0;k<5;k++){
      els[k].addEventListener("input", ()=>{
        if (MODE !== "form" && div.dataset.editing !== "1") return;
        // âœ… (ì¶”ê°€) ê°€ê²©ì¹¸ì´ textê°€ ëìœ¼ë‹ˆ, ìˆ«ì ì™¸ ë¬¸ìëŠ” ì¦‰ì‹œ ì œê±°(ì•ˆì „)
        if (k === 4){
          const v = els[4].value || "";
          const only = v.replace(/[^\d]/g, "");
          if (v !== only) els[4].value = only;
        }
        calc();
        renderDraftSummary();
        saveData();
      });
      els[k].addEventListener("change", ()=>{
        if (MODE !== "form" && div.dataset.editing !== "1") return;
        if (k === 4){
          const v = els[4].value || "";
          const only = v.replace(/[^\d]/g, "");
          if (v !== only) els[4].value = only;
        }
        calc();
        renderDraftSummary();
        saveData();
      });
    }

    const editOpenRow = div.querySelector('[data-edit-open="1"]');
    const editBtn = editOpenRow.querySelector("button");
    const editControlsRow = div.querySelector('[data-edit-controls="1"]');
    const editDoneBtn = editControlsRow.querySelectorAll("button")[0];
    const editCancelBtn = editControlsRow.querySelectorAll("button")[1];

    editControlsRow.style.display = "none";
    editOpenRow.style.display = "none";

    // âœ…âœ…âœ… (ìš”ì²­ 2) "ì£¼ë¬¸ìƒì„¸ ë³´ê¸° > ë³€ê²½í•˜ê¸°" ìƒíƒœì—ì„œ ê°€ê²© ì…ë ¥ ì™„ë£Œ(Enter/Done) â†’ ë³€ê²½ì™„ë£Œ ë²„íŠ¼ìœ¼ë¡œ ì´ë™
    // âœ… (ê¸°ì¡´) form ëª¨ë“œì—ì„œëŠ” handlePriceDone_ ìœ ì§€
    els[4].addEventListener("keydown", (e)=>{
      if (e.key !== "Enter") return;
      e.preventDefault();

      if (MODE === "form"){
        handlePriceDone_(div);
        return;
      }

      if (MODE === "complete" && div.dataset.editing === "1"){
        closeKeyboard_();
        if (editDoneBtn){
          editDoneBtn.scrollIntoView({ behavior:"smooth", block:"center" });
          setTimeout(()=>pulseBtnEl_(editDoneBtn), 120);
        }
      }
    });

    function enterEdit_(){
      if (MODE !== "complete") return;
      const st = div.dataset.status || "";
      if (!(st === "sent" || st === "modified")) return;
      if (div.dataset.editing === "1") return;

      div.dataset.snapshot = _productSnapshot_(div);
      div.dataset.editing = "1";

      lockProductInputs(div, false);
      setBadge(div);
      refreshProductActionRows_(div);
      saveData();
    }

    function exitEdit_(restore){
      if (restore){
        _applySnapshot_(div, div.dataset.snapshot || "");
      }
      div.dataset.editing = "";
      div.dataset.snapshot = "";

      if (MODE === "complete") lockProductInputs(div, true);

      setBadge(div);
      calc();
      renderDoneSummary();
      renderDraftSummary();
      refreshProductActionRows_(div);
      saveData();
    }

    editBtn.onclick = enterEdit_;
    editCancelBtn.onclick = ()=> exitEdit_(true);

    editDoneBtn.onclick = async ()=>{
      if (MODE !== "complete") return;
      if (!_validateProductInputs_(div)) return;

      if (!confirm("ë³€ê²½ ë‚´ìš©ì„ ì €ì¥í• ê¹Œìš”?")) return;

      const els2 = div.querySelectorAll("input, select");

      const item = {
        itemId: div.dataset.id,
        productName: (els2[0].value || "").trim(),
        color: (els2[1].value || "").trim(),
        size: (els2[2].value || "").trim(),
        qty: Number((els2[3].value || "").trim() || 0),
        price: Number((els2[4].value || "").trim() || 0)
      };

      const before = JSON.parse(div.dataset.snapshot || "{}");
      const beforeAmt = Number(before.qty || 0) * Number(before.price || 0);
      const afterAmt  = Number(item.qty || 0) * Number(item.price || 0);

      item.amountDelta = afterAmt - beforeAmt;
      item.productName = "[ë³€ê²½] " + item.productName;

      const useOrderId = div.dataset.orderId || LAST_DONE_ORDER_ID || newOrderId_();

      const payload = {
        eventId: newEventId_(),
        orderId: useOrderId,
        orderTime: kstNowString(),
        broadcastDate: getBroadcastSheetNameKST_(),
        eventType: "modify",
        customer: {
          nickname: document.getElementById("nickname").value || "",
          name: document.getElementById("name").value || "",
          phone: document.getElementById("phone").value || "",
          address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
        },
        items: [item],
        sum: 0,
        shipping: 0,
        total: 0
      };

      try{
        // âœ…âœ…âœ… (ë³€ê²½) ë¯¸ì „ì†¡ í + ìë™ ì¬ì „ì†¡
        queueSend_(payload);

        div.dataset.status = "modified";
        div.dataset.doneDate = getBroadcastSheetNameKST_();

        exitEdit_(false);

        setBanner("ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        focusBanner();
        alert("ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch(e){
        alert("ì¼ì‹œì ìœ¼ë¡œ ì €ì¥/ì „ì†¡ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    };

    const cancelBtn = div.querySelector('[data-cancel-row="1"] button');
    if (cancelBtn){
      cancelBtn.onclick = async ()=>{
        if (MODE !== "complete" || !ORDER_DETAIL_OPEN) return;

        const st = div.dataset.status || "";
        if (!(st === "sent" || st === "modified")){
          alert("í˜„ì¬ ìƒíƒœì—ì„œëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if (div.dataset.editing === "1"){
          alert("ë³€ê²½ ì¤‘ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if (!confirm("ì´ ìƒí’ˆì„ ì·¨ì†Œí• ê¹Œìš”?\n(ì·¨ì†Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)")) return;

        const els2 = div.querySelectorAll("input, select");
        const item = {
          itemId: div.dataset.id,
          productName: (els2[0].value || "").trim(),
          color: (els2[1].value || "").trim(),
          size: (els2[2].value || "").trim(),
          qty: Number((els2[3].value || "").trim() || 0),
          price: Number((els2[4].value || "").trim() || 0)
        };

        const amt = Number(item.qty || 0) * Number(item.price || 0);
        item.amountDelta = -amt;
        item.productName = "[ì·¨ì†Œ] " + item.productName;

        const useOrderId = div.dataset.orderId || LAST_DONE_ORDER_ID || newOrderId_();

        const payload = {
          eventId: newEventId_(),
          orderId: useOrderId,
          orderTime: kstNowString(),
          broadcastDate: getBroadcastSheetNameKST_(),
          eventType: "cancel",
          customer: {
            nickname: document.getElementById("nickname").value || "",
            name: document.getElementById("name").value || "",
            phone: document.getElementById("phone").value || "",
            address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
          },
          items: [item],
          sum: 0,
          shipping: 0,
          total: 0
        };

        try{
          // âœ…âœ…âœ… (ë³€ê²½) ë¯¸ì „ì†¡ í + ìë™ ì¬ì „ì†¡
          queueSend_(payload);

          div.dataset.status = "canceled";
          div.dataset.doneDate = getBroadcastSheetNameKST_();

          lockProductInputs(div, true);
          setBadge(div);
          refreshProductActionRows_(div);

          setBanner("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          focusBanner();
          calc();
          renderDoneSummary();
          renderDraftSummary();
          applyProductVisibility_();
          saveData();
          alert("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e){
          alert("ì¼ì‹œì ìœ¼ë¡œ ì €ì¥/ì „ì†¡ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      };
    }

    productsDiv.appendChild(div);

    if (MODE === "complete"){
      lockProductInputs(div, true);
    } else {
      lockProductInputs(div, false);
    }

    setBadge(div);
    refreshProductActionRows_(div);

    calc();
    renderDoneSummary();
    renderDraftSummary();
    applyProductVisibility_();

    if (!IS_LOADING) saveData();
    return div;
  }

  function removeLastProduct(){
    if (MODE !== "form") return;

    const items = Array.from(document.querySelectorAll(".product"));
    for (let idx = items.length - 1; idx >= 0; idx--){
      const st = items[idx].dataset.status || "draft";
      if (st === "draft"){
        items[idx].remove();
        break;
      }
    }
    if (!document.querySelector('.product[data-status="draft"]')) addProduct();

    calc();
    renderDraftSummary();
    saveData();
    renderDoneSummary();
    applyProductVisibility_();
  }

  function checkOrder(){
    let text = "[ê³ ê° ì •ë³´]\n";
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[ì‘ì„± ì¤‘ ìƒí’ˆ]\n";

    const targets = Array.from(document.querySelectorAll(".product"))
      .filter(p => (p.dataset.status === "draft"))
      .filter(p => !isBlankProductCard_(p));

    if (targets.length === 0){
      text += "(ì‘ì„± ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      targets.forEach((p, idx)=>{
        const els = p.querySelectorAll("input, select");
        const priceVal = (els[4].value || "").trim();
        text += `${idx+1}. ${els[0].value} / ${els[1].value} / ${els[2].value} / ${els[3].value}ê°œ / ${priceVal ? _fmtMoney_(priceVal) : "-"}\n`;
      });
    }

    text += `\nìƒí’ˆí•©ê³„: ${document.getElementById("sum").innerText}\n`;
    text += `ë°°ì†¡ë¹„: ${document.getElementById("shipping").innerText}\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${document.getElementById("total").innerText}\n`;

    text += `\në‚´ìš©ì´ ë§ìœ¼ë©´ ì•„ë˜ì—ì„œ â€˜ì£¼ë¬¸í•˜ê¸°â€™ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.\n`;
    alert(text);
  }

  function showOrderHistory(){
    const targetDates = getTargetDateListByOffset_(DONE_FILTER_OFFSET);
    const set = new Set(targetDates.map(String));
    const titleText = (Number(DONE_FILTER_OFFSET) === 7)
      ? `ìµœê·¼ 1ì£¼ (${formatDateRangeTextFromList_(targetDates)})`
      : formatBroadcastDateText_(targetDates[0]);

    let text = `[ë°°ì†¡ì§€ ì •ë³´]\n`;
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += `[ì™„ë£Œ ìƒí’ˆ - ${titleText}]\n`;

    const items = Array.from(document.querySelectorAll(".product")).filter(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified" || st === "canceled" || st === "shipped")) return false;

      const key = _itemDateKey_(p);
      return set.has(key);
    });

    if (items.length === 0){
      text += "(ì„ íƒí•œ ë‚ ì§œì˜ ì™„ë£Œëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      items.forEach((p, idx)=>{
        const st = p.dataset.status;
        const els = p.querySelectorAll("input, select");
        const qty = Number(els[3].value || 0);
        const price = Number(els[4].value || 0);

        const prefix =
          (st === "canceled") ? "[ì·¨ì†Œì™„ë£Œ] " :
          (st === "shipped") ? "[ë°œì†¡ì™„ë£Œ] " :
          (st === "modified") ? "[ë³€ê²½ì™„ë£Œ] " :
          "[ì£¼ë¬¸ì™„ë£Œ] ";

        const dateKey = _itemDateKey_(p);
        const dateLabel = (Number(DONE_FILTER_OFFSET) === 7 && dateKey) ? `(${formatBroadcastDateText_(dateKey)}) ` : "";

        text += `${idx+1}. ${dateLabel}${prefix}${els[0].value} / ${els[1].value} / ${els[2].value} / ${qty}ê°œ / ${price.toLocaleString()}ì›\n`;
      });
    }

    text += `\nìƒí’ˆí•©ê³„: ${document.getElementById("sum").innerText}\n`;
    text += `ë°°ì†¡ë¹„: ${document.getElementById("shipping").innerText}\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${document.getElementById("total").innerText}\n`;

    alert(text);
  }

  function copyOrderHistory(){
    const targetDates = getTargetDateListByOffset_(DONE_FILTER_OFFSET);
    const set = new Set(targetDates.map(String));
    const titleText = (Number(DONE_FILTER_OFFSET) === 7)
      ? `ìµœê·¼ 1ì£¼ (${formatDateRangeTextFromList_(targetDates)})`
      : formatBroadcastDateText_(targetDates[0]);

    let text = `[ë°°ì†¡ì§€ ì •ë³´]\n`;
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += `[ì™„ë£Œ ìƒí’ˆ - ${titleText}]\n`;

    const items = Array.from(document.querySelectorAll(".product")).filter(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "modified" || st === "canceled" || st === "shipped")) return false;
      const key = _itemDateKey_(p);
      return set.has(key);
    });

    if (items.length === 0){
      text += "(ì„ íƒí•œ ë‚ ì§œì˜ ì™„ë£Œëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      items.forEach((p, idx)=>{
        const st = p.dataset.status;
        const els = p.querySelectorAll("input, select");
        const qty = Number(els[3].value || 0);
        const price = Number(els[4].value || 0);

        const prefix =
          (st === "canceled") ? "[ì·¨ì†Œì™„ë£Œ] " :
          (st === "shipped") ? "[ë°œì†¡ì™„ë£Œ] " :
          (st === "modified") ? "[ë³€ê²½ì™„ë£Œ] " :
          "[ì£¼ë¬¸ì™„ë£Œ] ";

        const dateKey = _itemDateKey_(p);
        const dateLabel = (Number(DONE_FILTER_OFFSET) === 7 && dateKey) ? `(${formatBroadcastDateText_(dateKey)}) ` : "";

        text += `${idx+1}. ${dateLabel}${prefix}${els[0].value} / ${els[1].value} / ${els[2].value} / ${qty}ê°œ / ${price.toLocaleString()}ì›\n`;
      });
    }

    text += `\nìƒí’ˆí•©ê³„: ${document.getElementById("sum").innerText}\n`;
    text += `ë°°ì†¡ë¹„: ${document.getElementById("shipping").innerText}\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${document.getElementById("total").innerText}\n`;

    try{
      navigator.clipboard.writeText(text);
      alert("ì£¼ë¬¸ ë‚´ì—­ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }catch(e){
      prompt("ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•Šì•„, ì•„ë˜ ë‚´ìš©ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.", text);
    }
  }

  function _validateCustomer_(){
    const nickname = document.getElementById("nickname");
    const name = document.getElementById("name");
    const phone = document.getElementById("phone");
    const address = document.getElementById("address");
    const addressDetail = document.getElementById("addressDetail");

    if (!nickname.value.trim()) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); nickname.focus(); return false; }
    if (!name.value.trim()) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); name.focus(); return false; }
    if (!phone.value.trim()) { alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); phone.focus(); return false; }
    if (!address.value.trim()) { alert("ì£¼ì†Œê²€ìƒ‰ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return false; }
    if (!addressDetail.value.trim()) { alert("ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); addressDetail.focus(); return false; }
    return true;
  }

  async function submitOrder(){
    if (MODE !== "form") return;
    if (!_validateCustomer_()) return;

    const draftsAll = Array.from(document.querySelectorAll(".product")).filter(p => (p.dataset.status === "draft"));
    const targets = draftsAll.filter(p => !isBlankProductCard_(p));

    if (targets.length === 0){
      alert("ì‘ì„± ì¤‘ì¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    if (!confirm(
`ì£¼ë¬¸ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?

â€» 10ë§Œì› ì´ìƒì´ë©´ ë°°ì†¡ë¹„ 4,000ì›ì€ ë¹¼ê³  ì…ê¸ˆí•´ì£¼ì„¸ìš”.`
)) return;

    const items = [];
    let sum = 0;

    for (const p of targets){
      if (!_validateProductInputs_(p)) return;

      const els = p.querySelectorAll("input, select");
      const name = (els[0].value || "").trim();
      const color = (els[1].value || "").trim();
      const size = (els[2].value || "").trim();
      const qty = Number((els[3].value || "").trim() || 0);
      const price = Number((els[4].value || "").trim() || 0);

      items.push({ itemId: p.dataset.id, productName:name, color, size, qty, price });
      sum += (qty * price);
    }

    // âœ… ê¸°ë³¸ ë°°ì†¡ë¹„ ê·œì¹™ (10ë§Œ ì´ìƒ ë¬´ë£Œ)
    let shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;

    const batchOrderId = ensureDraftOrderId_();

    const orderTimeStr = kstNowString();
    const broadcastDate = getBroadcastSheetNameKST_(); // âœ… ë°©ì†¡ì¼ì(08:00 ê¸°ì¤€)

    // âœ…âœ…âœ… [ë³€ê²½] (í‰ì¼) ë‚ ì§œë³„ / (ì£¼ë§) ê¸ˆ~ì¼ ë¬¶ìŒ ê¸°ì¤€ìœ¼ë¡œ 1íšŒë§Œ ë°°ì†¡ë¹„ ë¶€ê³¼
    if (isShippingChargedForOrderDate_(batchOrderId, broadcastDate)){
      shipping = 0;
    }

    const payload = {
      eventId: newEventId_(),
      orderId: batchOrderId,
      orderTime: orderTimeStr,
      broadcastDate,
      eventType: "order",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum,
      shipping,
      total: sum + shipping
    };

    try{
      // âœ…âœ…âœ… (ë³€ê²½) ë¯¸ì „ì†¡ í + ìë™ ì¬ì „ì†¡
      queueSend_(payload);

      targets.forEach(p=>{
        p.dataset.status = "sent";
        p.dataset.editing = "";
        p.dataset.snapshot = "";
        p.dataset.orderId = batchOrderId;
        p.dataset.orderTime = orderTimeStr;
        p.dataset.doneDate = broadcastDate;
        setBadge(p);
      });

      LAST_DONE_ORDER_ID = batchOrderId;
      ACTIVE_DRAFT_ORDER_ID = batchOrderId;

      // âœ…âœ…âœ… [ë³€ê²½] ë°°ì†¡ë¹„ê°€ ì‹¤ì œë¡œ ë¶™ì€ ì£¼ë¬¸ ì „ì†¡ ì„±ê³µ ì‹œ, í•´ë‹¹ í‚¤(í‰ì¼/ì£¼ë§ë¬¶ìŒ)ë¥¼ ë§ˆí‚¹
      // (í ë°©ì‹ì—ì„œëŠ” "ì „ì†¡ í™•ì •"ì€ ì•„ë‹ˆì§€ë§Œ, eventId ì¤‘ë³µë°©ì§€+ì¬ì „ì†¡ì´ë¯€ë¡œ UI ê¸°ì¤€ ìœ ì§€)
      if (sum > 0 && sum < 100000){
        markShippingCharged_(batchOrderId, broadcastDate);
      }

      setMode("complete", "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.", { detailClosedOnEnter:true });

      calc();
      renderDoneSummary();
      renderDraftSummary();
      saveData();

      alert("ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ë°©ì†¡ ì¢…ë£Œ ì „ê¹Œì§€ ê¼­ ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.");
    } catch(e){
      alert("ì¼ì‹œì ìœ¼ë¡œ ì €ì¥/ì „ì†¡ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  function goToFormForAdd(){
    if (SHIP_EDITING){ alert("ë°°ì†¡ì§€ ìˆ˜ì • ì¤‘ì—ëŠ” ì¶”ê°€ì£¼ë¬¸ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    if (LAST_DONE_ORDER_ID) ACTIVE_DRAFT_ORDER_ID = LAST_DONE_ORDER_ID;

    setMode("form");

    let firstDraft = document.querySelector('.product[data-status="draft"]');
    if (!firstDraft){
      firstDraft = addProduct();
    }
    setTimeout(()=>{
      const nameInput = firstDraft.querySelector(".product-name");
      if (nameInput){
        nameInput.focus();
        try{
          const len = nameInput.value.length;
          nameInput.setSelectionRange(len, len);
        } catch(e){}
        ensureVisibleWithBottomBar_(nameInput);
      }
      firstDraft.scrollIntoView({ behavior:"smooth", block:"center" });
    }, 50);

    calc();
    renderDoneSummary();
    renderDraftSummary();
    saveData();
  }

  function enterShipEdit(){
    if (MODE !== "complete") return;

    SHIP_EDITING = true;
    SHIP_SNAPSHOT = snapshotCustomer();

    document.getElementById("shipSummary").style.display = "none";
    document.getElementById("customerFormFields").style.display = "block";
    document.getElementById("shipEditControls").style.display = "flex";
    document.getElementById("shipActions").style.display = "none";

    setTimeout(()=>{
      const nick = document.getElementById("nickname");
      if (nick){ nick.focus(); }
      setTimeout(()=>ensureVisibleWithBottomBar_(nick), 50);
    }, 30);

    saveData();
  }

  function exitShipEdit(silent){
    SHIP_EDITING = false;
    SHIP_SNAPSHOT = null;

    const shipSummary = document.getElementById("shipSummary");
    const customerFormFields = document.getElementById("customerFormFields");
    const shipEditControls = document.getElementById("shipEditControls");
    const shipActions = document.getElementById("shipActions");

    if (MODE === "complete"){
      shipSummary.style.display = "block";
      customerFormFields.style.display = "none";
      shipEditControls.style.display = "none";
      shipActions.style.display = "flex";
    } else {
      shipSummary.style.display = "none";
      customerFormFields.style.display = "block";
      shipEditControls.style.display = "none";
      shipActions.style.display = "none";
    }

    if (!silent) saveData();
  }

  function cancelShipEdit(){
    if (!SHIP_EDITING) return;

    const s = SHIP_SNAPSHOT || {};
    document.getElementById("nickname").value = s.nickname || "";
    document.getElementById("name").value = s.name || "";
    document.getElementById("phone").value = s.phone || "";
    document.getElementById("address").value = s.address || "";
    document.getElementById("addressDetail").value = s.addressDetail || "";

    renderShippingSummary();
    exitShipEdit(false);

    setBanner("ë°°ì†¡ì§€ ë³€ê²½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    focusBanner();
  }

  async function saveShipEdit(){
    if (!SHIP_EDITING) return;

    if (!_validateCustomer_()) return;
    if (!confirm("ë°°ì†¡ì§€ë¥¼ ì €ì¥í• ê¹Œìš”?")) return;

    const payload = {
      eventId: newEventId_(),
      orderId: LAST_DONE_ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      broadcastDate: getBroadcastSheetNameKST_(),
      eventType: "ship_update",
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items: [],
      sum: 0,
      shipping: 0,
      total: 0
    };

    try{
      // âœ…âœ…âœ… (ë³€ê²½) ë¯¸ì „ì†¡ í + ìë™ ì¬ì „ì†¡
      queueSend_(payload);

      renderShippingSummary();
      exitShipEdit(false);

      setBanner("ë°°ì†¡ì§€ ë³€ê²½ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      focusBanner();
      alert("ë°°ì†¡ì§€ ì €ì¥ ì™„ë£Œ");
    } catch(e){
      alert("ì¼ì‹œì ìœ¼ë¡œ ì €ì¥/ì „ì†¡ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  function saveCustomerOnly_(){
    const c = snapshotCustomer();
    localStorage.setItem(LS_CUSTOMER_KEY, JSON.stringify(c));
  }
  function loadCustomerOnly_(){
    const c = JSON.parse(localStorage.getItem(LS_CUSTOMER_KEY) || "null");
    if (!c) return null;
    return c;
  }

  function saveData(){
    saveCustomerOnly_();

    const data = {
      savedAt: Date.now(),
      mode: MODE,
      detailOpen: ORDER_DETAIL_OPEN,
      shipEditing: SHIP_EDITING,
      lastDoneOrderId: LAST_DONE_ORDER_ID,
      activeDraftOrderId: ACTIVE_DRAFT_ORDER_ID,
      doneFilterOffset: DONE_FILTER_OFFSET,

      // âœ…âœ…âœ… [ì¶”ê°€] ë°°ì†¡ë¹„ ì²˜ë¦¬ ìƒíƒœ ì €ì¥
      shippingCharged: SHIPPING_CHARGED,

      products: []
    };

    document.querySelectorAll(".product").forEach(p=>{
      const els = p.querySelectorAll("input, select");
      data.products.push({
        id: p.dataset.id || _uid(),
        status: p.dataset.status || "draft",
        snapshot: p.dataset.snapshot || "",
        editing: p.dataset.editing || "",
        orderId: p.dataset.orderId || "",
        orderTime: p.dataset.orderTime || "",
        doneDate: p.dataset.doneDate || "",
        shipDate: p.dataset.shipDate || "",
        name: els[0]?.value || "",
        color: els[1]?.value || "",
        size: els[2]?.value || "",
        qty: els[3]?.value || "",
        price: els[4]?.value || ""
      });
    });

    localStorage.setItem(LS_ORDER_KEY, JSON.stringify(data));
  }

  function loadData(){
    const savedCustomer = loadCustomerOnly_();
    if (savedCustomer){
      document.getElementById("nickname").value = savedCustomer.nickname || "";
      document.getElementById("name").value = savedCustomer.name || "";
      document.getElementById("phone").value = savedCustomer.phone || "";
      document.getElementById("address").value = savedCustomer.address || "";
      document.getElementById("addressDetail").value = savedCustomer.addressDetail || "";
    }

    const data = JSON.parse(localStorage.getItem(LS_ORDER_KEY) || "null");
    const expired = (!data || !data.savedAt || (Date.now() - Number(data.savedAt)) > ORDER_TTL_MS);

    if (expired){
      IS_LOADING = true;
      productsDiv.innerHTML = "";
      ACTIVE_DRAFT_ORDER_ID = newOrderId_();
      LAST_DONE_ORDER_ID = "";
      ORDER_DETAIL_OPEN = false;

      DONE_FILTER_OFFSET = 0;
      setActiveDayButton_(0);

      // âœ…âœ…âœ… [ì¶”ê°€] ë§Œë£Œ ì‹œ ë°°ì†¡ë¹„ ì²˜ë¦¬ ìƒíƒœë„ ì´ˆê¸°í™”
      SHIPPING_CHARGED = {};

      addProduct();

      IS_LOADING = false;

      renderShippingSummary();
      renderDoneSummary();
      renderDraftSummary();
      calc();

      setMode("form");
      setBanner("ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
      saveData();

      setTimeout(updateBottomSpacing, 0);
      return;
    }

    IS_LOADING = true;

    MODE = data.mode || "form";
    ORDER_DETAIL_OPEN = !!data.detailOpen;
    SHIP_EDITING = !!data.shipEditing;

    LAST_DONE_ORDER_ID = data.lastDoneOrderId || "";
    ACTIVE_DRAFT_ORDER_ID = data.activeDraftOrderId || "";

    DONE_FILTER_OFFSET = (data.doneFilterOffset != null) ? Number(data.doneFilterOffset) : 0;
    if (isNaN(DONE_FILTER_OFFSET)) DONE_FILTER_OFFSET = 0;
    setActiveDayButton_(DONE_FILTER_OFFSET);

    // âœ…âœ…âœ… [ì¶”ê°€] ë°°ì†¡ë¹„ ì²˜ë¦¬ ìƒíƒœ ë³µì›
    SHIPPING_CHARGED = (data.shippingCharged && typeof data.shippingCharged === "object") ? data.shippingCharged : {};

    productsDiv.innerHTML = "";
    (data.products || []).forEach(p=>{
      addProduct({
        id: p.id,
        status: p.status,
        snapshot: p.snapshot,
        editing: p.editing,
        orderId: p.orderId,
        orderTime: p.orderTime,
        doneDate: p.doneDate,
        shipDate: p.shipDate,
        name: p.name,
        color: p.color,
        size: p.size,
        qty: p.qty,
        price: p.price
      });
    });

    if (!document.querySelector('.product[data-status="draft"]')) addProduct();

    IS_LOADING = false;

    renderShippingSummary();
    renderDoneSummary();
    renderDraftSummary();
    calc();

    updateShippingStatuses_(true);

    if (MODE === "complete"){
      if (hasAnyDoneItems_()){
        setMode("complete", "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.", { allowEmpty:true });
      } else {
        setMode("form");
      }
    } else {
      setMode("form");
    }

    setBanner("ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
    saveData();

    setTimeout(updateBottomSpacing, 0);
  }

  ["nickname","name","addressDetail"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      renderShippingSummary();
      saveData();
    });
  });

  document.getElementById("phone").addEventListener("input", (e)=>{
    const el = e.target;
    const formatted = formatPhoneKR_(el.value);
    if (el.value !== formatted) el.value = formatted;
    renderShippingSummary();
    saveData();
  });

  /* ==================================================
     âœ…âœ…âœ… (ìš”ì²­ 1) ë°°ì†¡ì§€ ë³€ê²½ í™”ë©´ì—ì„œ "ìƒì„¸ì£¼ì†Œ" ì™„ë£Œ(Enter/Done) â†’ í‚¤ë³´ë“œ ë‹«ê¸° + ë°°ì†¡ì§€ ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ì´ë™
     ================================================== */
  document.getElementById("addressDetail").addEventListener("keydown", (e)=>{
    if (e.key !== "Enter") return;
    if (!SHIP_EDITING) return; // ë°°ì†¡ì§€ ë³€ê²½(í¸ì§‘) ì¤‘ì¼ ë•Œë§Œ
    e.preventDefault();

    closeKeyboard_();

    const btn = document.querySelector("#shipEditControls .btn-blue"); // ë°°ì†¡ì§€ ì €ì¥
    if (btn){
      btn.scrollIntoView({ behavior:"smooth", block:"center" });
      setTimeout(()=>pulseBtnEl_(btn), 120);
    }
  });

  (function initDayFilter_(){
    const wrap = document.getElementById("dayFilter");
    if (!wrap) return;

    wrap.addEventListener("click", (e)=>{
      const btn = e.target && e.target.closest("button");
      if (!btn) return;

      const offset = Number(btn.getAttribute("data-day"));
      if (isNaN(offset)) return;

      const targetDates = getTargetDateListByOffset_(offset);

      if (MODE === "complete"){
        if (!_hasAnyForDates_(targetDates)){
          if (Number(offset) === 7){
            alert(`ìµœê·¼ 1ì£¼ ë‚ ì§œì— ì£¼ë¬¸ì™„ë£Œ/ë³€ê²½ì™„ë£Œ/ì·¨ì†Œì™„ë£Œ/ë°œì†¡ì™„ë£Œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.`);
          } else {
            const title = formatBroadcastDateText_(targetDates[0]);
            alert(`${title} ë‚ ì§œì— ì£¼ë¬¸ì™„ë£Œ/ë³€ê²½ì™„ë£Œ/ì·¨ì†Œì™„ë£Œ/ë°œì†¡ì™„ë£Œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.`);
          }
          return;
        }
      }

      DONE_FILTER_OFFSET = offset;
      setActiveDayButton_(offset);

      renderDoneSummary();
      applyProductVisibility_();
      calc();

      saveData();
    });
  })();

  loadData();

  // âœ…âœ…âœ… (ì¶”ê°€) í˜ì´ì§€ ë¡œë“œ í›„ í•œ ë²ˆ ê°•ì œ flush
  setTimeout(()=>flushOutbox_({ force:true }), 800);

  // âœ…âœ…âœ… (ì¶”ê°€) ë„¤íŠ¸ì›Œí¬ê°€ ëŒì•„ì˜¤ë©´ ì¦‰ì‹œ flush
  window.addEventListener("online", ()=> flushOutbox_({ force:true }));

  // âœ…âœ…âœ… (ì¶”ê°€) ì£¼ê¸°ì  flush (íê°€ ìˆì„ ë•Œë§Œ ì‹¤ì§ˆì ìœ¼ë¡œ ë™ì‘)
  setInterval(()=>flushOutbox_(), 15000);

  setInterval(()=>updateShippingStatuses_(true), 5 * 60 * 1000);
</script>

</body>
</html>