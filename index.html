<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì‹¸U ì…€í”„ ì •ì‚° ì£¼ë¬¸ì„œ</title>

<style>
  body{
    margin:0; padding:16px;
    font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    background:#fff; color:#111;
  }
  h1{ text-align:center; font-size:20px; margin:0 0 12px; color:#005FAE; }

  /* âœ… ì™„ë£Œ ë°°ë„ˆ */
  .mode-banner{
    display:none;
    text-align:center;
    padding:10px 12px;
    border-radius:10px;
    font-weight:800;
    margin:0 auto 14px;
    max-width:560px;
    outline:none;
  }
  body.mode-complete .mode-banner{
    display:block;
    background:#e8f2ff;
    border:1px solid #c8ddff;
    color:#005FAE;
  }

  .section{ margin-bottom:28px; }
  .section-title{ font-size:15px; font-weight:700; margin-bottom:10px; color:#005FAE; }
  .divider{ border-top:1px solid #eee; margin:12px 0 16px; }

  .field{ margin-bottom:12px; }
  label{ display:block; font-size:13px; margin-bottom:4px; }

  input{
    width:100%;
    padding:12px;
    font-size:15px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
  }
  input::placeholder{ color:#999; }

  .address-row{ display:flex; gap:8px; }
  .address-row input{ flex:1; }
  .addr-btn{
    background:#005FAE; color:#fff; font-weight:700;
    border:none; border-radius:6px;
    padding:12px 14px; cursor:pointer; white-space:nowrap;
  }

  /* âœ… ë°°ì†¡ì§€ ìš”ì•½(ì™„ë£Œ í™”ë©´/ì·¨ì†Œ í™”ë©´ = ì™„ë£Œ í™”ë©´) */
  #shipSummary{
    display:none;
    background:#f7f7f7;
    border:1px solid #e5e5e5;
    border-radius:10px;
    padding:12px;
    font-size:14px;
    line-height:1.55;
  }
  body.mode-complete #shipSummary{ display:block; }
  body.mode-complete #customerFormFields{ display:none; } /* ì™„ë£Œ í™”ë©´ì—ì„œëŠ” ì…ë ¥í¼ ìˆ¨ê¹€ */

  .product{
    border-top:1px solid #eee;
    padding-top:12px;
    margin-top:12px;
  }

  .row{ display:flex; gap:8px; }
  .row .field{ flex:1; }

  button{
    padding:12px 14px;
    font-size:14px;
    font-weight:800;
    border-radius:8px;
    border:none;
    cursor:pointer;
  }

  .button-line-3{
    display:flex;
    justify-content:center;
    gap:8px;
    margin-top:12px;
  }
  .button-line-3 button{
    flex:0 0 calc((100% - 16px)/3);
    max-width:calc((100% - 16px)/3);
    white-space:nowrap;
  }

  .button-line-full{
    display:flex;
    justify-content:center;
    margin-top:12px;
  }
  .button-line-full button{
    flex:1 1 100%;
    max-width:100%;
  }

  /* âœ… ì‘ì„± í™”ë©´ ë²„íŠ¼ */
  .btn-new{ background:#e74c3c; color:#fff; }
  .btn-check{ background:#E0E0E0; color:#333; }
  .btn-order{ background:#005FAE; color:#fff; }

  /* âœ… ì™„ë£Œ í™”ë©´ ë²„íŠ¼(ìƒˆì£¼ë¬¸/ìˆ˜ì •í•˜ê¸°/ì·¨ì†Œì™„ë£Œ) */
  .btn-edit-go{ background:#e8f2ff; color:#005FAE; border:1px solid #c8ddff; }
  .btn-cancel-complete{ background:#e74c3c; color:#fff; }
  .btn-final-view{ background:#e0e0e0; color:#111; }

  /* âœ… ìƒí’ˆì¶”ê°€/ì‚­ì œ ì˜ì—­ */
  .button-line-2{
    display:flex;
    gap:8px;
    margin-top:12px;
  }
  .button-line-2 button{ flex:1 1 50%; max-width:50%; white-space:nowrap; }
  .btn-add{ background:#005FAE; color:#fff; }
  .btn-delete{ background:#e74c3c; color:#fff; }

  /* âœ… ì ‘ê¸°/í¼ì¹˜ê¸°(ì™„ë£Œ í™”ë©´ì—ì„œë§Œ) */
  .small-link-btn{
    display:none;
    width:100%;
    margin-top:10px;
    padding:10px 12px;
    background:#f4f7ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    color:#333;
    font-size:14px;
    font-weight:800;
    text-align:center;
    cursor:pointer;
  }
  body.mode-complete .small-link-btn{ display:block; }

  /* âœ… ì™„ë£Œ í™”ë©´ì—ì„œëŠ” ìƒí’ˆì¶”ê°€/ì‚­ì œ ìˆ¨ê¹€ */
  body.mode-complete .button-line-2{ display:none !important; }

  /* âœ… ê¸ˆì•¡ ìš”ì•½ */
  .summary{ border-top:1px solid #eee; padding-top:14px; }
  .summary-line{ display:flex; justify-content:space-between; font-size:14px; margin:6px 0; }
  .summary-total{ font-weight:800; font-size:16px; color:#005FAE; }

  /* âœ… ì…ê¸ˆê³„ì¢Œ */
  .account-box{
    display:flex;
    align-items:center;
    background:#f4f7ff;
    border:1px solid #d6e0ff;
    border-radius:8px;
    padding:10px;
    gap:8px;
  }
  .account-text{ font-size:14px; white-space:nowrap; flex:1; }
  .copy-btn{
    background:#005FAE;
    color:#fff;
    font-size:12px;
    font-weight:800;
    padding:6px 10px;
    border-radius:6px;
    border:none;
  }

  /* âœ… ìƒíƒœ ë°°ì§€ */
  .product-title-row{ display:flex; align-items:center; gap:8px; }
  .product-title-row input{ flex:1; }

  .status-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    font-weight:800;
    padding:6px 10px;
    border-radius:6px;
    white-space:nowrap;
    user-select:none;
  }
  .status-badge .sq{ width:10px; height:10px; border-radius:2px; display:inline-block; }

  .status-sent{ background:#e8f2ff; color:#005FAE; border:1px solid #c8ddff; }
  .status-sent .sq{ background:#005FAE; }

  .status-canceled{ background:#ededed; color:#222; border:1px solid #cfcfcf; }
  .status-canceled .sq{ background:#111; }

  /* âœ… ì™„ë£Œ í™”ë©´ì—ì„œ ì·¨ì†Œ ì„ íƒ í‘œì‹œ */
  .status-cancel-pick{ background:#ffe9e9; color:#c0392b; border:1px solid #ffc9c9; }
  .status-cancel-pick .sq{ background:#e74c3c; }

  /* âœ… ì™„ë£Œ/ì·¨ì†Œëœ ìƒí’ˆì€ í¼ í™”ë©´ì—ì„œëŠ” ìš”ì•½ìœ¼ë¡œë§Œ */
  #doneSummary{
    display:none;
    font-size:13px;
    color:#333;
    background:#f7f9ff;
    border:1px solid #d6e0ff;
    border-radius:10px;
    padding:10px;
    margin:6px 0 10px;
    line-height:1.5;
  }
  body.mode-form #doneSummary{ display:block; }
  body.mode-complete #doneSummary{ display:none; }

  /* âœ… í¼ í™”ë©´ì—ì„œëŠ” ì™„ë£Œ/ì·¨ì†Œ ìƒí’ˆ ì¹´ë“œ ìˆ¨ê¹€ */
  body.mode-form .product[data-status="sent"],
  body.mode-form .product[data-status="canceled"]{
    display:none !important;
  }

  /* âœ… ì™„ë£Œ í™”ë©´ì—ì„œëŠ” ì™„ë£Œ/ì·¨ì†Œ ìƒí’ˆ ì¹´ë“œ í‘œì‹œ */
  body.mode-complete .product[data-status="sent"],
  body.mode-complete .product[data-status="canceled"],
  body.mode-complete .product[data-status="cancel_pending"]{
    display:block;
  }

  /* âœ… ì™„ë£Œ í™”ë©´ì—ì„œ ì·¨ì†Œ ì„ íƒ ì²´í¬ UI */
  .cancel-pick-row{
    display:none;
    margin-top:10px;
    padding:10px;
    border:1px dashed #eee;
    border-radius:10px;
    background:#fff;
    font-size:13px;
  }
  body.mode-complete .cancel-pick-row{ display:flex; align-items:center; gap:8px; justify-content:flex-end; }
  .cancel-pick-row label{ margin:0; font-size:13px; font-weight:800; display:flex; align-items:center; gap:6px; }
  .cancel-pick-row input{ width:auto; padding:0; }
</style>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="mode-form">

<h1>ì‹¸U ì…€í”„ ì •ì‚° ì£¼ë¬¸ì„œ</h1>

<div class="mode-banner" id="modeBanner" tabindex="-1">ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>

<div class="section">
  <div class="section-title" id="customerTitle">ê³ ê° ì •ë³´</div>
  <div class="divider"></div>

  <!-- âœ… ì™„ë£Œ í™”ë©´ ë°°ì†¡ì§€ ìš”ì•½ -->
  <div id="shipSummary"></div>

  <!-- âœ… ì‘ì„±/ìˆ˜ì • í¼ -->
  <div id="customerFormFields">
    <div class="field">
      <label>ë‹‰ë„¤ì„</label>
      <input id="nickname" placeholder="ì˜ˆ) GOë¹„ìš˜ë“œ">
    </div>

    <div class="field">
      <label>ì´ë¦„</label>
      <input id="name" placeholder="ì˜ˆ) í™ê¸¸ë™">
    </div>

    <div class="field">
      <label>ì—°ë½ì²˜</label>
      <input id="phone" placeholder="ì˜ˆ) 010-1234-5678">
    </div>

    <div class="field">
      <label>ì£¼ì†Œ</label>
      <div class="address-row">
        <input id="address" placeholder="ì£¼ì†Œê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" readonly>
        <button class="addr-btn" type="button" onclick="searchAddress()">ì£¼ì†Œê²€ìƒ‰</button>
      </div>
    </div>

    <div class="field">
      <label>ìƒì„¸ì£¼ì†Œ</label>
      <input id="addressDetail" placeholder="ì˜ˆ) 101ë™ 1203í˜¸">
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title" id="productTitle">ìƒí’ˆ ì •ë³´</div>

  <!-- âœ… í¼ í™”ë©´ì—ì„œë§Œ: ì™„ë£Œ/ì·¨ì†Œ ìš”ì•½ -->
  <div id="doneSummary"></div>

  <div id="products"></div>

  <div class="product-controls">
    <!-- âœ… ì™„ë£Œ í™”ë©´ì—ì„œë§Œ: ì·¨ì†Œì™„ë£Œ ì ‘ê¸°/í¼ì¹˜ê¸° -->
    <button class="small-link-btn" type="button" onclick="toggleFold()">ì·¨ì†Œì™„ë£Œ ìˆ¨ê¸°ê¸° â–²</button>

    <!-- âœ… í¼ í™”ë©´ì—ì„œë§Œ: ìƒí’ˆì¶”ê°€/ì‚­ì œ -->
    <div class="button-line-2">
      <button class="btn-add" type="button" onclick="addProduct()">+ ìƒí’ˆ ì¶”ê°€</button>
      <button class="btn-delete" type="button" onclick="removeLastProduct()">- ìƒí’ˆ ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="section summary">
  <div class="summary-line"><span>ìƒí’ˆ í•©ê³„</span><span id="sum">0ì›</span></div>
  <div class="summary-line"><span>ë°°ì†¡ë¹„</span><span id="shipping">4,000ì›</span></div>
  <div class="summary-line summary-total"><span>ì´ ê²°ì œê¸ˆì•¡</span><span id="total">4,000ì›</span></div>
</div>

<div class="section">
  <div class="section-title">ì…ê¸ˆ ê³„ì¢Œ</div>
  <div class="account-box">
    <div class="account-text" id="accountText">ì¹´ì¹´ì˜¤ë±…í¬ 3333-09797-1111 ìœ í˜œì •(ìœ ì„¸ì—°)</div>
    <button class="copy-btn" type="button" onclick="copyAccount()">ë³µì‚¬</button>
  </div>
</div>

<!-- âœ… í¼ í™”ë©´ ë²„íŠ¼(ë¯¸ë¦¬ë³´ê¸°ëŠ” ì—¬ê¸°ë§Œ) -->
<div class="button-line-3" id="formControls">
  <button class="btn-new" type="button" onclick="newOrder()">ìƒˆ ì£¼ë¬¸</button>
  <button class="btn-check" id="btnPreview" type="button" onclick="checkOrder()">ë¯¸ë¦¬ ë³´ê¸°</button>
  <button class="btn-order" id="btnPrimary" type="button" onclick="submitOrder()">ì£¼ë¬¸í•˜ê¸°</button>
</div>

<!-- âœ… ì™„ë£Œ í™”ë©´ ë²„íŠ¼(ìƒˆ ì£¼ë¬¸ / ìˆ˜ì •í•˜ê¸° / ì·¨ì†Œì™„ë£Œ) -->
<div class="button-line-3" id="completeControls" style="display:none;">
  <button class="btn-new" type="button" onclick="newOrder()">ìƒˆ ì£¼ë¬¸</button>
  <button class="btn-edit-go" type="button" onclick="goToFormForEdit()">ìˆ˜ì •í•˜ê¸°</button>
  <button class="btn-cancel-complete" type="button" onclick="submitCancel()">ì·¨ì†Œì™„ë£Œ</button>
</div>

<!-- âœ… ì™„ë£Œ í™”ë©´ í•˜ë‹¨: ì£¼ë¬¸ í™•ì •ì„œ ë³´ê¸° -->
<div class="button-line-full" id="finalControls" style="display:none;">
  <button class="btn-final-view" type="button" onclick="checkFinalOrder()">ì£¼ë¬¸ í™•ì •ì„œ ë³´ê¸°</button>
</div>

<script>
  const SHIPPING = 4000;
  const productsDiv = document.getElementById("products");
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypKfZsjR0uu9Lcc7OirR2tiyjIzzLwREGd3Bw3szXmLVIHHNGhwlmoOdRaInh2xebf/exec";

  let IS_LOADING = false;

  /* âœ… ì·¨ì†Œì™„ë£Œ ìˆ¨ê¹€ í† ê¸€ (ì™„ë£Œ í™”ë©´ì—ì„œë§Œ ì˜ë¯¸) */
  let HIDE_CANCELED = false;

  /* âœ… ì£¼ë¬¸ID */
  let ORDER_ID = "";
  function newOrderId_(){
    return "oid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  /* âœ… ëª¨ë“œ: form(ì‘ì„±/ìˆ˜ì •) | complete(ì™„ë£Œ/ì·¨ì†Œ) */
  let MODE = "form";

  function focusBanner(){
    const banner = document.getElementById("modeBanner");
    if (!banner) return;
    banner.scrollIntoView({ behavior:"smooth", block:"start" });
    setTimeout(()=>banner.focus(), 250);
  }

  function setMode(mode, bannerText){
    MODE = mode;
    document.body.classList.remove("mode-form","mode-complete");
    document.body.classList.add("mode-" + MODE);

    const formControls = document.getElementById("formControls");
    const completeControls = document.getElementById("completeControls");
    const finalControls = document.getElementById("finalControls");
    const customerTitle = document.getElementById("customerTitle");
    const productTitle = document.getElementById("productTitle");

    if (MODE === "complete") {
      formControls.style.display = "none";
      completeControls.style.display = "flex";
      finalControls.style.display = "flex";
      customerTitle.innerText = "ë°°ì†¡ì§€ ì •ë³´";
      productTitle.innerText = "ì£¼ë¬¸ ì™„ë£Œ ìƒí’ˆ";

      const banner = document.getElementById("modeBanner");
      banner.innerText = bannerText || "ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
      renderShippingSummary();
      applyFoldVisibilityComplete();
      renderDoneSummary();
      updatePrimaryButtonLabel();
      saveData();
      setTimeout(focusBanner, 50);
      return;
    }

    // MODE === form
    formControls.style.display = "flex";
    completeControls.style.display = "none";
    finalControls.style.display = "none";
    customerTitle.innerText = "ê³ ê° ì •ë³´";
    productTitle.innerText = "ìƒí’ˆ ì •ë³´";

    renderDoneSummary();
    updatePrimaryButtonLabel();
    saveData();
  }

  function _uid(){
    return "p_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
  }

  function _amount_(qty, price){
    return Number(qty || 0) * Number(price || 0);
  }

  function copyAccount(){
    const text = accountText.innerText;
    const accountNumberOnly = text.replace(/[^0-9]/g, "");
    navigator.clipboard.writeText(accountNumberOnly);
    alert("ê³„ì¢Œë²ˆí˜¸ë§Œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function searchAddress(){
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById("address").value = data.address;
        document.getElementById("addressDetail").focus();
        saveData();
      }
    }).open();
  }

  function renderShippingSummary(){
    const box = document.getElementById("shipSummary");
    if (!box) return;

    const nickname = (document.getElementById("nickname").value || "").trim();
    const name = (document.getElementById("name").value || "").trim();
    const phone = (document.getElementById("phone").value || "").trim();
    const addr = (document.getElementById("address").value || "").trim();
    const addr2 = (document.getElementById("addressDetail").value || "").trim();
    const fullAddr = `${addr} ${addr2}`.trim();

    box.innerHTML = `
      <div style="font-weight:900; margin-bottom:6px;">ë°°ì†¡ì§€ ìš”ì•½</div>
      <div>ë‹‰ë„¤ì„: <b>${nickname || "-"}</b></div>
      <div>ìˆ˜ë ¹ì¸: <b>${name || "-"}</b></div>
      <div>ì—°ë½ì²˜: <b>${phone || "-"}</b></div>
      <div style="margin-top:6px;">ì£¼ì†Œ: <b>${fullAddr || "-"}</b></div>
    `;
  }

  /* âœ… ì™„ë£Œ/ì·¨ì†Œ(ì™„ë£Œ) ìƒí’ˆ ìš”ì•½(í¼ í™”ë©´ì—ì„œë§Œ ë³´ì—¬ì¤Œ) */
  function renderDoneSummary(){
    const box = document.getElementById("doneSummary");
    if (!box) return;

    const lines = [];
    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (!(st === "sent" || st === "canceled")) return;

      const i = p.querySelectorAll("input");
      const name = (i[0]?.value || "").trim();
      const color = (i[1]?.value || "").trim();
      const size = (i[2]?.value || "").trim();
      const qty = (i[3]?.value || "").trim();
      const price = (i[4]?.value || "").trim();

      if (st === "canceled") lines.push(`â€¢ [ì·¨ì†Œì™„ë£Œ] ${name} / ${color} / ${size}`);
      else lines.push(`â€¢ [ì£¼ë¬¸ì™„ë£Œ] ${name} / ${color} / ${size}`);
    });

    if (MODE !== "form" || lines.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }

    box.style.display = "block";
    box.innerHTML = lines.join("<br>");
  }

  /* âœ… ìƒíƒœë°°ì§€ (ì „ì†¡ëŒ€ê¸° ë¬¸êµ¬ ì œê±°) */
  function setBadge(div){
    const st = div.dataset.status || "draft";
    const badge = div.querySelector(".status-badge");
    if (!badge) return;

    badge.className = "status-badge";
    if (st === "canceled"){
      badge.classList.add("status-canceled");
      badge.innerHTML = `<span class="sq"></span>ì·¨ì†Œì™„ë£Œ`;
      return;
    }

    if (st === "cancel_pending"){
      badge.classList.add("status-cancel-pick");
      badge.innerHTML = `<span class="sq"></span>ì·¨ì†Œì„ íƒ`;
      return;
    }

    if (st === "sent"){
      badge.classList.add("status-sent");
      badge.innerHTML = `<span class="sq"></span>ì£¼ë¬¸ì™„ë£Œ`;
      return;
    }

    // draft(ì‘ì„±ì¤‘/ìˆ˜ì •ì¤‘)ì€ ë±ƒì§€ ìì²´ë¥¼ ê°ì¶”ì(ì „ì†¡ëŒ€ê¸° ë¬¸êµ¬ ë…¸ì¶œ ë°©ì§€)
    badge.style.display = "none";
  }

  function applyFoldVisibilityComplete(){
    if (MODE !== "complete") return;

    // ë²„íŠ¼ í…ìŠ¤íŠ¸
    const btn = document.querySelector('button[onclick="toggleFold()"]');
    if (btn) btn.innerText = HIDE_CANCELED ? "ì·¨ì†Œì™„ë£Œ ë³´ê¸° â–¼" : "ì·¨ì†Œì™„ë£Œ ìˆ¨ê¸°ê¸° â–²";

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (HIDE_CANCELED && st === "canceled") p.style.display = "none";
      else p.style.display = "";
    });
  }

  function toggleFold(){
    HIDE_CANCELED = !HIDE_CANCELED;
    applyFoldVisibilityComplete();
    saveData();
  }

  /* âœ… ì œí’ˆ ì¶”ê°€ */
  function addProduct(preset){
    const div = document.createElement("div");
    div.className = "product";

    div.dataset.id = (preset && preset.id) ? preset.id : _uid();
    div.dataset.status = (preset && preset.status) ? preset.status : "draft";
    if (preset && preset.snapshot) div.dataset.snapshot = preset.snapshot;

    div.innerHTML = `
      <div class="field">
        <label>ìƒí’ˆëª…</label>
        <div class="product-title-row">
          <input class="product-name" placeholder="ì˜ˆ) ì•„ë¯¸ ë§¨íˆ¬ë§¨ / í´ë¡œ ê½ˆë°°ê¸° ë‹ˆíŠ¸ / ë©”ì¢… í›„ë“œí‹° / ê¼¼ë° ê¸´íŒ”í‹° / ì•Œë¡œ ì…‹ì—…">
          <div class="status-badge status-sent"><span class="sq"></span>ì£¼ë¬¸ì™„ë£Œ</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ìƒ‰ìƒ</label>
          <input placeholder="ì˜ˆ) ë¸”ë™ / ê²€ì •">
        </div>
        <div class="field">
          <label>ì‚¬ì´ì¦ˆ</label>
          <input placeholder="ì˜ˆ) L / ë¼ì§€ / 100">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ìˆ˜ëŸ‰</label>
          <input type="number" value="" placeholder="ì˜ˆ) 1">
        </div>
        <div class="field">
          <label>ê°€ê²©</label>
          <input type="number" placeholder="ì˜ˆ) 59000">
        </div>
      </div>

      <!-- âœ… ì™„ë£Œ í™”ë©´ì—ì„œë§Œ: ì·¨ì†Œ ì„ íƒ -->
      <div class="cancel-pick-row">
        <label><input type="checkbox" class="chk-cancel-pick"> ì·¨ì†Œ ì„ íƒ</label>
      </div>
    `;

    const inputs = div.querySelectorAll("input");
    // inputs ìˆœì„œ: 0 ìƒí’ˆëª…,1 ìƒ‰ìƒ,2 ì‚¬ì´ì¦ˆ,3 ìˆ˜ëŸ‰,4 ê°€ê²©,5(ì™„ë£Œí™”ë©´ ì²´í¬ë°•ìŠ¤)
    if (preset){
      inputs[0].value = preset.name || "";
      inputs[1].value = preset.color || "";
      inputs[2].value = preset.size || "";
      inputs[3].value = preset.qty != null ? preset.qty : "";
      inputs[4].value = preset.price != null ? preset.price : "";
    }

    // âœ… ì…ë ¥ ì´ë²¤íŠ¸
    for (let k=0;k<5;k++){
      inputs[k].addEventListener("input", ()=>{
        // í¼ í™”ë©´ì—ì„œ "ì£¼ë¬¸ì™„ë£Œ(sent)" ìƒí’ˆì„ ê±´ë“œë¦¬ë©´ ìë™ìœ¼ë¡œ "ìˆ˜ì • ëŒ€ìƒ"ìœ¼ë¡œ ë§ˆí‚¹
        if (MODE === "form" && div.dataset.status === "sent") {
          if (!div.dataset.snapshot){
            const snap = snapshotOf(div);
            div.dataset.snapshot = JSON.stringify(snap);
          }
          div.dataset.status = "draft"; // ë‚´ë¶€ì ìœ¼ë¡œëŠ” draftë¡œ ë³´ë‚´ì„œ 'ìˆ˜ì • ì „ì†¡' ëŒ€ìƒìœ¼ë¡œ í¬í•¨
          div.dataset.action = "modify"; // ìˆ˜ì • ì „ì†¡
          // ì „ì†¡ëŒ€ê¸° ë¬¸êµ¬ëŠ” ë…¸ì¶œí•˜ì§€ ì•ŠìŒ(ë±ƒì§€ ìˆ¨ê¹€)
        }
        calc();
        saveData();
      });
    }

    // âœ… ì™„ë£Œ í™”ë©´ ì·¨ì†Œ ì²´í¬
    const chk = div.querySelector(".chk-cancel-pick");
    if (chk){
      chk.addEventListener("change", ()=>{
        if (MODE !== "complete") return;

        const st = div.dataset.status || "draft";
        if (chk.checked){
          if (st !== "sent") return;
          if (!div.dataset.snapshot){
            div.dataset.snapshot = JSON.stringify(snapshotOf(div));
          }
          div.dataset.status = "cancel_pending";
        } else {
          if (st !== "cancel_pending") return;
          div.dataset.status = "sent";
          delete div.dataset.snapshot;
        }
        setBadge(div);
        calc();
        saveData();
        applyFoldVisibilityComplete();
      });
    }

    productsDiv.appendChild(div);
    setBadge(div);

    calc();
    renderDoneSummary();
    if (!IS_LOADING) saveData();
    return div;
  }

  function snapshotOf(div){
    const i = div.querySelectorAll("input");
    return {
      name: i[0]?.value || "",
      color: i[1]?.value || "",
      size: i[2]?.value || "",
      qty: i[3]?.value || "",
      price: i[4]?.value || ""
    };
  }

  function removeLastProduct(){
    if (MODE !== "form") return;

    const items = Array.from(document.querySelectorAll(".product"));
    // draftë§Œ ì‚­ì œ(ì‘ì„±ì¤‘)
    for (let idx = items.length - 1; idx >= 0; idx--){
      const st = items[idx].dataset.status || "draft";
      const action = (items[idx].dataset.action || "").trim();
      if (st === "draft" && action !== "modify"){ // ìƒˆ ìƒí’ˆë§Œ ì‚­ì œ
        items[idx].remove();
        break;
      }
    }
    if (!document.querySelector(".product")) addProduct();
    calc();
    saveData();
    renderDoneSummary();
  }

  function calc(){
    let sum = 0;

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      const action = (p.dataset.action || "").trim();

      const i = p.querySelectorAll("input");
      const curQty = Number((i[3]?.value || "").trim() || 0);
      const curPrice = Number((i[4]?.value || "").trim() || 0);
      const curAmt = curQty * curPrice;

      // ì™„ë£Œ í™”ë©´ ì·¨ì†Œ ì„ íƒì€ í•©ê³„ì—ì„œ ë¹ ì§€ê²Œ
      if (MODE === "complete"){
        if (st === "sent") sum += curAmt;
        if (st === "cancel_pending"){
          const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : null;
          const q = snap ? Number(snap.qty || 0) : curQty;
          const pr = snap ? Number(snap.price || 0) : curPrice;
          sum -= (q*pr);
        }
        return;
      }

      // í¼ í™”ë©´: ìƒˆ ìƒí’ˆì€ í•©ê³„ í¬í•¨
      if (st === "draft" && action !== "modify"){
        sum += curAmt;
        return;
      }

      // í¼ í™”ë©´: ìˆ˜ì •ì€ ì°¨ì•¡ë§Œ ë°˜ì˜
      if (st === "draft" && action === "modify"){
        const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : null;
        const snapAmt = snap ? _amount_(snap.qty, snap.price) : 0;
        sum += (curAmt - snapAmt);
        return;
      }
    });

    const shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;
    document.getElementById("sum").innerText = sum.toLocaleString() + "ì›";
    document.getElementById("shipping").innerText = shipping.toLocaleString() + "ì›";
    document.getElementById("total").innerText = (sum + shipping).toLocaleString() + "ì›";

    if (MODE === "complete") applyFoldVisibilityComplete();
  }

  function updatePrimaryButtonLabel(){
    const btn = document.getElementById("btnPrimary");
    if (!btn) return;

    // ì£¼ë¬¸ì™„ë£Œ ìƒí’ˆì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ "ìˆ˜ì •ì™„ë£Œ"ë¡œ í‘œê¸°(ìˆ˜ì • í™”ë©´ ì—­í• )
    const hasSent = Array.from(document.querySelectorAll(".product")).some(p => (p.dataset.status === "sent"));
    btn.innerText = hasSent ? "ìˆ˜ì •ì™„ë£Œ" : "ì£¼ë¬¸í•˜ê¸°";
  }

  function _validateCustomer_(){
    const nickname = document.getElementById("nickname");
    const name = document.getElementById("name");
    const phone = document.getElementById("phone");
    const address = document.getElementById("address");
    const addressDetail = document.getElementById("addressDetail");

    if (!nickname.value.trim()) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); nickname.focus(); return false; }
    if (!name.value.trim()) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); name.focus(); return false; }
    if (!phone.value.trim()) { alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); phone.focus(); return false; }
    if (!address.value.trim()) { alert("ì£¼ì†Œê²€ìƒ‰ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return false; }
    if (!addressDetail.value.trim()) { alert("ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); addressDetail.focus(); return false; }
    return true;
  }

  function checkOrder(){
    let text = "[ê³ ê° ì •ë³´]\n";
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[ìƒí’ˆ ì •ë³´]\n";
    const targets = [];

    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      const action = (p.dataset.action || "").trim();
      if (MODE === "form"){
        // í¼ í™”ë©´ ë¯¸ë¦¬ë³´ê¸°: ìƒˆ ìƒí’ˆ + ìˆ˜ì • ìƒí’ˆë§Œ
        if (st === "draft") targets.push(p);
      } else {
        // ì™„ë£Œ í™”ë©´ì—ì„œëŠ” ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ì´ ì—†ì§€ë§Œ í˜¹ì‹œ í˜¸ì¶œë˜ë©´ ì£¼ë¬¸ì™„ë£Œ ê¸°ì¤€
        if (st === "sent" || st === "canceled") targets.push(p);
      }
    });

    if (targets.length === 0){
      text += "(í‘œì‹œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      targets.forEach((p, idx)=>{
        const i = p.querySelectorAll("input");
        const st = p.dataset.status || "draft";
        const action = (p.dataset.action || "").trim();
        const prefix = (MODE==="form" && action==="modify") ? "[ìˆ˜ì •] " : "";
        text += `${idx+1}. ${prefix}${i[0].value} / ${i[1].value} / ${i[2].value} / ${i[3].value}ê°œ / ${i[4].value}ì›\n`;
      });
    }

    text += `\nìƒí’ˆí•©ê³„: ${document.getElementById("sum").innerText}\n`;
    text += `ë°°ì†¡ë¹„: ${document.getElementById("shipping").innerText}\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${document.getElementById("total").innerText}\n`;

    alert(text);
  }

  function checkFinalOrder(){
    let text = "[ë°°ì†¡ì§€ ì •ë³´]\n";
    text += `ë‹‰ë„¤ì„: ${document.getElementById("nickname").value}\n`;
    text += `ì´ë¦„: ${document.getElementById("name").value}\n`;
    text += `ì—°ë½ì²˜: ${document.getElementById("phone").value}\n`;
    text += `ì£¼ì†Œ: ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}\n\n`;

    text += "[ìƒí’ˆ ì •ë³´]\n";

    let sum = 0;
    const items = Array.from(document.querySelectorAll(".product")).filter(p=>{
      const st = p.dataset.status || "draft";
      return (st === "sent" || st === "canceled");
    });

    if (items.length === 0){
      text += "(ì£¼ë¬¸ì™„ë£Œ/ì·¨ì†Œì™„ë£Œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.)\n";
    } else {
      items.forEach((p, idx)=>{
        const st = p.dataset.status;
        const i = p.querySelectorAll("input");
        const qty = Number(i[3].value || 0);
        const price = Number(i[4].value || 0);

        if (st === "sent"){
          sum += qty * price;
          text += `${idx+1}. ${i[0].value} / ${i[1].value} / ${i[2].value} / ${qty}ê°œ / ${price}ì›\n`;
        } else {
          text += `${idx+1}. [ì·¨ì†Œì™„ë£Œ] ${i[0].value} / ${i[1].value} / ${i[2].value}\n`;
        }
      });
    }

    const shipping = (sum > 0 && sum < 100000) ? SHIPPING : 0;
    text += `\nìƒí’ˆí•©ê³„: ${sum.toLocaleString()}ì›\n`;
    text += `ë°°ì†¡ë¹„: ${shipping.toLocaleString()}ì›\n`;
    text += `ì´ ê²°ì œê¸ˆì•¡: ${(sum + shipping).toLocaleString()}ì›\n`;

    alert(text);
  }

  async function submitOrder(){
    if (MODE !== "form") return;
    if (!_validateCustomer_()) return;

    // ì „ì†¡ ëŒ€ìƒ: ìƒˆ ìƒí’ˆ(draft, action ì—†ìŒ) + ìˆ˜ì • ìƒí’ˆ(draft, action=modify)
    const targets = [];
    document.querySelectorAll(".product").forEach(p=>{
      const st = p.dataset.status || "draft";
      if (st !== "draft") return;
      targets.push(p);
    });

    if (targets.length === 0){
      alert("ì „ì†¡í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const hasSent = Array.from(document.querySelectorAll(".product")).some(p => p.dataset.status === "sent");
    const confirmText = hasSent ? "ìˆ˜ì •ì„ ì™„ë£Œí•˜ê³  ì „ì†¡í• ê¹Œìš”?" : "ì£¼ë¬¸ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
    if (!confirm(confirmText)) return;

    saveData();

    const kstNowString = () => {
      const d = new Date(Date.now() + 9 * 60 * 60 * 1000);
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(d.getUTCDate()).padStart(2, "0");
      const hh = String(d.getUTCHours()).padStart(2, "0");
      const mi = String(d.getUTCMinutes()).padStart(2, "0");
      const ss = String(d.getUTCSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    };

    const items = [];
    let deltaSum = 0;
    let hasNewItem = false;

    targets.forEach(p=>{
      const i = p.querySelectorAll("input");
      const cur = {
        name: (i[0].value || "").trim(),
        color: (i[1].value || "").trim(),
        size: (i[2].value || "").trim(),
        qty: Number(i[3].value || 0),
        price: Number(i[4].value || 0)
      };

      if (!cur.name || !cur.color || !cur.size || cur.qty <= 0 || cur.price <= 0){
        // ìµœì†Œ ê²€ì¦
        throw new Error("invalid");
      }

      const action = (p.dataset.action || "").trim();

      if (action === "modify"){
        const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : { qty:0, price:0 };
        const oldAmt = _amount_(snap.qty, snap.price);
        const newAmt = _amount_(cur.qty, cur.price);
        const delta = newAmt - oldAmt;

        items.push({
          productName: `[ìˆ˜ì •] ${cur.name}`.trim(),
          color: cur.color,
          size: cur.size,
          qty: cur.qty,
          price: cur.price,
          amountDelta: delta
        });

        deltaSum += delta;
      } else {
        items.push({
          productName: cur.name,
          color: cur.color,
          size: cur.size,
          qty: cur.qty,
          price: cur.price
        });

        deltaSum += _amount_(cur.qty, cur.price);
        hasNewItem = true;
      }
    });

    // ë°°ì†¡ë¹„ ê·œì¹™: ìƒˆ ìƒí’ˆì´ í¬í•¨ë  ë•Œë§Œ ì ìš©
    let shipping = 0;
    if (hasNewItem){
      shipping = (deltaSum > 0 && deltaSum < 100000) ? SHIPPING : 0;
    }

    const payload = {
      orderId: ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum: deltaSum,
      shipping,
      total: deltaSum + shipping
    };

    try{
      const body = JSON.stringify(payload);
      let sent = false;

      if (navigator.sendBeacon){
        const blob = new Blob([body], { type:"text/plain;charset=UTF-8" });
        sent = navigator.sendBeacon(SCRIPT_URL, blob);
      }

      if (!sent){
        await fetch(SCRIPT_URL, {
          method:"POST",
          mode:"no-cors",
          headers:{ "Content-Type":"text/plain;charset=UTF-8" },
          body,
          keepalive:true
        });
      }

      // âœ… ì „ì†¡ ì„±ê³µ: draft â†’ sent ë¡œ í™•ì •
      targets.forEach(p=>{
        p.dataset.status = "sent";
        delete p.dataset.action;
        delete p.dataset.snapshot;
        setBadge(p);
      });

      calc();
      renderDoneSummary();
      updatePrimaryButtonLabel();
      saveData();

      setMode("complete", "ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e){
      alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  async function submitCancel(){
    if (MODE !== "complete") return;

    // ì·¨ì†Œ ëŒ€ìƒ: cancel_pending
    const targets = Array.from(document.querySelectorAll(".product")).filter(p => p.dataset.status === "cancel_pending");
    if (targets.length === 0){
      alert("ì·¨ì†Œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      focusBanner();
      return;
    }
    if (!confirm("ì„ íƒí•œ ìƒí’ˆì„ ì·¨ì†Œí•˜ê³  ì „ì†¡í• ê¹Œìš”?")) return;

    const kstNowString = () => {
      const d = new Date(Date.now() + 9 * 60 * 60 * 1000);
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(d.getUTCDate()).padStart(2, "0");
      const hh = String(d.getUTCHours()).padStart(2, "0");
      const mi = String(d.getUTCMinutes()).padStart(2, "0");
      const ss = String(d.getUTCSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    };

    const items = [];
    let deltaSum = 0;

    targets.forEach(p=>{
      const i = p.querySelectorAll("input");
      const curName = (i[0].value || "").trim();
      const curColor = (i[1].value || "").trim();
      const curSize = (i[2].value || "").trim();

      const snap = p.dataset.snapshot ? JSON.parse(p.dataset.snapshot) : snapshotOf(p);
      const oldAmt = _amount_(snap.qty, snap.price);
      const delta = -oldAmt;

      items.push({
        productName: `[ì·¨ì†Œ] ${curName}`.trim(),
        color: curColor,
        size: curSize,
        qty: 0,
        price: 0,
        amountDelta: delta
      });

      deltaSum += delta;
    });

    const payload = {
      orderId: ORDER_ID || newOrderId_(),
      orderTime: kstNowString(),
      customer: {
        nickname: document.getElementById("nickname").value || "",
        name: document.getElementById("name").value || "",
        phone: document.getElementById("phone").value || "",
        address: `${document.getElementById("address").value || ""} ${document.getElementById("addressDetail").value || ""}`.trim()
      },
      items,
      sum: deltaSum,
      shipping: 0,
      total: deltaSum
    };

    try{
      const body = JSON.stringify(payload);
      let sent = false;

      if (navigator.sendBeacon){
        const blob = new Blob([body], { type:"text/plain;charset=UTF-8" });
        sent = navigator.sendBeacon(SCRIPT_URL, blob);
      }

      if (!sent){
        await fetch(SCRIPT_URL, {
          method:"POST",
          mode:"no-cors",
          headers:{ "Content-Type":"text/plain;charset=UTF-8" },
          body,
          keepalive:true
        });
      }

      // âœ… ì·¨ì†Œ í™•ì •: cancel_pending â†’ canceled
      targets.forEach(p=>{
        p.dataset.status = "canceled";
        delete p.dataset.snapshot;
        const chk = p.querySelector(".chk-cancel-pick");
        if (chk) chk.checked = false;
        setBadge(p);
      });

      calc();
      renderDoneSummary();
      saveData();

      setMode("complete", "ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      alert("ì·¨ì†Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e){
      alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  function goToFormForEdit(){
    // ì™„ë£Œ í™”ë©´ â†’ í¼ í™”ë©´(ìˆ˜ì •)
    // ì·¨ì†Œ ì„ íƒì¤‘(cancel_pending)ì´ ìˆìœ¼ë©´ ë˜ëŒë¦¼
    document.querySelectorAll(".product").forEach(p=>{
      if (p.dataset.status === "cancel_pending"){
        p.dataset.status = "sent";
        delete p.dataset.snapshot;
        const chk = p.querySelector(".chk-cancel-pick");
        if (chk) chk.checked = false;
        setBadge(p);
      }
    });

    // í¼ í™”ë©´ì—ì„œëŠ” sent/canceledê°€ ìš”ì•½ìœ¼ë¡œë§Œ ë³´ì´ê¸° ë•Œë¬¸ì—,
    // ì‚¬ìš©ìê°€ "ê¸°ì¡´ ì£¼ë¬¸ ìƒí’ˆì„ ìˆ˜ì •"í•˜ë ¤ë©´: í•´ë‹¹ ìƒí’ˆì„ ë¨¼ì € í¸ì§‘ ëŒ€ìƒìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•¨.
    // ğŸ‘‰ ë°©ë²•: ì™„ë£Œ í™”ë©´ì—ì„œ ìˆ˜ì •í•˜ê¸° ëˆ„ë¥´ê³  í¼ìœ¼ë¡œ ì˜¤ë©´,
    // ì‚¬ìš©ìê°€ ìˆ˜ì •í•  ìƒí’ˆì€ "ìƒˆë¡œ ì¶”ê°€"í•˜ê±°ë‚˜,
    // ë˜ëŠ” ê¸°ì¡´ ì£¼ë¬¸ ìƒí’ˆì„ ìˆ˜ì •í•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼ 'í¸ì§‘ìš© ë³µì œ'ë¥¼ ìë™ ìƒì„±í•´ì¤„ ìˆ˜ë„ ìˆìŒ.
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ: ê¸°ì¡´ ì£¼ë¬¸ ìƒí’ˆì„ ìˆ˜ì •í•˜ê³  ì‹¶ìœ¼ë©´ "ë³µì œí•´ì„œ ìˆ˜ì •" ë°©ì‹ìœ¼ë¡œ ìë™ ìƒì„±.
    const sentItems = Array.from(document.querySelectorAll(".product")).filter(p => p.dataset.status === "sent");
    sentItems.forEach(p=>{
      const snap = snapshotOf(p);
      // ë™ì¼ ìƒí’ˆ í¸ì§‘ìš© ë³µì œ(ìˆ˜ì • ì „ì†¡ìœ¼ë¡œ ì²˜ë¦¬)
      const clonePreset = {
        id: _uid(),
        status: "draft",
        snapshot: JSON.stringify(snap),
        name: snap.name,
        color: snap.color,
        size: snap.size,
        qty: snap.qty,
        price: snap.price
      };
      const newDiv = addProduct(clonePreset);
      newDiv.dataset.action = "modify";
    });

    calc();
    renderDoneSummary();
    updatePrimaryButtonLabel();
    setMode("form");
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  function newOrder(){
    if (!confirm("ìƒˆë¡œ ì£¼ë¬¸ì„ ì‹œì‘í• ê¹Œìš”?")) return;

    // ë°ì´í„° ì´ˆê¸°í™”(ê³ ê°ì •ë³´ëŠ” ìœ ì§€)
    const data = JSON.parse(localStorage.getItem("orderData") || "{}");

    data.customer = data.customer || {
      nickname: document.getElementById("nickname").value,
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value,
      address: document.getElementById("address").value,
      addressDetail: document.getElementById("addressDetail").value
    };

    ORDER_ID = newOrderId_();
    data.orderId = ORDER_ID;
    data.mode = "form";
    data.products = [];
    data.hideCanceled = false;

    localStorage.setItem("orderData", JSON.stringify(data));

    document.querySelectorAll(".product").forEach(p => p.remove());

    HIDE_CANCELED = false;
    addProduct();
    calc();
    renderDoneSummary();
    updatePrimaryButtonLabel();

    setMode("form");
    saveData();
  }

  function saveData(){
    const data = {
      orderId: ORDER_ID,
      mode: MODE,
      hideCanceled: HIDE_CANCELED,
      customer: {
        nickname: document.getElementById("nickname").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        addressDetail: document.getElementById("addressDetail").value
      },
      products: []
    };

    document.querySelectorAll(".product").forEach(p=>{
      const i = p.querySelectorAll("input");
      data.products.push({
        id: p.dataset.id || _uid(),
        status: p.dataset.status || "draft",
        action: p.dataset.action || "",
        snapshot: p.dataset.snapshot || "",
        name: i[0]?.value || "",
        color: i[1]?.value || "",
        size: i[2]?.value || "",
        qty: i[3]?.value || "",
        price: i[4]?.value || ""
      });
    });

    localStorage.setItem("orderData", JSON.stringify(data));
  }

  function loadData(){
    const data = JSON.parse(localStorage.getItem("orderData") || "null");
    if (!data){
      ORDER_ID = newOrderId_();
      saveData();
      setMode("form");
      return;
    }

    IS_LOADING = true;

    ORDER_ID = data.orderId || newOrderId_();
    HIDE_CANCELED = !!data.hideCanceled;

    document.getElementById("nickname").value = data.customer?.nickname || "";
    document.getElementById("name").value = data.customer?.name || "";
    document.getElementById("phone").value = data.customer?.phone || "";
    document.getElementById("address").value = data.customer?.address || "";
    document.getElementById("addressDetail").value = data.customer?.addressDetail || "";

    productsDiv.innerHTML = "";
    (data.products || []).forEach(p=>{
      const preset = {
        id: p.id,
        status: p.status,
        snapshot: p.snapshot,
        name: p.name,
        color: p.color,
        size: p.size,
        qty: p.qty,
        price: p.price
      };
      const div = addProduct(preset);
      if (p.action) div.dataset.action = p.action;
      setBadge(div);

      // ì™„ë£Œ í™”ë©´ ì²´í¬ë°•ìŠ¤ ë°˜ì˜
      const chk = div.querySelector(".chk-cancel-pick");
      if (chk) chk.checked = (div.dataset.status === "cancel_pending");
    });

    if (!document.querySelector(".product")) addProduct();

    calc();
    renderShippingSummary();
    renderDoneSummary();
    updatePrimaryButtonLabel();

    IS_LOADING = false;

    const m = data.mode || "form";
    if (m === "complete") {
      setMode("complete", "ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      setMode("form");
    }

    saveData();
  }

  ["nickname","name","phone","addressDetail"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      renderShippingSummary();
      saveData();
    });
  });

  loadData();
</script>

</body>
</html>